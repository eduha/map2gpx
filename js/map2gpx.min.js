"use strict";function storageAvailable(e){var t;try{var a="__storage_test__";return(t=window[e]).setItem(a,a),t.removeItem(a),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==t.length}}Math.roundE8=function(e){return Math.round(e*Math.pow(10,8))/Math.pow(10,8)},Math.radians=function(e){return e*Math.PI/180},Math.degrees=function(e){return 180*e/Math.PI},jQuery.QueryString=function(e){for(var t={},a=0;a<e.length;++a){var n=e[a].split("=",2);2===n.length&&(t[n[0]]=decodeURIComponent(n[1].replace(/\+/g," ")))}return t}(window.location.search.substr(1).split("&")),function(e){var t=[];e.Shepherd={},e.Shepherd.Step=function(){var t,a;return{init:function(n,o){return t=n,a=e.extend({},o,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"}),this}}},e.Shepherd.step=function(t,a){return e.Shepherd.Step().init(t,a)},e.Shepherd.Tour=function(){var a,n=0;return{init:function(t){var n=e.extend({},t,{defaults:{classes:"shepherd-element shepherd-open shepherd-theme-arrows",showCancelLink:!0}});return a=new Shepherd.Tour(n),this},add:function(o,r){var i=this,l=n,s=e.extend({},r,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"});return s.buttons=[{text:"Fermer",classes:"shepherd-button-secondary",action:function(){hasLocalStorage&&localStorage.setItem("tutorial"+t.indexOf(i),-1),i.cancel()}},{text:"Suivant",classes:"shepherd-button-example-primary",action:function(){var e=t.indexOf(i);e<0&&console.log("Could not find current shepherd, something is probably wrong"),hasLocalStorage&&localStorage.setItem("tutorial"+e,l+1),i.next(),l==n-1&&e>=0&&e<t.length-1&&t[e+1].start(!0)}}],a.addStep(o,s),n++,this},start:function(){var e=0;if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])){var o=t.indexOf(this);hasLocalStorage&&null!==localStorage.getItem("tutorial"+o)&&(e=parseInt(localStorage.getItem("tutorial"+o)))}return e>=0&&e<n&&a.show(e),this},cancel:function(){return a.cancel(),this},next:function(){return a.next(),this}}},e.Shepherd.tour=function(a){var n=e.Shepherd.Tour().init(a);return t.push(n),n},e.Shepherd.get=function(e){return t[e]},e.Shepherd.has=function(e){return t.length>e}}(jQuery),function(e){var t=null,a=!1;e.State={},e.State.setMode=function(n){t=n,e("body").trigger(e.Event("map2gpx:modechange",{mode:t,computing:a}))},e.State.setComputing=function(n){a=n,e("body").trigger(e.Event("map2gpx:computingchange",{mode:t,computing:a}))},e.State.triggerMarkersChanged=function(){e("body").trigger(e.Event("map2gpx:markerschange",{mode:t,computing:a}))},e.State.getMode=function(){return t},e.State.getComputing=function(){return a}}(jQuery),function(e){var t=[],a=[],n={},o={};e.Cache={};var r=function(e){return e.lng+"/"+e.lat};e.Cache.addAltitude=function(e,t,a){n[t+"/"+e]=a},e.Cache.getAltitude=function(e){var t=r(e);return t in n?n[t]:null},e.Cache.hasAltitude=function(e){return r(e)in n},e.Cache.addSlope=function(e,t,a){o[t+"/"+e]=a},e.Cache.getSlope=function(e){var t=r(e);return t in o?o[t]:null},e.Cache.hasSlope=function(e){return r(e)in o},e.Cache.getInfos=function(e){var t=r(e);return{z:t in n?n[t]:null,slope:t in o?o[t]:null}},e.Cache.lengthOfMarkers=function(){return t.length},e.Cache.hasMarkers=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return t.length>=e},e.Cache.getMarker=function(e){var a=e>=0?e:t.length+e;return t[a]},e.Cache.indexOfMarker=function(e){return t.indexOf(e)},e.Cache.eachMarker=function(a){e.each(t,function(e,t){return a(e,t)})},e.Cache.addMarker=function(e){t.push(e)},e.Cache.removeMarkerAt=function(e){var a=e>=0?e:t.length+e;t.splice(a,1)},e.Cache.resetMarkers=function(){t.length=0},e.Cache.lengthOfRoutes=function(){return a.length},e.Cache.hasRoutes=function(e){var t=void 0!==e?e:1;return a.length>=t},e.Cache.getRoute=function(e){var n=e>=0?e:t.length+e;return a[n][0]},e.Cache.getRouteMode=function(e){var n=e>=0?e:t.length+e;return a[n][1]},e.Cache.eachRoute=function(t){e.each(a,function(e,a){return t(e,a[0])})},e.Cache.addRoute=function(e,t){a.push([e,t])},e.Cache.setRouteAt=function(e,n,o){var r=e>=0?e:t.length+e;a[r]=[n,o]},e.Cache.removeRouteAt=function(e){var n=e>=0?e:t.length+e;a.splice(n,1)},e.Cache.resetRoutes=function(){a.length=0}}(jQuery);var isSmallScreen=window.innerWidth<=800&&window.innerHeight<=600,hasLocalStorage=storageAvailable("localStorage");window.onload=function(){$.Deferred(function(){var e=this,t=[44.96777356135154,6.06822967529297,13];if(hasLocalStorage&&null!==localStorage.getItem("view")&&(t=JSON.parse(localStorage.getItem("view"))),"lat"in $.QueryString&&"lng"in $.QueryString&&(t=[$.QueryString.lat,$.QueryString.lng,15]),"loc"in $.QueryString){var a={text:$.QueryString.loc,filterOptions:{type:["StreetAddress","PositionOfInterest"]},apiKey:keyIgn,onSuccess:function(a){a&&"suggestedLocations"in a&&a.suggestedLocations.length>0?e.resolveWith([a.suggestedLocations[0].position.y,a.suggestedLocations[0].position.x,15]):(console.log("No results?"),e.resolveWith(t))},onFailure:function(a){console.log(a),e.resolveWith(t)}};Gp.Services.autoComplete(a)}else e.resolveWith(t)}).done(function(){function e(){return g=(g+1)%d.length}function t(e,t,a){return $.Deferred(function(){for(var n=this,o=function(e){console.log(e),$.Cache.setRouteAt(a,null,"invalid"),n.reject()},r=e.getLatLng().roundE8(),i=t.getLatLng().roundE8(),l=r.distanceTo(i),s=r.bearingTo(i),c=[r],u=10;u<l;u+=10)c.push(r.getDestinationAlong(s,u));c.push(i);var d=L.polyline(c,{color:e.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3});d.computeStats().then(function(){$.Cache.setRouteAt(a,d,"straight"),d.addTo(h),d.bindPopup("Calculs en cours..."),d.snakeIn(),e.setOpacity(1),t.setOpacity(1),n.resolve()}).fail(function(){o("Impossible d'obtenir les données de la route")})})}function a(e,a,n){return $.Deferred(function(){var o=this,r=function(r){console.log(r),console.log("Trying straight line..."),t(e,a,n).done(function(){o.resolve()}).fail(function(){o.reject()})},i=e.getLatLng(),l=a.getLatLng(),s={distanceUnit:"m",endPoint:{x:l.lng,y:l.lat},exclusions:[],geometryInInstructions:!0,graph:"Pieton",routePreferences:"fastest",startPoint:{x:i.lng,y:i.lat},viaPoints:[],apiKey:keyIgn,onSuccess:function(t){if(t){var i=L.geoJSON([],{color:e.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3}),l={type:"FeatureCollection",features:[]},s=1;$.each(t.routeInstructions,function(e,t){s++,l.features.push({id:s,type:"Feature",geometry:t.geometry})}),i.addData(l);i.computeStats().then(function(){$.Cache.setRouteAt(n,i,"auto"),i.addTo(h),i.bindPopup("Calculs en cours..."),i.snakeIn(),e.setOpacity(1),a.setOpacity(1),o.resolve()}).fail(function(){r("Impossible d'obtenir les données de la route")})}else r("Impossible d'obtenir la route")},onFailure:function(e){r("Impossible d'obtenir la route: "+e.message)}};Gp.Services.route(s)})}function n(n){if(null!==$.State.getMode()&&!$.State.getComputing()){$.State.setComputing(!0);var o=[],r=L.latLng(Math.roundE8(n.latlng.lat),Math.roundE8(n.latlng.lng)),i=L.marker(r,{riseOnHover:!0,draggable:!0,opacity:.5}).bindPopup('<button class="marker-promote-button"><i class="fa fa-asterisk" aria-hidden="true"></i> Marquer comme étape</button> <button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>');if(i.on("popupopen",function(){var t=this;$(".marker-delete-button:visible").click(function(){h.removeLayer(t)}),$(".marker-promote-button:visible").click(function(){$.State.setComputing(!0),t.setPopupContent('<button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>'),t.setColorIndex(e()),t.setType("step");var a=t.getColorRgb(),n=$.Cache.indexOfMarker(t);if(n>-1)for(var o=$.Cache.lengthOfMarkers(),r=n+1;r<o;r++){r>0&&$.Cache.getRoute(r-1).setStyle({color:a});var i=$.Cache.getMarker(r);if("step"==i.getType())break;i.setColorIndex(g),i.setType(i.getType())}$.State.triggerMarkersChanged(),$.State.setComputing(!1)})}),$.Cache.hasMarkers()?i.setColorIndex($.Cache.getMarker(-1).getColorIndex()):i.setColorIndex(g),i.setType("waypoint"),$.Cache.addMarker(i),i.addTo(h),$.Cache.hasMarkers(2)){isSmallScreen||$.Shepherd.has(1)||$.Shepherd.tour().add("data",{text:$("#help-data")[0],attachTo:{element:$("#data")[0],on:"top"}}).add("closeloop",{text:$("#help-closeloop")[0],attachTo:{element:$("#btn-closeloop")[0],on:"right"}}).add("export",{text:$("#help-export")[0],attachTo:{element:$("#btn-export")[0],on:"right"}}).start(),$.Cache.hasMarkers(3)&&(isSmallScreen||$.Shepherd.has(2)||$.Shepherd.tour().add("movemarker",{text:$("#help-movemarker")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).add("movemarker2",{text:$("#help-movemarker2")[0],attachTo:{element:$(".awesome-marker").eq(-2)[0],on:"bottom"}}).add("steps",{text:$("#help-steps")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).start());var l=$.Cache.lengthOfMarkers()-1,s=$.Cache.getMarker(l-1),c=$.Cache.getMarker(l);$.Cache.lengthOfRoutes()!=l-1&&console.log("Something wrong"),o.push("auto"==$.State.getMode()?a(s,c,l-1):t(s,c,l-1))}i.on("moveend",function(e){$.State.setComputing(!0),e.target.setOpacity(.5);var n=[],o=$.Cache.indexOfMarker(e.target);if(o>-1&&$.Cache.hasRoutes()){if(o<$.Cache.lengthOfMarkers()-1){var r=$.Cache.getRoute(o);null!=r&&h.removeLayer(r);var i=$.Cache.getMarker(o),l=$.Cache.getMarker(o+1),s=$.State.getMode()||$.Cache.getRouteMode(o)||"auto";n.push("auto"==s?a(i,l,o):t(i,l,o))}if(o>0){var c=$.Cache.getRoute(o-1);null!=c&&h.removeLayer(c);var u=$.Cache.getMarker(o-1),d=$.Cache.getMarker(o),g=$.State.getMode()||$.Cache.getRouteMode(o-1)||"auto";n.push("auto"==g?a(u,d,o-1):t(u,d,o-1))}}$.when.apply($,n).done(function(){$.State.setComputing(!1),e.target.setOpacity(1)}).fail(function(){$.State.setComputing(!1)})}),i.on("remove",function(e){if(!$.State.getComputing()){$.State.setComputing(!0);var n=[],o=$.Cache.indexOfMarker(e.target);if(o>-1){var r=$.Cache.lengthOfMarkers();if("step"==e.target.getType()&&o>0)for(var i=o+1;i<r;i++){i>0&&$.Cache.getRoute(i-1).setStyle({color:$.Cache.getMarker(o-1).getColorRgb()});var l=$.Cache.getMarker(i);if("step"==l.getType())break;l.setColorIndex($.Cache.getMarker(o-1).getColorIndex()),l.setType(l.getType())}if(0==o){if($.Cache.hasRoutes()){var s=$.Cache.getRoute(0);null!=s&&h.removeLayer(s),$.Cache.removeRouteAt(0)}}else if(o==r-1){var c=$.Cache.getRoute(o-1);null!=c&&h.removeLayer(c),$.Cache.removeRouteAt(o-1)}else{var u=$.Cache.getRoute(o-1),d=$.Cache.getRouteMode(o-1),g=$.Cache.getRoute(o);null!=u&&h.removeLayer(u),null!=g&&h.removeLayer(g),$.Cache.removeRouteAt(o);var p=$.Cache.getMarker(o-1),m=$.Cache.getMarker(o+1),f=$.State.getMode()||d||"auto";n.push("auto"==f?a(p,m,o-1):t(p,m,o-1))}$.Cache.removeMarkerAt(o)}$.when.apply($,n).done(function(){$.State.setComputing(!1)}).fail(function(){$.State.setComputing(!1)})}}),$.when.apply($,o).done(function(){i.setOpacity(1),$.State.setComputing(!1)}).fail(function(){$.State.setComputing(!1)})}}function o(e){return $.Deferred(function(){var t=this,a={apiKey:keyIgn,sampling:e.length,positions:e,onSuccess:function(e){e?($.each(e.elevations,function(e,t){$.Cache.addAltitude(t.lat,t.lon,t.z)}),t.resolve()):(console.log("Impossible d'obtenir les données d'altitude: résultats invalides"),t.reject())},onFailure:function(e){console.log("Impossible d'obtenir les données d'altitude: ",e.message),t.reject()}};Gp.Services.getAltitude(a)})}function r(e,t,a){return $.Deferred(function(){var n=this,o={tilematrix:16,tilerow:t,tilecol:e,lon:"",lat:"",x:"",y:""};$.each(a,function(e,t){e>0&&(o.lon+="|",o.lat+="|",o.x+="|",o.y+="|"),o.lon+=t.lng.toString(),o.lat+=t.lat.toString(),o.x+=t.x.toString(),o.y+=t.y.toString()}),$.getJSON("slope.php",o,function(e){e.results?($.each(e.results,function(e,t){$.Cache.addSlope(t.lat,t.lon,t.slope)}),n.resolve()):(console.log("Impossible d'obtenir les données de pente: résultats invalides"),n.reject())}).fail(function(e,t,a){console.log("Impossible d'obtenir les données de pente: ",t,a),n.reject()})})}function i(e){return $.Deferred(function(){var t=this,a=!1;try{a=!!new Blob}catch(e){}if(!a)return t.reject(),!1;var n='<?xml version="1.0"?>\n';n+='<gpx creator="map2gpx.fr" version="1.0" xmlns="http://www.topografix.com/GPX/1/1"',n+=' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',n+=' xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n',n+="    <trk>\n",n+="        <name>"+e+"</name>\n",n+="        <trkseg>\n",$.Cache.eachRoute(function(t,a){"step"==$.Cache.getMarker(t).getType()&&(n+="        </trkseg>\n",n+="    </trk>\n",n+="    <trk>\n",n+="        <name>"+e+"-"+t+"</name>\n",n+="        <trkseg>\n"),$.each(a.getLatLngs(),function(e,t){n+='            <trkpt lat="'+t.lat+'" lon="'+t.lng+'">',$.Cache.hasAltitude(t)&&(n+="<ele>"+$.Cache.getAltitude(t)+"</ele>"),n+="</trkpt>\n"})}),n+="        </trkseg>\n",n+="    </trk>\n",n+="</gpx>\n";var o=new Blob([n],{type:"application/gpx+xml;charset=utf-8"});saveAs(o,e+".gpx"),t.resolve()})}function l(e){return $.Deferred(function(){var t=this,a=!1;try{a=!!new Blob}catch(e){}if(!a)return t.reject(),!1;var n='<?xml version="1.0" encoding="UTF-8"?>\n';n+='<kml xmlns="http://www.opengis.net/kml/2.2"',n+=' xmlns:gx="http://www.google.com/kml/ext/2.2"',n+=' xmlns:kml="http://www.opengis.net/kml/2.2"',n+=' xmlns:atom="http://www.w3.org/2005/Atom">\n',n+="    <Document>\n",n+="        <name>"+e+".kml</name>\n",n+="        <Placemark>\n",n+="            <name>"+e+"</name>\n",n+="            <LineString>\n",n+="                <tessellate>1</tessellate>\n",n+="                <coordinates>\n",n+="                    ",$.Cache.eachRoute(function(t,a){"step"==$.Cache.getMarker(t).getType()&&(n+="\n                </coordinates>\n",n+="            </LineString>\n",n+="        </Placemark>\n",n+="        <Placemark>\n",n+="            <name>"+e+"-"+t+"</name>\n",n+="            <LineString>\n",n+="                <tessellate>1</tessellate>\n",n+="                <coordinates>\n",n+="                    "),$.each(a.getLatLngs(),function(e,t){n+=t.lng+","+t.lat+",0 "})}),n+="\n                </coordinates>\n",n+="            </LineString>\n",n+="        </Placemark>\n",n+="    </Document>\n",n+="</kml>\n";var o=new Blob([n],{type:"text/plain;charset=utf-8"});saveAs(o,e+".kml"),t.resolve()})}function s(){var e=[],t=0,a=Number.MAX_VALUE,n=Number.MIN_VALUE,o=0,r=0,i=0,l=0,s=0,c=Number.MAX_VALUE,u=Number.MIN_VALUE,d=0,g=0,h=0,p=0,m=[{id:"altmax",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:10}},{id:"altmin",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:-10}},{id:"distance",type:"line",mode:"vertical",scaleID:"distance",value:0,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",xAdjust:-50}}],f=0;if($.Cache.eachRoute(function(v,C){if(null!=C){if("step"==$.Cache.getMarker(v).getType()){m.push({id:"distance-"+v,type:"line",mode:"vertical",scaleID:"distance",value:t,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1});for(var M=f;M<v;M++)$.Cache.getRoute(M).setPopupContent('<ul class="legend '+$.Cache.getMarker(M).getColorCode()+'"><li>Altitude max: '+Math.round(u)+"m</li><li>D+: "+Math.round(h)+"m</li><li>Altitude min: "+Math.round(c)+"m</li><li>D-: "+Math.round(p)+"m</li><li>Distance: "+Math.round(100*s)/100+"km</li></ul>");f=v,s=0,c=Number.MAX_VALUE,u=Number.MIN_VALUE,d=0,g=0,h=0,p=0}var y=C.getElevations();if(y.length>0){for(var b=0;b<y.length;b++)y[b].dist+=t;e=e.concat(y),t+=C.getDistance(),C.getAltMin()<a&&(a=C.getAltMin()),C.getAltMax()>n&&(n=C.getAltMax()),C.getSlopeMax()>o&&(o=C.getSlopeMax()),C.getSlopeMin()<r&&(r=C.getSlopeMin()),l+=C.getDenivNeg(),i+=C.getDenivPos(),s+=C.getDistance(),C.getAltMin()<c&&(c=C.getAltMin()),C.getAltMax()>u&&(u=C.getAltMax()),C.getSlopeMax()>d&&(d=C.getSlopeMax()),C.getSlopeMin()<g&&(g=C.getSlopeMin()),p+=C.getDenivNeg(),h+=C.getDenivPos()}}}),s>0)for(var v=f;v<$.Cache.lengthOfRoutes();v++)$.Cache.getRoute(v).setPopupContent('<ul class="legend '+$.Cache.getMarker(v).getColorCode()+'"><li>Altitude max: '+Math.round(u)+"m</li><li>D+: "+Math.round(h)+"m</li><li>Altitude min: "+Math.round(c)+"m</li><li>D-: "+Math.round(p)+"m</li><li>Distance: "+Math.round(100*s)/100+"km</li></ul>");var C=e.length;if(C>0){var M=[],y=[],b=[];if(isSmallScreen)$("#data").html("<ul><li>Altitude max: "+Math.round(n)+"m; D+: "+Math.round(i)+"m</li><li>Altitude min: "+Math.round(a)+"m; D-: "+Math.round(l)+"m</li><li>Distance: "+Math.round(100*e[C-1].dist)/100+"km</li></ul>");else{for(var S=0;S<C;S++)M.push({x:e[S].dist,y:e[S].z,lat:e[S].lat,lng:e[S].lng}),y.push({x:e[S].dist,y:e[S].slopeOnTrack,lat:e[S].lat,lng:e[S].lng}),b.push({x:e[S].dist,y:e[S].slope,lat:e[S].lat,lng:e[S].lng});var x=M.length-1;D.options.scales.xAxes[0].ticks.max=M[x].x,D.config.data.datasets[0].data=M,D.config.data.datasets[1].data=y,D.config.data.datasets[2].data=b,m[0].value=n,m[0].label.content="Altitude max: "+Math.round(n)+"m; D+: "+Math.round(i)+"m",m[1].value=a,m[1].label.content="Altitude min: "+Math.round(a)+"m; D-: "+Math.round(l)+"m",m[2].value=M[x].x,m[2].label.content="Distance: "+Math.round(100*M[x].x)/100+"km";var k=document.getElementById("chart").getContext("2d").createLinearGradient(0,0,0,120),L=10*Math.ceil(o/10),A=10*Math.floor(r/10),w=-A+L;0!=w&&(L>=45&&k.addColorStop((L-45)/w,"purple"),L>=40&&k.addColorStop((L-40)/w,"red"),L>=35&&k.addColorStop((L-35)/w,"orange"),L>=30&&k.addColorStop((L-30)/w,"yellow"),k.addColorStop(L/w,"grey"),A<=-30&&k.addColorStop((L+30)/w,"yellow"),A<=-35&&k.addColorStop((L+35)/w,"orange"),A<=-40&&k.addColorStop((L+40)/w,"red"),A<=-45&&k.addColorStop((L+45)/w,"purple"),D.config.data.datasets[1].backgroundColor=k);var _=document.getElementById("chart").getContext("2d").createLinearGradient(0,0,0,120);_.addColorStop(0,"purple"),_.addColorStop(1-40/45,"red"),_.addColorStop(1-35/45,"orange"),_.addColorStop(1-30/45,"yellow"),_.addColorStop(1,"grey"),D.config.data.datasets[2].backgroundColor=_,D.options.annotation={},D.update(),D.options.annotation={annotations:m},D.update()}$("#data-empty").slideUp()}else isSmallScreen||(D.options.scales.xAxes[0].ticks.max=1,D.config.data.datasets[0].data=[],D.config.data.datasets[1].data=[],D.config.data.datasets[2].data=[]),$("#data-empty").slideDown()}var c=this;L.LatLng.prototype.roundE8=function(){return L.latLng(Math.roundE8(this.lat),Math.roundE8(this.lng))},L.LatLng.prototype.toTilePixel=function(e,t,a,n){var o=e.latLngToPoint(this,t).floor(),r=o.divideBy(a).floor(),i=r.multiplyBy(a).subtract(n);return{tile:r,tilePixel:o.subtract(n).subtract(i)}},L.LatLng.prototype.getDestinationAlong=function(e,t){var a=6378137,n=Math.radians(e),o=Math.radians(this.lat),r=Math.radians(this.lng),i=Math.asin(Math.sin(o)*Math.cos(t/a)+Math.cos(o)*Math.sin(t/a)*Math.cos(n)),l=r+Math.atan2(Math.sin(n)*Math.sin(t/a)*Math.cos(o),Math.cos(t/a)-Math.sin(o)*Math.sin(i));return i=Math.degrees(i),l=Math.degrees(l),L.latLng(Math.roundE8(i),Math.roundE8(l))},L.LatLng.prototype.bearingTo=function(e){var t=Math.radians(this.lat),a=Math.radians(this.lng),n=Math.radians(e.lat),o=Math.radians(e.lng),r=Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(t/2+Math.PI/4)),i=o-a;return Math.abs(i)>Math.PI&&(i=i>0?-(2*Math.PI-i):2*Math.PI+i),(Math.degrees(Math.atan2(i,r))+360)%360},L.Handler.include({setEnabled:function(e){e?this.enable():this.disable()}}),L.Control.EasyButton.include({setEnabled:function(e){e?this.enable():this.disable()}}),L.Layer.include({_elevations:[],_distance:0,_altMin:0,_altMax:0,_slopeMin:0,_slopeMax:0,_denivPos:0,_denivNeg:0,getElevations:function(){return JSON.parse(JSON.stringify(this._elevations))},getDistance:function(){return this._distance},getAltMin:function(){return this._altMin},getAltMax:function(){return this._altMax},getSlopeMin:function(){return this._slopeMin},getSlopeMax:function(){return this._slopeMax},getDenivPos:function(){return this._denivPos},getDenivNeg:function(){return this._denivNeg},computeStats:function(){var e=this;return $.Deferred(function(){var t=this;$.when.apply($,e._fetchAltitude().concat(e._fetchSlope())).fail(function(){t.reject()}).then(function(){var a=[];$.each(e.getLatLngs(),function(e,t){var n=$.extend({},{lat:t.lat,lng:t.lng},$.Cache.getInfos(t));a.push(n)}),0==a.length&&t.resolve(),e._distance=0,e._altMin=a[0].z,e._altMax=a[0].z,e._slopeMax=0,e._slopeMin=0,e._denivPos=0,e._denivNeg=0,a[0].dist=0,a[0].slopeOnTrack=0,e._elevations=[a[0]];for(var n=0,o=1;o<a.length;o++){var r=L.latLng(a[o]).distanceTo(L.latLng(e._elevations[n]));if(r>10){if(e._distance+=r/1e3,n++,e._elevations[n]=a[o],e._elevations[n].dist=e._distance,e._elevations[n].slopeOnTrack=Math.degrees(Math.atan((Math.round(e._elevations[n].z)-Math.round(e._elevations[n-1].z))/r)),n>5){var i=(e._elevations[n-5].slopeOnTrack+e._elevations[n-4].slopeOnTrack+e._elevations[n-3].slopeOnTrack+e._elevations[n-2].slopeOnTrack+e._elevations[n-1].slopeOnTrack)/5;e._elevations[n].slopeOnTrack=(i+e._elevations[n].slopeOnTrack)/2}e._elevations[n].z<e._altMin&&(e._altMin=e._elevations[n].z),e._elevations[n].z>e._altMax&&(e._altMax=e._elevations[n].z),e._elevations[n].slopeOnTrack>e._slopeMax&&(e._slopeMax=e._elevations[n].slopeOnTrack),e._elevations[n].slopeOnTrack<e._slopeMin&&(e._slopeMin=e._elevations[n].slopeOnTrack),e._elevations[n].z<e._elevations[n-1].z?e._denivNeg+=Math.round(e._elevations[n-1].z-e._elevations[n].z):e._denivPos+=Math.round(e._elevations[n].z-e._elevations[n-1].z)}}t.resolve()})})},_fetchAltitude:function(){var e=[],t=[];return $.each(this.getLatLngs(),function(a,n){$.Cache.hasAltitude(n)||(e.push({lon:n.lng,lat:n.lat}),50==e.length&&(t.push(o(e)),e=[]))}),e.length>0&&t.push(o(e)),t},_fetchSlope:function(){var e={},t=[];return $.each(this.getLatLngs(),function(t,a){if(!$.Cache.hasSlope(a)){var n=a.toTilePixel(h.options.crs,16,256,h.getPixelOrigin()),o=n.tile,r=n.tilePixel;o.x in e||(e[o.x]={}),o.y in e[o.x]||(e[o.x][o.y]=[[]]),e[o.x][o.y][e[o.x][o.y].length-1].length>50&&e[o.x][o.y].push([]),e[o.x][o.y][e[o.x][o.y].length-1].push({lat:a.lat,lng:a.lng,x:r.x,y:r.y})}}),$.each(e,function(e,a){$.each(a,function(a,n){$.each(n,function(n,o){t.push(r(e,a,o))})})}),t}}),L.GeoJSON.include({getLatLngs:function(){var e=[];return this.eachLayer(function(t){$.each(t.feature.geometry.coordinates,function(t,a){e.push(L.latLng(a[1],a[0]))})}),e}});var u={red:"#D63E2A",orange:"#F59630",green:"#72B026",blue:"#38AADD",purple:"#D252B9",darkred:"#A23336",darkblue:"#0067A3",darkgreen:"#728224",darkpurple:"#5B396B",cadetblue:"#436978",lightred:"#FF8E7F",beige:"#FFCB92",lightgreen:"#BBF970",lightblue:"#8ADAFF",pink:"#FF91EA",white:"#FBFBFB",lightgray:"#A3A3A3",gray:"#575757",black:"#303030"},d=["blue","green","orange","purple","red","darkblue","darkpurple","lightblue","lightgreen","beige","pink","lightred"],g=0;L.Marker.include({__type:"waypoint",__color:g,getColorCode:function(){return d[this.__color]},getColorRgb:function(){return u[d[this.__color]]},getColorIndex:function(){return this.__color},setColorIndex:function(e){this.__color=e},getType:function(){return this.__type},setType:function(e){this.__type=e,"waypoint"==e?this.setIcon(L.AwesomeMarkers.icon({icon:"circle",markerColor:this.getColorCode(),prefix:"fa"})):this.setIcon(L.AwesomeMarkers.icon({icon:"asterisk",markerColor:this.getColorCode(),prefix:"fa"}))}}),isSmallScreen&&$("#mobile-warning").show().find("button").click(function(){popup.hide()});var h=L.map("map",{}).setView([c[0],c[1]],c[2]);$("body").on("map2gpx:modechange",function(e){h.doubleClickZoom.setEnabled(null===e.mode)});var p=L.geoportalLayer.WMTS({layer:"ORTHOIMAGERY.ORTHOPHOTOS",apiKey:keyIgn}).addTo(h),m=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.SLOPES.MOUNTAIN",apiKey:keyIgn},{opacity:.25}).addTo(h),f=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn},{opacity:.25}).addTo(h);if(L.geoportalControl.SearchEngine({displayAdvancedSearch:!1}).addTo(h),!isSmallScreen){var v=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn});new L.Control.MiniMap(v,{position:"bottomleft",zoomLevelOffset:-4}).addTo(h)}var C=L.geoportalControl.LayerSwitcher({collapsed:isSmallScreen});h.addControl(C),C.setVisibility(m,!1),$(".GPlayerRemove").remove(),isSmallScreen||h.addControl(L.control.scale({imperial:!1,position:"bottomright"}));var M=L.easyButton({id:"btn-autotrace",states:[{stateName:"loaded",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(e,t){$.State.setMode("auto")}},{stateName:"active",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(e,t){$.State.setMode(null)}}]});$("body").on("map2gpx:modechange map2gpx:markerschange",function(e){"auto"==e.mode?(M.state("active"),M.enable()):(M.state("loaded"),M.setEnabled(!$.Cache.hasRoutes()||"import"!=$.Cache.getRouteMode(0)))});var y=L.easyButton({id:"btn-straighttrace",states:[{stateName:"loaded",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(e,t){$.State.setMode("straight")}},{stateName:"active",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(e,t){$.State.setMode(null)}}]});$("body").on("map2gpx:modechange map2gpx:markerschange",function(e){"straight"==e.mode?(y.state("active"),y.enable()):(y.state("loaded"),y.setEnabled(!$.Cache.hasRoutes()||"import"!=$.Cache.getRouteMode(0)))});var b=L.easyButton({id:"btn-closeloop",states:[{stateName:"loaded",icon:"fa-magic",title:"Fermer la boucle",onClick:function(e,t){$.Cache.hasMarkers(1)&&n({latlng:$.Cache.getMarker(0).getLatLng()})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Fermer la boucle (calcul en cours...)"}]});$("body").on("map2gpx:modechange map2gpx:computingchange map2gpx:markerschange",function(e){e.computing?(b.state("computing"),b.disable()):(b.state("loaded"),b.setEnabled(null!==e.mode&&$.Cache.hasRoutes()&&"import"!=$.Cache.getRouteMode(0)))}),L.easyBar([M,y,b]).addTo(h);var S=L.popup().setContent(L.DomUtil.get("form-export")),x=L.easyButton({id:"btn-export",states:[{stateName:"loaded",icon:"fa-cloud-download",title:"Exporter",onClick:function(e,t){var a=L.latLngBounds($.Cache.getMarker(0).getLatLng(),$.Cache.getMarker(1).getLatLng());$.Cache.eachRoute(function(e,t){a.extend(t.getBounds())}),t.flyToBounds(a,{padding:[50,50]}),S.setLatLng($.Cache.getMarker(0).getLatLng()).openOn(t),$(".export-gpx-button:visible").click(function(){var e=$(this);e.attr("disabled","disabled"),$.when(i($(".export-filename:visible").val())).then(function(){e.removeAttr("disabled")})}),$(".export-kml-button:visible").click(function(){var e=$(this);e.attr("disabled","disabled"),$.when(l($(".export-filename:visible").val())).then(function(){e.removeAttr("disabled")})})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Exporter (calcul en cours...)"}]}).addTo(h);$("body").on("map2gpx:computingchange map2gpx:markerschange",function(e){e.computing?(x.state("computing"),x.disable()):(x.state("loaded"),x.setEnabled($.Cache.hasMarkers()))});var k=L.popup().setContent(L.DomUtil.get("form-import")),A=L.easyButton({id:"btn-import",states:[{stateName:"loaded",icon:"fa-cloud-upload",title:"Importer",onClick:function(t,a){k.setLatLng(a.getCenter()).openOn(a),$.Cache.hasRoutes()?$(".import-gpx-status:visible").html("<strong>Attention:</strong> l'import va effacer l'itinéraire existant!"):$(".import-gpx-status:visible").text(""),$(".import-gpx-button:visible").click(function(){var t=$(this),n=$(".import-gpx-file:visible")[0].files[0];if(void 0!=n){t.attr("disabled","disabled"),$.State.setComputing(!0),$(".import-gpx-status:visible").text("Importation en cours...");var o=new FileReader;o.onload=function(n){var o=[];new L.GPX(n.target.result,{async:!0,onFail:function(){console.log("Failed to retrieve track"),$(".import-gpx-status:visible").text("Imposible de traiter ce fichier"),t.removeAttr("disabled"),$.State.setComputing(!1)},onSuccess:function(n){$(".import-gpx-status:visible").text("Récupération des données géographiques en cours..."),$.Cache.eachRoute(function(e,t){a.removeLayer(t)}),$.Cache.resetRoutes(),$.Cache.eachMarker(function(e,t){a.removeLayer(t)}),$.Cache.resetMarkers();var r=function(){$(".track-delete-button:visible").click(function(){$.State.setComputing(!0),$.Cache.eachRoute(function(e,t){a.removeLayer(t)}),$.Cache.resetRoutes(),$.Cache.eachMarker(function(e,t){a.removeLayer(t)}),$.Cache.resetMarkers(),a.removeLayer(n),$.State.triggerMarkersChanged(),$.State.setComputing(!1)})};a.fitBounds(n.getBounds(),{padding:[50,50]}),k.setLatLng(n.getBounds().getCenter()),n.addTo(a);var i=[];$.each(o,function(t,n){if($.Cache.addRoute(n,"import"),0==t){var o=n.getLatLngs()[0],l=L.marker(o,{draggable:!1,opacity:.5});l.setColorIndex(g),l.setType("waypoint"),$.Cache.addMarker(l),l.addTo(a),l.bindPopup('<button class="track-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer l\'import</button>'),l.on("popupopen",r)}var s=n.getLatLngs()[n.getLatLngs().length-1],c=L.marker(s,{draggable:!1,opacity:.5});c.setColorIndex(e()),c.setType("step"),$.Cache.addMarker(c),c.addTo(a),n.setStyle({weight:5,color:$.Cache.getMarker(t).getColorRgb(),opacity:.5}),n.bindPopup("Calculs en cours..."),c.bindPopup('<button class="track-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer l\'import</button>'),c.on("popupopen",r),i.push(n.computeStats())}),$.when.apply($,i).done(function(){$.Cache.eachRoute(function(e,t){t.setStyle({opacity:.75})}),$.Cache.eachMarker(function(e,t){t.setOpacity(1)}),k.remove(),$.State.triggerMarkersChanged(),$.State.setMode(null),$.State.setComputing(!1)}).fail(function(){console.log("Fail"),$(".import-gpx-status:visible").text("Impossible de récupérer les données géographiques de ce parcours"),t.removeAttr("disabled"),$.State.setComputing(!1)})}}).on("addline",function(e){o.push(e.line)})},o.readAsText(n)}else $(".import-gpx-status:visible").text("Veuillez sélectionner un fichier")})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Importer (calcul en cours...)"}]}),w=L.easyButton({id:"btn-reset",states:[{stateName:"loaded",icon:"fa-trash",title:"Effacer l'itinéraire",onClick:function(e,t){$.State.setComputing(!0),$.Cache.eachRoute(function(e,a){t.removeLayer(a)}),$.Cache.resetRoutes(),$.Cache.eachMarker(function(e,a){t.removeLayer(a)}),$.Cache.resetMarkers(),$.State.triggerMarkersChanged(),$.State.setComputing(!1)}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Effacer l'itinéraire (calcul en cours...)"}]});if(L.easyBar([A,w]).addTo(h),$("body").on("map2gpx:computingchange",function(e){A.state(e.computing?"computing":"loaded"),w.state(e.computing?"computing":"loaded"),A.setEnabled(!e.computing),w.setEnabled(!e.computing)}),!isSmallScreen){var _=L.popup().setContent(L.DomUtil.get("about")),T=L.easyButton({position:"bottomright",states:[{icon:"fa-info-circle",onClick:function(e,t){_.setLatLng(t.getCenter()).openOn(t)},title:"A propos & crédits"}]}),I=L.easyButton({position:"bottomright",states:[{icon:"fa-question-circle",onClick:function(e,t){$.Shepherd.get(0).start(!0)},title:"Aide"}]});L.easyBar([T,I],{position:"bottomright"}).addTo(h)}h.on("dblclick",n);var R;h.on("zoomend",function(){console.log("Zoomed to ",h.getZoom()),hasLocalStorage&&localStorage.setItem("view",JSON.stringify([h.getCenter().lat,h.getCenter().lng,h.getZoom()]));var e=void 0,t=void 0;(p.options.minZoom>h.getZoom()||p.options.maxZoom<h.getZoom())&&h.hasLayer(p)?(e="Photographies aériennes",t=$(".GPlayerSwitcher_layer:eq(2)")):(f.options.minZoom>h.getZoom()||f.options.maxZoom<h.getZoom())&&h.hasLayer(f)?(e="Cartes IGN",t=$(".GPlayerSwitcher_layer:eq(0)")):(m.options.minZoom>h.getZoom()||m.options.maxZoom<h.getZoom())&&h.hasLayer(m)&&(e="Carte des pentes",t=$(".GPlayerSwitcher_layer:eq(1)")),void 0!==e&&void 0===R?((R=new Drop({target:t[0],classes:"drop-theme-arrows",position:"left middle",constrainToWindow:!1,constrainToScrollParent:!1,openOn:null,content:"La couche &quot;"+e+"&quot; n'est pas disponible à ce niveau de zoom"})).open(),$(R.content).on("click",function(){R.destroy(),R=null})):void 0===e&&void 0!==R&&null!==R&&(R.destroy(),R=null)}),h.on("moveend",function(){console.log("Moved to ",h.getCenter()),hasLocalStorage&&localStorage.setItem("view",JSON.stringify([h.getCenter().lat,h.getCenter().lng,h.getZoom()]))}),$("body").on("map2gpx:computingchange",function(e){e.computing?$("#data-computing").fadeIn():(s(),$("#data-computing").fadeOut())});var O=null,P={icon:L.AwesomeMarkers.icon({icon:"area-chart",markerColor:"cadetblue",prefix:"fa"}),draggable:!1,clickable:!1,zIndexOffset:1e3};if(isSmallScreen)$("#chart").remove();else var D=new Chart($("#chart"),{type:"line",data:{datasets:[{label:"Altitude",data:[],fill:!1,borderColor:"rgba(12, 98, 173, 0.8)",backgroundColor:"rgba(12, 98, 173, 0.8)",lineTension:0,pointRadius:0,yAxisId:"alt"},{label:"Pente de l'itinéraire",data:[],fill:!0,pointRadius:0,yAxisID:"slope"},{label:"Pente du terrain",data:[],fill:!0,pointRadius:0,yAxisID:"slope2",hidden:!0}]},options:{maintainAspectRatio:!1,hover:{mode:"index",intersect:!1,onHover:function(e,t){if("mousemove"==e.type)if(t&&t.length>0){var a=t[0]._index,n=D.config.data.datasets[0].data[a];null==O?(O=L.marker(L.latLng(n.lat,n.lng),P)).addTo(h):(O.setLatLng(L.latLng(n.lat,n.lng)),O.update())}else O&&(h.removeLayer(O),O=null);else"mouseout"==e.type&&O&&(h.removeLayer(O),O=null)}},scales:{xAxes:[{id:"distance",type:"linear",position:"bottom",ticks:{min:0}}],yAxes:[{id:"alt",type:"linear",position:"left",beginAtZero:!1},{id:"slope",type:"linear",position:"right"},{id:"slope2",type:"linear",position:"right",ticks:{min:0,max:45}}]},legend:{position:"left"},tooltips:{mode:"index",intersect:!1,callbacks:{title:function(e,t){return"Distance: "+Math.floor(100*e[0].xLabel)/100+"km"},label:function(e,t){return t.datasets[e.datasetIndex].label+": "+(0==e.datasetIndex?Math.round(100*e.yLabel)/100+"m":Math.round(e.yLabel)+"°")}}},annotation:{annotations:[]}}});$.State.setMode(null),$.State.triggerMarkersChanged(),$.State.setComputing(!1),isSmallScreen||$.Shepherd.tour().add("welcome",{text:$("#help-welcome")[0]}).add("layers",{text:$("#help-layers")[0],attachTo:{element:$(".GPlayerName").closest(".GPwidget")[0],on:"left"}}).add("search",{text:$("#help-search")[0],attachTo:{element:$(".GPshowAdvancedToolOpen").closest(".GPwidget")[0],on:"right"}}).add("autotrace",{text:$("#help-autotrace")[0],attachTo:{element:$("#btn-autotrace")[0],on:"right"}}).add("straighttrace",{text:$("#help-straighttrace")[0],attachTo:{element:$("#btn-straighttrace")[0],on:"right"}}).start(),$("#loading").fadeOut()})};