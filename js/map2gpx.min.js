"use strict";function fetchAltitude(t){return $.Deferred(function(){var e=this,n={apiKey:keyIgn,sampling:t.length,positions:t,onSuccess:function(t){t?($.each(t.elevations,function(t,e){$.Cache.addAltitude(e.lat,e.lon,e.z)}),e.resolveWith({size:t.elevations.length})):(console.log("Impossible d'obtenir les données d'altitude: résultats invalides"),e.reject())},onFailure:function(t){console.log("Impossible d'obtenir les données d'altitude: ",t.message),e.reject()}};Gp.Services.getAltitude(n)})}function fetchSlope(t,e,n){return $.Deferred(function(){var o=this,a={tilematrix:16,tilerow:e,tilecol:t,lon:"",lat:"",x:"",y:""};$.each(n,function(t,e){t>0&&(a.lon+="|",a.lat+="|",a.x+="|",a.y+="|"),a.lon+=e.lng.toString(),a.lat+=e.lat.toString(),a.x+=e.x.toString(),a.y+=e.y.toString()}),$.getJSON("slope.php",a,function(t){t.results?($.each(t.results,function(t,e){$.Cache.addSlope(e.lat,e.lon,e.slope)}),o.resolveWith({size:t.results.length})):(console.log("Impossible d'obtenir les données de pente: résultats invalides"),o.reject())}).fail(function(t,e,n){console.log("Impossible d'obtenir les données de pente: ",e,n),o.reject()})})}!function(t){var e=function(t){var e;try{var n="__storage_test__";return(e=window[t]).setItem(n,n),e.removeItem(n),!0}catch(t){return t instanceof DOMException&&(22===t.code||1014===t.code||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name)&&0!==e.length}}("localStorage");t.localStorage={get:function(t){return e?localStorage.getItem(t):null},getAsJSON:function(t){return e&&null!==localStorage.getItem(t)?JSON.parse(localStorage.getItem(t)):null},set:function(t,n){e&&localStorage.setItem(t,n)},setAsJSON:function(t,e){this.set(t,JSON.stringify(e))}}}(jQuery),jQuery.QueryString=function(t){for(var e={},n=0;n<t.length;++n){var o=t[n].split("=",2);2===o.length&&(e[o[0]]=decodeURIComponent(o[1].replace(/\+/g," ")))}return e}(window.location.search.substr(1).split("&")),function(t){var e=[];t.Shepherd={},t.Shepherd.Step=function(){var e,n;return{init:function(o,a){return e=o,n=t.extend({},a,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"}),this}}},t.Shepherd.step=function(e,n){return t.Shepherd.Step().init(e,n)},t.Shepherd.Tour=function(){var n,o=0;return{init:function(e){var o=t.extend({},e,{defaults:{classes:"shepherd-element shepherd-open shepherd-theme-arrows",showCancelLink:!0}});return n=new Shepherd.Tour(o),this},add:function(a,i){var r=this,s=o,l=t.extend({},i,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"});return l.buttons=[{text:"Fermer",classes:"shepherd-button-secondary",action:function(){t.localStorage.set("tutorial"+e.indexOf(r),-1),r.cancel()}},{text:"Suivant",classes:"shepherd-button-example-primary",action:function(){var n=e.indexOf(r);n<0&&console.log("Could not find current shepherd, something is probably wrong"),t.localStorage.set("tutorial"+n,s+1),r.next(),s==o-1&&n>=0&&n<e.length-1&&e[n+1].start(!0)}}],n.addStep(a,l),o++,this},start:function(){var a=0;if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])){var i=e.indexOf(this);null!==t.localStorage.get("tutorial"+i)&&(a=parseInt(t.localStorage.get("tutorial"+i)))}return a>=0&&a<o&&n.show(a),this},cancel:function(){return n.cancel(),this},next:function(){return n.next(),this}}},t.Shepherd.tour=function(n){var o=t.Shepherd.Tour().init(n);return e.push(o),o},t.Shepherd.get=function(t){return e[t]},t.Shepherd.has=function(t){return e.length>t}}(jQuery),Math.roundE8=function(t){return Math.round(t*Math.pow(10,8))/Math.pow(10,8)},Math.radians=function(t){return t*Math.PI/180},Math.degrees=function(t){return 180*t/Math.PI},L.LatLng.prototype.roundE8=function(){return L.latLng(Math.roundE8(this.lat),Math.roundE8(this.lng))},L.LatLng.prototype.toTilePixel=function(t,e,n,o){var a=t.latLngToPoint(this,e).floor(),i=a.divideBy(n).floor(),r=i.multiplyBy(n).subtract(o);return{tile:i,tilePixel:a.subtract(o).subtract(r)}},L.LatLng.prototype.getDestinationAlong=function(t,e){var n=6378137,o=Math.radians(t),a=Math.radians(this.lat),i=Math.radians(this.lng),r=Math.asin(Math.sin(a)*Math.cos(e/n)+Math.cos(a)*Math.sin(e/n)*Math.cos(o)),s=i+Math.atan2(Math.sin(o)*Math.sin(e/n)*Math.cos(a),Math.cos(e/n)-Math.sin(a)*Math.sin(r));return r=Math.degrees(r),s=Math.degrees(s),L.latLng(Math.roundE8(r),Math.roundE8(s))},L.LatLng.prototype.bearingTo=function(t){var e=Math.radians(this.lat),n=Math.radians(this.lng),o=Math.radians(t.lat),a=Math.radians(t.lng),i=Math.log(Math.tan(o/2+Math.PI/4)/Math.tan(e/2+Math.PI/4)),r=a-n;return Math.abs(r)>Math.PI&&(r=r>0?-(2*Math.PI-r):2*Math.PI+r),(Math.degrees(Math.atan2(r,i))+360)%360},L.Handler.include({setEnabled:function(t){t?this.enable():this.disable()}}),L.Control.EasyButton.include({setEnabled:function(t){t?this.enable():this.disable()}}),L.Polyline.include({getLatLngsFlatten:function(){var t=this.getLatLngs();if(t.length>0&&Array.isArray(t[0])){var e=[];return $.each(t,function(t,n){e=e.concat(n)}),e}return t}}),L.polyline_findAuto=function(t,e){return $.Deferred(function(){var n=this,o={distanceUnit:"m",endPoint:{x:e.lng,y:e.lat},exclusions:[],geometryInInstructions:!0,graph:"Pieton",routePreferences:"fastest",startPoint:{x:t.lng,y:t.lat},viaPoints:[],apiKey:keyIgn,onSuccess:function(t){if(t){var e=[];$.each(t.routeInstructions,function(t,n){$.each(n.geometry.coordinates,function(t,n){e.push(L.latLng(n[1],n[0]))})});var o=L.polyline(e);n.resolveWith({geojson:o})}else n.rejectWith({error:"Impossible d'obtenir la route: pas de résultats fournis"})},onFailure:function(t){n.rejectWith({error:"Impossible d'obtenir la route: "+t.message})}};Gp.Services.route(o)})},L.polyline_findStraight=function(t,e){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:10,o=t.roundE8(),a=e.roundE8(),i=o.distanceTo(a),r=o.bearingTo(a),s=[o],l=n;l<i;l+=n)s.push(o.getDestinationAlong(r,l));return s.push(a),L.polyline(s)},L.Polyline.include({distanceTo:function(t){for(var e=this.getLatLngsFlatten(),n=t.getLatLngsFlatten(),o={},a=e.length,i=n.length,r=Number.MIN_VALUE,s=Number.MIN_VALUE,l=0;l<a;l++){for(var c=Number.MAX_VALUE,u=0;u<i;u++)o[l+"/"+u]=e[l].distanceTo(n[u]),o[l+"/"+u]<c&&(c=o[l+"/"+u]);c>r&&(r=c)}for(var h=0;h<i;h++){for(var p=Number.MAX_VALUE,d=0;d<a;d++)o[d+"/"+h]<p&&(p=o[d+"/"+h]);p>s&&(s=p)}return Math.max(r,s)}});var _interpolateTrackData=function t(e,n,o,a){if(n.length>500)return $.Deferred(function(){var i=this,r=n.slice(0,500),s=n.slice(499);t(e,r,s.concat(o.slice(1)),a+1).done(i.resolve).fail(i.reject)});var i=new L.Polyline(n);if(n.length<100){var r=L.polyline_findStraight(n[0],n[n.length-1]);if(n.length<=4||i.distanceTo(r)<10)return e.notify({line:r,count:n.length-1}),$.Deferred(function(){this.resolve({line:r,mode:"straight",coordsLeft:o})})}return $.Deferred(function(){var r=this;L.polyline_findAuto(n[0],n[n.length-1]).done(function(){if(i.distanceTo(this.geojson)<10)e.notify({line:this.geojson,count:n.length-1}),r.resolve({line:this.geojson,mode:"auto",coordsLeft:o});else{var s=n.slice(0,Math.floor(n.length/2)+1),l=n.slice(Math.floor(n.length/2));t(e,s,l.concat(o.slice(1)),a+1).done(r.resolve).fail(r.reject)}}).fail(function(){var i=n.slice(0,Math.floor(n.length/2)+1),s=n.slice(Math.floor(n.length/2));t(e,i,s.concat(o.slice(1)),a+1).done(r.resolve).fail(r.reject)})})};L.polyline_interpolate=function(t){return $.Deferred(function(){var e=this,n=[];_interpolateTrackData(this,t,[],0).done(function t(o){n.push(o),o.coordsLeft.length>0?_interpolateTrackData(e,o.coordsLeft,[],0).done(t).fail(e.reject):e.resolve(n)}).fail(this.reject)})},function(t){var e=0,n=[];t.fn.clearCompute=function(){return this.each(function(){e-=t(this).queue().length,t(this).clearQueue(),t.Queue.stop()})},t.fn.startCompute=function(n){return this.each(function(){t.Queue.start(),e++,t(this).queue(n)})},t.fn.endCompute=function(n){return this.each(function(){e--,n(),t.Queue.stop()})},t.Queue={size:function(){return e},bindTo:function(t){return n.push(t)},start:function(){0==e&&t.each(n,function(){this.progress("start")})},stop:function(){0==e&&t.each(n,function(){this.progress("stop")})},notify:function(e){t.each(n,function(){this.progress("update",e)})}}}(jQuery),function(t){t.widget("map2gpx.progress",{options:{progress:0,total:0,started:!1},_create:function(){this.element.append('<h2><i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i><br/><strong><span class="data-computing-progress"></span> <small>- <span class="data-computing-status">Calculs en cours...</span></small></strong><div class="data-computing-progressbar-container"><div class="data-computing-progressbar"></div></div></h2>'),this.$h2=this.element.find("h2"),this.$progress=this.element.find(".data-computing-progress"),this.$progressbar=this.element.find(".data-computing-progressbar"),this.$status=this.element.find(".data-computing-status"),this.options.started&&this.start()},_buildEventData:function(){return{started:this.options.started}},start:function(){this.options.started||(this.options.progress=0,this.options.total=0),this.options.started=!0,this.update({start:!0,total:1,status:"Calculs en cours..."}),this._trigger("statechanged",null,this._buildEventData()),this._trigger("started",null,{})},stop:function(){this.options.started=!1,this.update({end:!0,status:"Finalisation..."}),this._trigger("statechanged",null,this._buildEventData()),this._trigger("stopped",null,{})},started:function(t){if(void 0===t)return this.options.started;t?this.start():this.stop()},update:function(e){if(Array.isArray(e)){var n=this;t.each(e,function(){n._update(this)})}else this._update(e);this._display()},_update:function(e){e.start?this.options.total+=e.total:e.end?this.options.progress=this.options.total:e.count?this.options.progress+=e.count:this.options.progress++,"status"in e&&e.status&&this.$status.text(e.status),"step"in e&&e.step&&t("<div><small>"+e.step+"</small></div>").insertAfter(this.$h2).fadeOut(400,function(){t(this).remove()})},_display:function(){var e=1;this.options.total>0&&(e=this.options.progress/this.options.total),this.$progress.text(Math.round(100*e)+"%"),this.$progressbar.css("width",Math.round(100*e)+"%"),42==Math.round(100*e)&&t("<div><small>La grande question sur la vie, l'univers et le reste répondue</small></div>").insertAfter(this.$h2).fadeOut(400,function(){t(this).remove()})}})}(jQuery),function(t){var e={},n={};t.Cache={};var o=function(t){return t.lng+"/"+t.lat};t.Cache.addAltitude=function(t,n,o){e[n+"/"+t]=o},t.Cache.getAltitude=function(t){var n=o(t);return n in e?e[n]:null},t.Cache.hasAltitude=function(t){return o(t)in e},t.Cache.addSlope=function(t,e,o){n[e+"/"+t]=o},t.Cache.getSlope=function(t){var e=o(t);return e in n?n[e]:null},t.Cache.hasSlope=function(t){return o(t)in n},t.Cache.getInfos=function(t){var a=o(t);return{z:a in e?e[a]:null,slope:a in n?n[a]:null}}}(jQuery),L.Map.include({_bindViewEvents:function(){this.on("zoomend",function(){console.log("Zoomed to ",this.getZoom()),$.localStorage.set("view",[this.getCenter().lat,this.getCenter().lng,this.getZoom()])}),this.on("moveend",function(){console.log("Moved to ",this.getCenter()),$.localStorage.setAsJSON("view",[this.getCenter().lat,this.getCenter().lng,this.getZoom()])})},_setView:function(t){this.setView([t[0],t[1]],t[2])},initView:function(){var t=this;return $.Deferred(function(){var e=this,n=$.localStorage.getAsJSON("view")||[44.96777356135154,6.06822967529297,13];if(n[2]>17&&(n[2]=17),"lat"in $.QueryString&&"lng"in $.QueryString&&(n=[$.QueryString.lat,$.QueryString.lng,15]),"loc"in $.QueryString){var o={text:$.QueryString.loc,filterOptions:{type:["StreetAddress","PositionOfInterest"]},apiKey:keyIgn,onSuccess:function(o){o&&"suggestedLocations"in o&&o.suggestedLocations.length>0?(t._setView([o.suggestedLocations[0].position.y,o.suggestedLocations[0].position.x,15]),e.resolveWith(t)):(console.log("No results?"),t._setView(n),e.resolveWith(t))},onFailure:function(o){console.log(o),t._setView(n),e.resolveWith(t)}};Gp.Services.autoComplete(o)}else t._setView(n),e.resolveWith(t)}).done(this._bindViewEvents)}}),L.Layer.include({_elevations:[],_distance:0,_altMin:0,_altMax:0,_denivPos:0,_denivNeg:0,prepareForMap:function(t,e,n){this._mapToAdd=t,this._start=e,this._end=n},getStartMarker:function(){return this._start},getEndMarker:function(){return this._end},getElevations:function(){return JSON.parse(JSON.stringify(this._elevations))},getDistance:function(){return this._distance},getAltMin:function(){return this._altMin},getAltMax:function(){return this._altMax},getDenivPos:function(){return this._denivPos},getDenivNeg:function(){return this._denivNeg},computeStats:function(){var t=this;return $.Deferred(function(){var e=this,n=t._fetchAltitude().concat(t._fetchSlope()),o=n.length;e.notify({start:!0,total:o,status:"Récupération des données géographiques..."}),$.each(n,function(){this.done(function(){e.notify({step:this.size+" points récupérés"})})}),$.when.apply($,n).fail(e.reject).then(function(){t._computeStats(),e.resolve()})})},_computeStats:function(){var t=[];if($.each(this.getLatLngsFlatten(),function(e,n){var o=$.extend({},{lat:n.lat,lng:n.lng},$.Cache.getInfos(n));t.push(o)}),0==t.length)return!1;this._distance=0,this._altMin=t[0].z,this._altMax=t[0].z,this._denivPos=0,this._denivNeg=0,t[0].dist=0,t[0].slopeOnTrack=0,this._elevations=[t[0]];for(var e=0,n=1;n<t.length;n++){var o=L.latLng(t[n]).distanceTo(L.latLng(this._elevations[e]));o>0&&(this._distance+=o/1e3,e++,this._elevations[e]=t[n],this._elevations[e].dist=this._distance,this._elevations[e].slopeOnTrack=Math.degrees(Math.atan((Math.round(this._elevations[e].z)-Math.round(this._elevations[e-1].z))/o)),this._elevations[e].z<this._altMin&&(this._altMin=this._elevations[e].z),this._elevations[e].z>this._altMax&&(this._altMax=this._elevations[e].z),this._elevations[e].z<this._elevations[e-1].z?this._denivNeg+=Math.round(this._elevations[e-1].z-this._elevations[e].z):this._denivPos+=Math.round(this._elevations[e].z-this._elevations[e-1].z))}return!0},_fetchAltitude:function(){var t=[],e=[];return $.each(this.getLatLngsFlatten(),function(n,o){$.Cache.hasAltitude(o)||(t.push({lon:o.lng,lat:o.lat}),50==t.length&&(e.push(fetchAltitude(t)),t=[]))}),t.length>0&&e.push(fetchAltitude(t)),e},_fetchSlope:function(){var t={},e=[],n=this._map||this._mapToAdd;return $.each(this.getLatLngsFlatten(),function(e,o){if(!$.Cache.hasSlope(o)){var a=o.toTilePixel(n.options.crs,16,256,n.getPixelOrigin()),i=a.tile,r=a.tilePixel;i.x in t||(t[i.x]={}),i.y in t[i.x]||(t[i.x][i.y]=[[]]),t[i.x][i.y][t[i.x][i.y].length-1].length>50&&t[i.x][i.y].push([]),t[i.x][i.y][t[i.x][i.y].length-1].push({lat:o.lat,lng:o.lng,x:r.x,y:r.y})}}),$.each(t,function(t,n){$.each(n,function(n,o){$.each(o,function(o,a){e.push(fetchSlope(t,n,a))})})}),e},setPopupContentWith:function(t,e){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.setPopupContent('<ul class="legend '+t+'"><li>Altitude max: '+Math.round(e.altMax)+"m</li><li>D+: "+Math.round(e.denivPos)+"m</li><li>Altitude min: "+Math.round(e.altMin)+"m</li><li>D-: "+Math.round(e.denivNeg)+"m</li><li>Distance: "+Math.round(100*e.distance)/100+"km</li></ul>"+(n?'<button class="marker-add-button"><i class="fa fa-plus" aria-hidden="true"></i> Ajouter un marqueur ici</button>':""))}}),function(t){t.widget("map2gpx.chart",{options:{map:void 0,dataEmpty:"#data-empty",isSmallScreen:!1,showMarker:!0,plotMarkerOptions:{icon:L.AwesomeMarkers.icon({icon:"area-chart",markerColor:"cadetblue",prefix:"fa"}),draggable:!1,clickable:!1,zIndexOffset:1e3},showSlope:!0,showTerrainSlope:!0},_create:function(){var e=this;if(void 0===this.options.map)throw'"map" option cannot be undefined';if(this.$emptyElement=t(this.options.dataEmpty),!this.options.isSmallScreen){this.$chart=t('<canvas width="100%" height="100%"></canvas>').appendTo(this.element);var n=[{label:"Altitude",data:[],fill:!1,borderColor:"rgba(12, 98, 173, 0.8)",backgroundColor:"rgba(12, 98, 173, 0.8)",lineTension:0,pointRadius:0,yAxisId:"alt"}],o=[{id:"alt",type:"linear",position:"left",beginAtZero:!1}];this.options.showSlope&&(this.slopeIdx=n.length,n.push({label:"Pente de l'itinéraire",data:[],fill:!0,pointRadius:0,yAxisID:"slope"}),o.push({id:"slope",type:"linear",position:"right"})),this.options.showTerrainSlope&&(this.slopeTerrainIdx=n.length,n.push({label:"Pente du terrain",data:[],fill:!0,pointRadius:0,yAxisID:"slope2",hidden:!0}),o.push({id:"slope2",type:"linear",position:"right",ticks:{min:0,max:45}}));var a={};this.options.showMarker&&(a={mode:"index",intersect:!1,onHover:function(t,n){return e._onHover(t,n)}}),this.chartjs=new Chart(this.$chart,{type:"line",data:{datasets:n},options:{maintainAspectRatio:!1,onClick:function(t,n){return e._onClick(t,n)},hover:a,scales:{xAxes:[{id:"distance",type:"linear",position:"bottom",ticks:{min:0}}],yAxes:o},legend:{position:"left"},tooltips:{mode:"index",intersect:!1,callbacks:{title:function(t,e){return"Distance: "+Math.floor(100*t[0].xLabel)/100+"km"},label:function(t,e){return e.datasets[t.datasetIndex].label+": "+(0==t.datasetIndex?Math.round(100*t.yLabel)/100+"m":Math.round(t.yLabel)+"°")}}},annotation:{annotations:[]}}})}},_onClick:function(t,e){if(e&&e.length>0){var n=e[0]._index,o=this.chartjs.config.data.datasets[0].data[n];o.route&&o.route.openPopup(L.latLng(o.lat,o.lng))}},_onHover:function(t,e){if("mousemove"==t.type)if(e&&e.length>0){var n=e[0]._index,o=this.chartjs.config.data.datasets[0].data[n];null==this.plotMarker?(this.plotMarker=L.marker(L.latLng(o.lat,o.lng),this.options.plotMarkerOptions),this.plotMarker.addTo(this.options.map)):(this.plotMarker.setLatLng(L.latLng(o.lat,o.lng)),this.plotMarker.update())}else this.plotMarker&&(this.options.map.removeLayer(this.plotMarker),this.plotMarker=null);else"mouseout"==t.type&&this.plotMarker&&(this.options.map.removeLayer(this.plotMarker),this.plotMarker=null)},_replotSmallScreen:function(t){t.size>0?this.element.html("<ul><li>Altitude max: "+Math.round(t.total.altMax)+"m; D+: "+Math.round(t.total.denivPos)+"m</li><li>Altitude min: "+Math.round(t.total.altMin)+"m; D-: "+Math.round(t.total.denivNeg)+"m</li><li>Distance: "+Math.round(100*t.elevations[t.size-1].dist)/100+"km</li></ul>"):this.element.empty()},_replotWideScreen:function(t){if(t.size>0){for(var e=[],n=[],o=[],a=0,i=0,r=0;r<t.size;r++){if(e.push({x:t.elevations[r].dist,y:t.elevations[r].z,lat:t.elevations[r].lat,lng:t.elevations[r].lng,route:t.elevations[r].route}),this.options.showSlope){var s=void 0;(s=r>3&&r<t.size-4?(t.elevations[r-3].slopeOnTrack+2*t.elevations[r-2].slopeOnTrack+4*t.elevations[r-1].slopeOnTrack+8*t.elevations[r].slopeOnTrack+4*t.elevations[r+1].slopeOnTrack+2*t.elevations[r+2].slopeOnTrack+t.elevations[r+3].slopeOnTrack)/22:t.elevations[r].slopeOnTrack)>a&&(a=s),s<i&&(i=s),n.push({x:t.elevations[r].dist,y:s})}this.options.showTerrainSlope&&o.push({x:t.elevations[r].dist,y:t.elevations[r].slope})}var l=t.size-1;if(this.chartjs.options.scales.xAxes[0].ticks.max=e[l].x,this.chartjs.config.data.datasets[0].data=e,t.annotations[0].value=t.total.altMax,t.annotations[0].label.content="Altitude max: "+Math.round(t.total.altMax)+"m; D+: "+Math.round(t.total.denivPos)+"m",t.annotations[1].value=t.total.altMin,t.annotations[1].label.content="Altitude min: "+Math.round(t.total.altMin)+"m; D-: "+Math.round(t.total.denivNeg)+"m",t.annotations[2].value=e[l].x,t.annotations[2].label.content="Distance: "+Math.round(100*e[l].x)/100+"km",this.options.showSlope){this.chartjs.config.data.datasets[this.slopeIdx].data=n;var c=this.$chart[0].getContext("2d").createLinearGradient(0,0,0,120);a=10*Math.ceil(a/10);var u=-(i=10*Math.floor(i/10))+a;0!=u&&(a>=45&&c.addColorStop((a-45)/u,"purple"),a>=40&&c.addColorStop((a-40)/u,"red"),a>=35&&c.addColorStop((a-35)/u,"orange"),a>=30&&c.addColorStop((a-30)/u,"yellow"),c.addColorStop(a/u,"grey"),i<=-30&&c.addColorStop((a+30)/u,"yellow"),i<=-35&&c.addColorStop((a+35)/u,"orange"),i<=-40&&c.addColorStop((a+40)/u,"red"),i<=-45&&c.addColorStop((a+45)/u,"purple"),this.chartjs.config.data.datasets[this.slopeIdx].backgroundColor=c)}if(this.options.showTerrainSlope){this.chartjs.config.data.datasets[this.slopeTerrainIdx].data=o;var h=this.$chart[0].getContext("2d").createLinearGradient(0,0,0,120);h.addColorStop(0,"purple"),h.addColorStop(1-40/45,"red"),h.addColorStop(1-35/45,"orange"),h.addColorStop(1-30/45,"yellow"),h.addColorStop(1,"grey"),this.chartjs.config.data.datasets[this.slopeTerrainIdx].backgroundColor=h}this.chartjs.options.annotation={},this.chartjs.update(),this.chartjs.options.annotation={annotations:t.annotations},this.chartjs.update()}else{this.chartjs.options.scales.xAxes[0].ticks.max=1;for(var p=0;p<this.chartjs.config.data.datasets.length;p++)this.chartjs.config.data.datasets[p].data=[]}},replot:function(e){e.annotations=[{id:"altmax",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:10}},{id:"altmin",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:-10}},{id:"distance",type:"line",mode:"vertical",scaleID:"distance",value:0,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",xAdjust:-50}}],t.each(e.steps,function(t,n){return e.annotations.push({id:"distance-"+t,type:"line",mode:"vertical",scaleID:"distance",value:n,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1})}),isSmallScreen?this._replotSmallScreen(e):this._replotWideScreen(e),e.size>0?this.$emptyElement.slideUp():this.$emptyElement.slideDown()}})}(jQuery),function(t){function e(e,n,i,r){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"auto";return t.Deferred(function(){var l=this;"straight"==s?a(e,n,i,r).progress(l.notify).done(l.resolve).fail(l.reject):o(e,n,i,r).progress(l.notify).done(l.resolve).fail(function(){console.log(this.error),console.log("Trying straight line...");var o=new Drop({target:t(".awesome-marker").eq(r+1)[0],classes:"drop-theme-arrows",position:"right middle",constrainToWindow:!1,constrainToScrollParent:!1,openOn:null,content:"Impossible d'obtenir le tracé en mode automatique. Le mode ligne droite va être utilisé."});o.open(),t(o.content).on("click",function(){o.destroy()}),a(e,n,i,r).progress(l.notify).done(l.resolve).fail(l.reject)})})}function n(e,n,o,a,i,r){return t.Deferred(function(){var i=this;n.prepareForMap(e,o,a),n.computeStats().progress(i.notify).then(function(){n.addTo(e),n.bindPopup("Calculs en cours..."),n.on("popupopen",function(e){t(".marker-add-button:visible").click(function(){var t=L.Marker.routed(e.popup.getLatLng().roundE8(),{riseOnHover:!0,draggable:!0,opacity:.5,color:o.getColorIndex(),type:"waypoint"});t.insert(n).done(function(){t.setOpacity(1)})})}),n.snakeIn(),o.setOpacity(1),a.setOpacity(1),i.resolveWith({route:n})}).fail(function(){i.rejectWith({error:"Impossible d'obtenir les données de la route"})})})}function o(e,o,a,i){return t.Deferred(function(){var t=this;t.notify({start:!0,total:1,status:"Calcul de la route..."}),L.polyline_findAuto(o.getLatLng(),a.getLatLng()).done(function(){t.notify({step:"Route calculée"}),this.geojson.setStyle({color:o.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3}),n(e,this.geojson,o,a,i,"auto").progress(t.notify).done(t.resolve).fail(t.reject)}).fail(t.reject)})}function a(t,e,o,a){var i=L.polyline_findStraight(e.getLatLng(),o.getLatLng());return i.setStyle({color:e.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3}),n(t,i,e,o,a,"straight")}var i={red:"#D63E2A",orange:"#F59630",green:"#72B026",blue:"#38AADD",purple:"#D252B9",darkred:"#A23336",darkblue:"#0067A3",darkgreen:"#728224",darkpurple:"#5B396B",cadetblue:"#436978",lightred:"#FF8E7F",beige:"#FFCB92",lightgreen:"#BBF970",lightblue:"#8ADAFF",pink:"#FF91EA",white:"#FBFBFB",lightgray:"#A3A3A3",gray:"#575757",black:"#303030"},r=["blue","green","orange","purple","red","darkblue","darkpurple","lightblue","lightgreen","beige","pink","lightred"];L.Track=L.Evented.extend({options:{map:void 0},initialize:function(t){L.setOptions(this,t),this.Lmap=this.options.map.map("getMap"),this.$map=this.options.map,this.currentColor=0,this.markersLength=0},getCurrentColor:function(){return this.currentColor},nextColor:function(){return this.currentColor=(this.currentColor+1)%r.length,this.currentColor},lengthOfMarkers:function(){return this.markersLength},hasMarkers:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.markersLength>=t},hasRoutes:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.markersLength-1>=t},isImport:function(){return this.hasRoutes()&&"import"==this.getFirstMarker().getRouteModeFromHere()},getBounds:function(){var t=L.latLngBounds(this.getFirstMarker(0).getLatLng(),this.getLastMarker().getLatLng());return this.eachRoute(function(e,n){t.extend(n.getBounds())}),t},getFirstMarker:function(){return this.firstMarker},getLastMarker:function(){return this.lastMarker},isLoop:function(){return!!this.firstMarker&&!!this.lastMarker&&this.firstMarker.getLatLng().distanceTo(this.lastMarker.getLatLng())<10},clear:function(){this.eachMarker(function(t,e){e.remove(!1)}),this.fire("markerschanged")},eachMarker:function(t){for(var e=this.firstMarker,n=0;e;){var o=e._nextMarker;t.call(e,n,e),e=o,n++}},eachRoute:function(t){for(var e=this.firstMarker,n=0;e;){var o=e.getRouteFromHere();o&&(t.call(o,n,o),n++),e=e._nextMarker}},addMarker:function(e){var n,o=this,a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this;return void 0===this.firstMarker&&(this.firstMarker=e),void 0!==this.lastMarker&&a&&(n=this.lastMarker.computeRouteTo(e,this.$map.map("getMode"))),this.lastMarker=e,this.markersLength++,e.track=this,e.addTo(this.Lmap),n?n.done(function(){return o.fire("markerschanged")}):t.Deferred(function(){i.fire("markerschanged"),this.resolve()})},moveMarker:function(e){var n=this;return t.Deferred(function(){var o=this,a=[];if(e.hasRouteFromHere()){a.length;a.push(e.recomputeRouteFromHere(n.$map.map("getMode")))}if(e.hasRouteToHere()){a.length;a.push(e.recomputeRouteToHere(n.$map.map("getMode")))}t.when.apply(t,a).done(function(){n.fire("markerschanged"),o.resolve()}).fail(o.fail)})},insertMarker:function(e,n){var o=this;return t.Deferred(function(){var a=this,i=[];i.push(n.getStartMarker().computeRouteTo(e,o.$map.map("getMode"))),i.push(e.computeRouteTo(n.getEndMarker(),o.$map.map("getMode"))),o.markersLength++,e.addTo(o.Lmap),t.when.apply(t,i).done(function(){o.fire("markerschanged"),a.resolve()}).fail(a.fail)})},_initStats:function(){return{distance:0,altMin:Number.MAX_VALUE,altMax:Number.MIN_VALUE,denivPos:0,denivNeg:0}},computeStats:function(){var t=this,e=[],n=[],o=this._initStats(),a=this._initStats();if(this.eachMarker(function(i,r){if("step"==r.getType()){e.push(o.distance);for(var s=r;s&&s.hasRouteToHere()&&(s.getRouteToHere().setPopupContentWith(s._previousMarker.getColorCode(),a,"import"!=s._previousMarker.getRouteModeFromHere()),"step"!=(s=s._previousMarker).getType()););a=t._initStats()}var l=r.getRouteFromHere(),c=l?l.getElevations():[];if(c.length>0){for(var u=0;u<c.length;u++)c[u].dist+=o.distance,c[u].route=l;n=n.concat(c),o.distance+=l.getDistance(),o.altMin=Math.min(o.altMin,l.getAltMin()),o.altMax=Math.max(o.altMax,l.getAltMax()),o.denivNeg+=l.getDenivNeg(),o.denivPos+=l.getDenivPos(),a.distance+=l.getDistance(),a.altMin=Math.min(a.altMin,l.getAltMin()),a.altMax=Math.max(a.altMax,l.getAltMax()),a.denivNeg+=l.getDenivNeg(),a.denivPos+=l.getDenivPos()}}),a.distance>0)for(var i=this.getLastMarker();i&&i.hasRouteToHere()&&(i.getRouteToHere().setPopupContentWith(i._previousMarker.getColorCode(),a,"import"!=i._previousMarker.getRouteModeFromHere()),"step"!=(i=i._previousMarker).getType()););return{size:n.length,elevations:n,total:o,steps:e}},exportGpx:function(e){var n=!1;try{n=!!new Blob}catch(t){}if(!n)return!1;var o='<?xml version="1.0"?>\n';o+='<gpx creator="map2gpx.fr" version="1.0" xmlns="http://www.topografix.com/GPX/1/1"',o+=' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',o+=' xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n',o+="    <trk>\n",o+="        <name>"+e+"</name>\n",o+="        <trkseg>\n",this.eachMarker(function(n,a){a.hasRouteFromHere()&&("step"==a.getType()&&(o+="        </trkseg>\n",o+="    </trk>\n",o+="    <trk>\n",o+="        <name>"+e+"-"+n+"</name>\n",o+="        <trkseg>\n"),t.each(a.getRouteFromHere().getLatLngsFlatten(),function(e,n){o+='            <trkpt lat="'+n.lat+'" lon="'+n.lng+'">',t.Cache.hasAltitude(n)&&(o+="<ele>"+t.Cache.getAltitude(n)+"</ele>"),o+="</trkpt>\n"}))}),o+="        </trkseg>\n",o+="    </trk>\n",o+="</gpx>\n";var a=new Blob([o],{type:"application/gpx+xml;charset=utf-8"});return saveAs(a,e+".gpx"),!0},exportKml:function(e){var n=!1;try{n=!!new Blob}catch(t){}if(!n)return!1;var o='<?xml version="1.0" encoding="UTF-8"?>\n';o+='<kml xmlns="http://www.opengis.net/kml/2.2"',o+=' xmlns:gx="http://www.google.com/kml/ext/2.2"',o+=' xmlns:kml="http://www.opengis.net/kml/2.2"',o+=' xmlns:atom="http://www.w3.org/2005/Atom">\n',o+="    <Document>\n",o+="        <name>"+e+".kml</name>\n",o+="        <Placemark>\n",o+="            <name>"+e+"</name>\n",o+="            <LineString>\n",o+="                <tessellate>1</tessellate>\n",o+="                <coordinates>\n",o+="                    ",this.eachMarker(function(n,a){a.hasRouteFromHere()&&("step"==a.getType()&&(o+="\n                </coordinates>\n",o+="            </LineString>\n",o+="        </Placemark>\n",o+="        <Placemark>\n",o+="            <name>"+e+"-"+n+"</name>\n",o+="            <LineString>\n",o+="                <tessellate>1</tessellate>\n",o+="                <coordinates>\n",o+="                    "),t.each(a.getRouteFromHere().getLatLngsFlatten(),function(t,e){o+=e.lng+","+e.lat+",0 "}))}),o+="\n                </coordinates>\n",o+="            </LineString>\n",o+="        </Placemark>\n",o+="    </Document>\n",o+="</kml>\n";var a=new Blob([o],{type:"text/plain;charset=utf-8"});return saveAs(a,e+".kml"),!0},importGpx:function(e,n){var o=this;return t.Deferred(function(){var a=this,i=new FileReader;i.onload=function(e){var i=[];new L.GPX(e.target.result,{async:!0,onFail:function(){a.rejectWith({error:"Impossible de traiter ce fichier"})},onSuccess:function(e){a.notify({step:"Fichier traité"}),a.notify({start:!0,total:i.length,status:n?"Interpolation en cours...":"Traitement en cours..."}),o.clear();var r=e.getBounds();o.Lmap.fitBounds(r,{padding:[50,50]});var s=[],l=[];t.each(i,function(e,i){if(n){var r=i.getLatLngsFlatten();a.notify({start:!0,total:r.length}),s.push(L.polyline_interpolate(r).progress(function(t){a.notify({count:t.count,step:t.count+" points trouvés"}),t.line.prepareForMap(o.Lmap,null,null),t.line.setStyle({weight:5,color:"#81197f",opacity:.5,snakingPause:0,snakingSpeed:1e3}),t.line.addTo(o.Lmap),l.push(t.line.computeStats().progress(a.notify))}))}else i.prepareForMap(o.Lmap,null,null),i.setStyle({weight:5,color:"#81197f",opacity:.5,snakingPause:0,snakingSpeed:1e3}),i.addTo(o.Lmap),s.push(t.Deferred(function(){this.resolve([{line:i,mode:"import"}])})),l.push(i.computeStats().progress(a.notify))}),t.when.apply(t,s).done(function(){for(var e,i=arguments,r=0;r<arguments.length;r++)!function(a){var r=i[a],s=r.length;t.each(r,function(t,a){var i=a.line.getLatLngsFlatten();if(void 0===e){var r=i[0];e=L.Marker.routed(r,{riseOnHover:!0,draggable:n,opacity:.5,color:o.getCurrentColor(),type:"waypoint"}),n?e.add(o,!1):o.addMarker(e,!1)}var l=i[i.length-1],c=L.Marker.routed(l,{riseOnHover:!0,draggable:n,opacity:.5,color:t==s-1?o.nextColor():o.getCurrentColor(),type:t==s-1?"step":"waypoint"});n?c.add(o,!1):o.addMarker(c,!1),a.line.prepareForMap(o.Lmap,e,c),a.line.setStyle({weight:5,color:e.getColorRgb(),opacity:.5}),a.line.bindPopup("Calculs en cours..."),e.attachRouteFrom(c,a.line,a.mode),e=c})}(r);t.when.apply(t,l).done(function(){o.eachRoute(function(t,e){e.setStyle({opacity:.75})}),o.eachMarker(function(t,e){e.setOpacity(1)}),o.fire("markerschanged"),a.resolve()}).fail(function(){a.rejectWith({error:"Impossible de récupérer les données géographiques de ce parcours"})})}).fail(function(){a.rejectWith({error:"Impossible d'interpoler ce parcours"})})}}).on("addline",function(t){i.push(t.line)})},i.readAsText(e)})},_removeMarker:function(t){this.firstMarker===t&&(this.firstMarker=t._nextMarker),this.lastMarker===t&&(this.lastMarker=t._previousMarker),this.markersLength--}}),L.track=function(t){return new L.Track(t)},L.Marker.Routed=L.Marker.extend({options:{type:"waypoint",color:0},initialize:function(t,e){L.Marker.prototype.initialize.call(this,t,e),L.setOptions(this,e),this.setType(this.options.type)},getColorCode:function(){return r[this.options.color]},getColorRgb:function(){return i[r[this.options.color]]},getColorIndex:function(){return this.options.color},setColorIndex:function(t){this.options.color=t,this.setType(this.options.type),this.routeFrom&&this.routeFrom.setStyle({color:this.getColorRgb()})},getType:function(){return this.options.type},setType:function(t){this.options.type=t,"waypoint"==t?this.setIcon(L.AwesomeMarkers.icon({icon:"circle",markerColor:this.getColorCode(),prefix:"fa"})):this.setIcon(L.AwesomeMarkers.icon({icon:"asterisk",markerColor:this.getColorCode(),prefix:"fa"}))},promoteToStep:function(){for(var t=this.track.nextColor(),e=this;e&&"step"!=e.options.type;)e.setColorIndex(t),e=e._nextMarker;this.setType("step"),this.track.fire("markerschanged")},demoteToWaypoint:function(){if(this.setType("waypoint"),this.hasRouteToHere())for(var t=this._previousMarker.getColorIndex(),e=this;e&&"step"!=e.options.type;)e.setColorIndex(t),e=e._nextMarker;this.track.fire("markerschanged")},hasRouteToHere:function(){return this._previousMarker&&this._previousMarker.hasRouteFromHere()},getRouteToHere:function(){return this._previousMarker.routeFrom},hasRouteFromHere:function(){return!!this.routeFrom},getRouteFromHere:function(){return this.routeFrom},getRouteModeFromHere:function(){return this._mode},deleteRouteFromHere:function(){this._nextMarker&&(this._nextMarker._previousMarker=void 0),this.routeFrom&&this.routeFrom.remove(),this.attachRouteFrom(void 0,null,void 0)},computeRouteTo:function(n,o){var a=this;return t.Deferred(function(){var i=this;a.routeFrom&&a.routeFrom.setStyle({opacity:.5}),t(a).clearCompute(),t(a).startCompute(function(r){o=o||a._mode||"auto",e(t("#map").map("getMap"),a,n,0,o).progress(t.Queue.notify).done(function(){a.deleteRouteFromHere(),a.attachRouteFrom(n,this.route,o),i.resolve()}).fail(i.reject).always(function(){return t(a).endCompute(r)})})})},recomputeRouteFromHere:function(t){return this.computeRouteTo(this._nextMarker,t)},recomputeRouteToHere:function(t){return this._previousMarker.computeRouteTo(this,t)},attachRouteFrom:function(t,e,n){this._nextMarker=t,t&&(t._previousMarker=this),this.routeFrom=e,this._mode=n},_bindEvents:function(){var e=this;this.bindPopup('<button class="marker-promote-button"><i class="fa fa-asterisk" aria-hidden="true"></i> Marquer comme étape</button> <button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>'),this.on("popupopen",function(){t(".marker-delete-button:visible").click(function(){e.remove()}),t(".marker-promote-button:visible").click(function(){e.closePopup(),e.setPopupContent('<button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>'),e.promoteToStep()})}),this.on("moveend",function(t){e.setOpacity(.5),e.track.moveMarker(e).done(function(){return e.setOpacity(1)})})},add:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.track=t,this._bindEvents(),this.track.addMarker(this,e)},insert:function(e){return this.track=t("#map").map("getTrack"),this._bindEvents(),this.track.insertMarker(this,e)},remove:function(){var e,n=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];"step"==this.options.type&&n&&this.demoteToWaypoint();var o=this._previousMarker,a=this._nextMarker;if(this.track._removeMarker(this),this.routeFrom&&this.deleteRouteFromHere(),o&&(o.deleteRouteFromHere(),a))if(o.getLatLng().equals(a.getLatLng()))o.attachRouteFrom(a,null,void 0),e="step"==o.options.type?a.remove(n):o.remove(n);else if(n){var i=this.track.$map.map("getMode")||this._mode||"auto";e=o.computeRouteTo(a,i)}return L.Marker.prototype.remove.call(this),this.track.fire("markerschanged"),e||t.Deferred(function(){this.resolve()})}}),L.Marker.routed=function(t,e){return new L.Marker.Routed(t,e)}}(jQuery),function(t){t.widget("map2gpx.map",{options:{leafletOptions:{},controls:{searchEngine:{show:!0,leafletOptions:{displayAdvancedSearch:!1}},minimap:{show:!0,leafletOptions:{position:"bottomleft",zoomLevelOffset:-4}},layerSwitcher:{show:!0,leafletOptions:{collapsed:!1}},scale:{show:!0,leafletOptions:{imperial:!1,position:"bottomright"}},help:{show:!0}}},getMap:function(){return this.map},getTrack:function(){return this.track},getMode:function(){return this.mode},_buildEventData:function(){return{mode:this.mode}},_setMode:function(t){this.mode=t,this._trigger("modechanged",null,this._buildEventData())},_onCreated:function(){var e=this;this.element.on("mapmodechanged",function(t){e.map.doubleClickZoom.setEnabled(null===e.mode)}),this.map.on("dblclick",function(t){return e._addMarker.call(e,t)}),this._initializeLayers(),this.options.controls.searchEngine.show&&this._initializeSearchEngine(),this.options.controls.minimap.show&&this._initializeMinimap(),this.options.controls.layerSwitcher.show&&this._initializeLayerSwitcher(),this.options.controls.scale.show&&this._initializeScale(),this._initializeTraceButtons(),this._initializeExportButtons(),this._initializeImportButtons(),this._initializeHelpButtons(),this._trigger("created",null,{}),this._trigger("statechanged",null,this._buildEventData()),t.when.apply(t,this.layers.promises).done(function(){e._trigger("loaded",null,{})})},_initializeLayers:function(){var e=this,n=this;this.layers.photos=L.geoportalLayer.WMTS({layer:"ORTHOIMAGERY.ORTHOPHOTOS",apiKey:keyIgn}).addTo(this.map),this.layers.promises.push(t.Deferred(function(){n.layers.photos.once("load",this.resolve)})),this.layers.slopes=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.SLOPES.MOUNTAIN",apiKey:keyIgn},{opacity:.25}).addTo(this.map),this.layers.maps=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn},{opacity:.25}).addTo(this.map),this.layers.promises.push(t.Deferred(function(){n.layers.maps.once("load",this.resolve)}));var o=void 0;this.map.on("zoomend",function(){var n=e.map.getZoom(),a=void 0,i=void 0;e.map.hasLayer(e.layers.photos)&&(e.layers.photos.options.minZoom>n||e.layers.photos.options.maxZoom<n)?(a="Photographies aériennes",i=t(".GPlayerSwitcher_layer:eq(2)")):e.map.hasLayer(e.layers.maps)&&(e.layers.maps.options.minZoom>n||e.layers.maps.options.maxZoom<n)?(a="Cartes IGN",i=t(".GPlayerSwitcher_layer:eq(0)")):e.map.hasLayer(e.layers.slopes)&&(e.layers.slopes.options.minZoom>n||e.layers.slopes.options.maxZoom<n)&&(a="Carte des pentes",i=t(".GPlayerSwitcher_layer:eq(1)")),void 0!==a&&void 0===o?((o=new Drop({target:i[0],classes:"drop-theme-arrows",position:"left middle",constrainToWindow:!1,constrainToScrollParent:!1,openOn:null,content:"La couche &quot;"+a+"&quot; n'est pas disponible à ce niveau de zoom"})).open(),t(o.content).on("click",function(){o.destroy(),o=null})):void 0===a&&void 0!==o&&null!==o&&(o.destroy(),o=null)})},_initializeSearchEngine:function(){L.geoportalControl.SearchEngine(this.options.controls.searchEngine.leafletOptions).addTo(this.map)},_initializeMinimap:function(){var e=this;this.layers.minimap=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn}),this.layers.promises.push(t.Deferred(function(){e.layers.minimap.once("load",this.resolve)})),new L.Control.MiniMap(this.layers.minimap,this.options.controls.minimap.leafletOptions).addTo(this.map)},_initializeLayerSwitcher:function(){var e=L.geoportalControl.LayerSwitcher(this.options.controls.layerSwitcher.leafletOptions);this.map.addControl(e),e.setVisibility(this.layers.slopes,!1),t(".GPlayerRemove").remove()},_initializeScale:function(){L.control.scale(this.options.controls.scale.leafletOptions).addTo(this.map)},_initializeTraceButtons:function(){var t=this,e=L.easyButton({id:"btn-autotrace",states:[{stateName:"loaded",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(e,n){return t._setMode("auto")}},{stateName:"active",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(e,n){return t._setMode(null)}}]});this.element.on("mapmodechanged mapstatechanged",function(n){"auto"==t.mode?(e.state("active"),e.enable()):(e.state("loaded"),e.setEnabled(!t.track.isImport()))});var n=L.easyButton({id:"btn-straighttrace",states:[{stateName:"loaded",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(e,n){return t._setMode("straight")}},{stateName:"active",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(e,n){return t._setMode(null)}}]});this.element.on("mapmodechanged mapstatechanged",function(e){"straight"==t.mode?(n.state("active"),n.enable()):(n.state("loaded"),n.setEnabled(!t.track.isImport()))});var o=L.easyButton({id:"btn-closeloop",states:[{stateName:"loaded",icon:"fa-magic",title:"Fermer la boucle",onClick:function(e,n){t.track.hasMarkers(1)&&t._addMarker({latlng:t.track.getFirstMarker().getLatLng()})}}]});this.element.on("mapmodechanged mapcomputingchanged mapstatechanged",function(e){o.setEnabled(null!==t.mode&&t.track.hasRoutes()&&!t.track.isImport()&&!t.track.isLoop())}),L.easyBar([e,n,o]).addTo(this.map)},_initializeExportButtons:function(){var e=this,n=this,o=L.popup().setContent(L.DomUtil.get("form-export")),a=L.easyButton({id:"btn-export",states:[{stateName:"loaded",icon:"fa-cloud-download",title:"Exporter",onClick:function(t,n){var a=e.track.getBounds();e.map.flyToBounds(a,{padding:[50,50]}),o.setLatLng(a.getCenter()).openOn(e.map)}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Exporter (calcul en cours...)"}]}).addTo(this.map);t("#export-gpx-button").click(function(){var e=t(this);e.attr("disabled","disabled"),n.track.exportGpx(t("#export-filename").val()),e.removeAttr("disabled")}),t("#export-kml-button").click(function(){var e=t(this);e.attr("disabled","disabled"),n.track.exportKml(t("#export-filename").val()),e.removeAttr("disabled")}),this.element.on("mapcomputingchanged mapstatechanged",function(t){t.computing?(a.state("computing"),a.disable()):(a.state("loaded"),a.setEnabled(e.track.hasRoutes()))})},_initializeImportButtons:function(){var e=this,n=this,o=L.popup().setContent(L.DomUtil.get("form-import")),a=L.easyButton({id:"btn-import",states:[{stateName:"loaded",icon:"fa-cloud-upload",title:"Importer",onClick:function(n,a){o.setLatLng(e.map.getCenter()).openOn(e.map),e.track.hasRoutes()?t("#import-gpx-status").html("<strong>Attention:</strong> l'import va effacer l'itinéraire existant!"):t("#import-gpx-status").text("")}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Importer (calcul en cours...)"}]});t("#import-gpx-button").click(function(){var e=t(this),a=t("#import-gpx-file")[0].files[0],i=t("#import-gpx-interpolate").is(":checked");void 0!=a?(e.attr("disabled","disabled"),t("body").startCompute(function(r){t.Queue.notify({start:!0,total:1,status:"Importation en cours..."}),n.track.importGpx(a,i).done(function(){e.removeAttr("disabled"),n._setMode(null)}).fail(function(){t("#import-gpx-status").text(this.error),e.removeAttr("disabled")}).progress(function(e){t.Queue.notify(e),o.isOpen()&&n.map.closePopup()}).always(function(){return t("body").endCompute(r)})})):t("#import-gpx-status").text("Veuillez sélectionner un fichier")});var i=L.easyButton({id:"btn-reset",states:[{stateName:"loaded",icon:"fa-trash",title:"Effacer l'itinéraire",onClick:function(t,n){e.track.clear()}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Effacer l'itinéraire (calcul en cours...)"}]});L.easyBar([a,i]).addTo(this.map),this.element.on("mapcomputingchanged mapstatechanged",function(t){a.state(e.computing?"computing":"loaded"),i.state(e.computing?"computing":"loaded"),a.setEnabled(!e.computing),i.setEnabled(!e.computing&&e.track.hasMarkers())})},_initializeHelpButtons:function(){var e=this,n=L.popup().setContent(L.DomUtil.get("about")),o=L.easyButton({position:"bottomright",states:[{icon:"fa-info-circle",onClick:function(t,o){n.setLatLng(e.map.getCenter()).openOn(e.map)},title:"A propos & crédits"}]}),a=L.easyButton({position:"bottomright",states:[{icon:"fa-question-circle",onClick:function(e,n){t.Shepherd.get(0).start(!0)},title:"Aide"}]});L.easyBar([o,a],{position:"bottomright"}).addTo(this.map)},_create:function(){var t=this;this.element.uniqueId(),this.layers={},this.layers.promises=[],this.mode=null,this.map=L.map(this.element.attr("id"),this.options.leafletOptions),this.track=L.track({map:this.element}),this.track.on("markerschanged",function(){return t._trigger("statechanged",null,t._buildEventData())}),this.map.initView().done(function(){return t._onCreated()})},_addMarker:function(t){if(null!==this.mode){var e=L.Marker.routed(t.latlng.roundE8(),{riseOnHover:!0,draggable:!0,opacity:.5,color:this.track.hasMarkers()?this.track.getLastMarker().getColorIndex():this.track.getCurrentColor(),type:"waypoint"});this.track.hasMarkers()&&this.track.getLastMarker().getLatLng().equals(e.getLatLng())||e.add(this.track).done(function(){e.setOpacity(1)})}}})}(jQuery);var isSmallScreen=window.innerWidth<=800&&window.innerHeight<=600;showLoadingMessage("Observation des faucons crécerelle..."),isSmallScreen&&$("#mobile-warning").show().find("button").click(function(){$("#mobile-warning").hide()}),window.onload=function(){try{showLoadingMessage("Localisation des chamois..."),$("#data-computing").progress().on("progressstatechanged",function(e,n){n.started?$("#data-computing").fadeIn():($("#data").data("map2gpx-chart").replot(t.map("getTrack").computeStats()),$("#data-computing").fadeOut())}),$.Queue.bindTo($("#data-computing"));var t=$("#map").map({controls:{minimap:{show:!isSmallScreen},layerSwitcher:{leafletOptions:{collapsed:isSmallScreen}},scale:{show:!isSmallScreen},help:{show:!isSmallScreen}},created:function(){showLoadingMessage("Suivi des renards roux..."),isSmallScreen||$.Shepherd.tour().add("welcome",{text:$("#help-welcome")[0]}).add("layers",{text:$("#help-layers")[0],attachTo:{element:$(".GPlayerName").closest(".GPwidget")[0],on:"left"}}).add("search",{text:$("#help-search")[0],attachTo:{element:$(".GPshowAdvancedToolOpen").closest(".GPwidget")[0],on:"right"}}).add("autotrace",{text:$("#help-autotrace")[0],attachTo:{element:$("#btn-autotrace")[0],on:"right"}}).add("straighttrace",{text:$("#help-straighttrace")[0],attachTo:{element:$("#btn-straighttrace")[0],on:"right"}}).start()},loaded:function(){showLoadingMessage("Alignement des satellites..."),clearInterval(interval),$("#loading").fadeOut()}}).on("mapmarkerschanged",function(e){isSmallScreen||(t.map("getTrack").hasMarkers(2)&&!$.Shepherd.has(1)&&$.Shepherd.tour().add("data",{text:$("#help-data")[0],attachTo:{element:$("#data")[0],on:"top"}}).add("closeloop",{text:$("#help-closeloop")[0],attachTo:{element:$("#btn-closeloop")[0],on:"right"}}).add("export",{text:$("#help-export")[0],attachTo:{element:$("#btn-export")[0],on:"right"}}).start(),t.map("getTrack").hasMarkers(3)&&!$.Shepherd.has(2)&&$.Shepherd.tour().add("movemarker",{text:$("#help-movemarker")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).add("movemarker2",{text:$("#help-movemarker2")[0],attachTo:{element:$(".awesome-marker").eq(-2)[0],on:"bottom"}}).add("steps",{text:$("#help-steps")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).add("steps2",{beforeShowPromise:function(){return $.Deferred(function(){var e=t.map("getTrack").getFirstMarker().getRouteFromHere(),n=e.getLatLngsFlatten(),o=n[Math.floor(n.length/2)];e.openPopup(o),this.resolve()}).promise()},text:$("#help-steps2")[0]}).start())}).on("mapstatechanged",function(e){$("#data").data("map2gpx-chart").replot(t.map("getTrack").computeStats())});$("#data").chart({map:t.map("getMap"),dataEmpty:"#data-empty",isSmallScreen:isSmallScreen})}catch(t){gotError=!0,console.log("Got exception",t),$("#loading").animate({backgroundColor:"#A23336",color:"#FFFFFF"}),$("#loading h2 i.fa").removeClass("fa-spinner fa-pulse").addClass("fa-bug"),$("#loading h2 span").html("Une erreur s'est produite: &quot;"+t+"&quot;."),$("#loading h3").html($('<div>N\'hésitez pas à ouvrir un ticket sur <a href="https://github.com/tmuguet/map2gpx" target="_blank" rel="noopener noreferrer">Github</a> ou à m\'envoyer un mail à <a href="mailto:hi@tmuguet.me">hi@tmuguet.me</a>.</div>').hide().slideDown()),clearInterval(interval)}};