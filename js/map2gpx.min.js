"use strict";function fetchAltitude(t){return $.Deferred(function(){var e=this,o={apiKey:keyIgn,sampling:t.length,positions:t,onSuccess:function(t){t?($.each(t.elevations,function(t,e){$.Cache.addAltitude(e.lat,e.lon,e.z)}),e.resolveWith({size:t.elevations.length})):(console.log("Impossible d'obtenir les données d'altitude: résultats invalides"),e.reject())},onFailure:function(t){console.log("Impossible d'obtenir les données d'altitude: ",t.message),e.reject()}};Gp.Services.getAltitude(o)})}function fetchSlope(t,e,o){return $.Deferred(function(){var n=this,a={tilematrix:16,tilerow:e,tilecol:t,lon:"",lat:"",x:"",y:""};$.each(o,function(t,e){t>0&&(a.lon+="|",a.lat+="|",a.x+="|",a.y+="|"),a.lon+=e.lng.toString(),a.lat+=e.lat.toString(),a.x+=e.x.toString(),a.y+=e.y.toString()}),$.getJSON("slope.php",a,function(t){t.results?($.each(t.results,function(t,e){$.Cache.addSlope(e.lat,e.lon,e.slope)}),n.resolveWith({size:t.results.length})):(console.log("Impossible d'obtenir les données de pente: résultats invalides"),n.reject())}).fail(function(t,e,o){console.log("Impossible d'obtenir les données de pente: ",e,o),n.reject()})})}!function(t){var e=function(t){var e;try{var o="__storage_test__";return(e=window[t]).setItem(o,o),e.removeItem(o),!0}catch(t){return t instanceof DOMException&&(22===t.code||1014===t.code||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name)&&0!==e.length}}("localStorage");t.localStorage={get:function(t){return e?localStorage.getItem(t):null},getAsJSON:function(t){return e&&null!==localStorage.getItem(t)?JSON.parse(localStorage.getItem(t)):null},set:function(t,o){e&&localStorage.setItem(t,o)},setAsJSON:function(t,e){this.set(t,JSON.stringify(e))}}}(jQuery),jQuery.QueryString=function(t){for(var e={},o=0;o<t.length;++o){var n=t[o].split("=",2);2===n.length&&(e[n[0]]=decodeURIComponent(n[1].replace(/\+/g," ")))}return e}(window.location.search.substr(1).split("&")),function(t){var e=[];t.Shepherd={},t.Shepherd.Step=function(){var e,o;return{init:function(n,a){return e=n,o=t.extend({},a,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"}),this}}},t.Shepherd.step=function(e,o){return t.Shepherd.Step().init(e,o)},t.Shepherd.Tour=function(){var o,n=0;return{init:function(e){var n=t.extend({},e,{defaults:{classes:"shepherd-element shepherd-open shepherd-theme-arrows",showCancelLink:!0}});return o=new Shepherd.Tour(n),this},add:function(a,i){var r=this,s=n,l=t.extend({},i,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"});return l.buttons=[{text:"Fermer",classes:"shepherd-button-secondary",action:function(){t.localStorage.set("tutorial"+e.indexOf(r),-1),r.cancel()}},{text:"Suivant",classes:"shepherd-button-example-primary",action:function(){var o=e.indexOf(r);o<0&&console.log("Could not find current shepherd, something is probably wrong"),t.localStorage.set("tutorial"+o,s+1),r.next(),s==n-1&&o>=0&&o<e.length-1&&e[o+1].start(!0)}}],o.addStep(a,l),n++,this},start:function(){var a=0;if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])){var i=e.indexOf(this);null!==t.localStorage.get("tutorial"+i)&&(a=parseInt(t.localStorage.get("tutorial"+i)))}return a>=0&&a<n&&o.show(a),this},cancel:function(){return o.cancel(),this},next:function(){return o.next(),this}}},t.Shepherd.tour=function(o){var n=t.Shepherd.Tour().init(o);return e.push(n),n},t.Shepherd.get=function(t){return e[t]},t.Shepherd.has=function(t){return e.length>t}}(jQuery),Math.roundE8=function(t){return Math.round(t*Math.pow(10,8))/Math.pow(10,8)},Math.radians=function(t){return t*Math.PI/180},Math.degrees=function(t){return 180*t/Math.PI},L.LatLng.prototype.roundE8=function(){return L.latLng(Math.roundE8(this.lat),Math.roundE8(this.lng))},L.LatLng.prototype.toTilePixel=function(t,e,o,n){var a=t.latLngToPoint(this,e).floor(),i=a.divideBy(o).floor(),r=i.multiplyBy(o).subtract(n);return{tile:i,tilePixel:a.subtract(n).subtract(r)}},L.LatLng.prototype.getDestinationAlong=function(t,e){var o=6378137,n=Math.radians(t),a=Math.radians(this.lat),i=Math.radians(this.lng),r=Math.asin(Math.sin(a)*Math.cos(e/o)+Math.cos(a)*Math.sin(e/o)*Math.cos(n)),s=i+Math.atan2(Math.sin(n)*Math.sin(e/o)*Math.cos(a),Math.cos(e/o)-Math.sin(a)*Math.sin(r));return r=Math.degrees(r),s=Math.degrees(s),L.latLng(Math.roundE8(r),Math.roundE8(s))},L.LatLng.prototype.bearingTo=function(t){var e=Math.radians(this.lat),o=Math.radians(this.lng),n=Math.radians(t.lat),a=Math.radians(t.lng),i=Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(e/2+Math.PI/4)),r=a-o;return Math.abs(r)>Math.PI&&(r=r>0?-(2*Math.PI-r):2*Math.PI+r),(Math.degrees(Math.atan2(r,i))+360)%360},L.Handler.include({setEnabled:function(t){t?this.enable():this.disable()}}),L.Control.EasyButton.include({setEnabled:function(t){t?this.enable():this.disable()}}),function(t){var e=0,o=[];t.fn.clearCompute=function(){return this.each(function(){e-=t(this).queue().length,t(this).clearQueue(),t.Queue.stop()})},t.fn.startCompute=function(o){return this.each(function(){t.Queue.start(),e++,t(this).queue(o)})},t.fn.endCompute=function(o){return this.each(function(){e--,o(),t.Queue.stop()})},t.Queue={size:function(){return e},bindTo:function(t){return o.push(t)},start:function(){0==e&&t.each(o,function(){this.progress("start")})},stop:function(){0==e&&t.each(o,function(){this.progress("stop")})},notify:function(e){t.each(o,function(){this.progress("update",e)})}}}(jQuery),function(t){t.widget("map2gpx.progress",{options:{progress:0,total:0,started:!1},_create:function(){this.element.append('<h2><i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i><br/><strong><span class="data-computing-progress"></span> <small>- <span class="data-computing-status">Calculs en cours...</span></small></strong><div class="data-computing-progressbar-container"><div class="data-computing-progressbar"></div></div></h2>'),this.$h2=this.element.find("h2"),this.$progress=this.element.find(".data-computing-progress"),this.$progressbar=this.element.find(".data-computing-progressbar"),this.$status=this.element.find(".data-computing-status"),this.options.started&&this.start()},_buildEventData:function(){return{started:this.options.started}},start:function(){this.options.started||(this.options.progress=0,this.options.total=0),this.options.started=!0,this.update({start:!0,total:1,status:"Calculs en cours..."}),this._trigger("statechanged",null,this._buildEventData()),this._trigger("started",null,{})},stop:function(){this.options.started=!1,this.update({end:!0,status:"Finalisation..."}),this._trigger("statechanged",null,this._buildEventData()),this._trigger("stopped",null,{})},started:function(t){if(void 0===t)return this.options.started;t?this.start():this.stop()},update:function(e){if(Array.isArray(e)){var o=this;t.each(e,function(){o._update(this)})}else this._update(e);this._display()},_update:function(e){e.start?this.options.total+=e.total:e.end?this.options.progress=this.options.total:this.options.progress++,"status"in e&&e.status&&this.$status.text(e.status),"step"in e&&e.step&&t("<div><small>"+e.step+"</small></div>").insertAfter(this.$h2).fadeOut(400,function(){t(this).remove()})},_display:function(){var e=1;this.options.total>0&&(e=this.options.progress/this.options.total),this.$progress.text(Math.round(100*e)+"%"),this.$progressbar.css("width",Math.round(100*e)+"%"),42==Math.round(100*e)&&t("<div><small>La grande question sur la vie, l'univers et le reste répondue</small></div>").insertAfter(this.$h2).fadeOut(400,function(){t(this).remove()})}})}(jQuery),function(t){var e={},o={};t.Cache={};var n=function(t){return t.lng+"/"+t.lat};t.Cache.addAltitude=function(t,o,n){e[o+"/"+t]=n},t.Cache.getAltitude=function(t){var o=n(t);return o in e?e[o]:null},t.Cache.hasAltitude=function(t){return n(t)in e},t.Cache.addSlope=function(t,e,n){o[e+"/"+t]=n},t.Cache.getSlope=function(t){var e=n(t);return e in o?o[e]:null},t.Cache.hasSlope=function(t){return n(t)in o},t.Cache.getInfos=function(t){var a=n(t);return{z:a in e?e[a]:null,slope:a in o?o[a]:null}}}(jQuery),L.Map.include({_bindViewEvents:function(){this.on("zoomend",function(){console.log("Zoomed to ",this.getZoom()),$.localStorage.set("view",[this.getCenter().lat,this.getCenter().lng,this.getZoom()])}),this.on("moveend",function(){console.log("Moved to ",this.getCenter()),$.localStorage.setAsJSON("view",[this.getCenter().lat,this.getCenter().lng,this.getZoom()])})},_setView:function(t){this.setView([t[0],t[1]],t[2])},initView:function(){var t=this;return $.Deferred(function(){var e=this,o=$.localStorage.getAsJSON("view")||[44.96777356135154,6.06822967529297,13];if("lat"in $.QueryString&&"lng"in $.QueryString&&(o=[$.QueryString.lat,$.QueryString.lng,15]),"loc"in $.QueryString){var n={text:$.QueryString.loc,filterOptions:{type:["StreetAddress","PositionOfInterest"]},apiKey:keyIgn,onSuccess:function(n){n&&"suggestedLocations"in n&&n.suggestedLocations.length>0?(t._setView([n.suggestedLocations[0].position.y,n.suggestedLocations[0].position.x,15]),e.resolveWith(t)):(console.log("No results?"),t._setView(o),e.resolveWith(t))},onFailure:function(n){console.log(n),t._setView(o),e.resolveWith(t)}};Gp.Services.autoComplete(n)}else t._setView(o),e.resolveWith(t)}).done(this._bindViewEvents)}}),L.Layer.include({_elevations:[],_distance:0,_altMin:0,_altMax:0,_denivPos:0,_denivNeg:0,prepareForMap:function(t,e,o){this._mapToAdd=t,this._start=e,this._end=o},getStartMarker:function(){return this._start},getEndMarker:function(){return this._end},getElevations:function(){return JSON.parse(JSON.stringify(this._elevations))},getDistance:function(){return this._distance},getAltMin:function(){return this._altMin},getAltMax:function(){return this._altMax},getDenivPos:function(){return this._denivPos},getDenivNeg:function(){return this._denivNeg},computeStats:function(){var t=this;return $.Deferred(function(){var e=this,o=t._fetchAltitude().concat(t._fetchSlope()),n=o.length;e.notify({start:!0,total:n,status:"Récupération des données géographiques..."}),$.each(o,function(){this.done(function(){e.notify({step:this.size+" points récupérés"})})}),$.when.apply($,o).fail(e.reject).then(function(){t._computeStats(),e.resolve()})})},_computeStats:function(){var t=[];if($.each(this.getLatLngs(),function(e,o){var n=$.extend({},{lat:o.lat,lng:o.lng},$.Cache.getInfos(o));t.push(n)}),0==t.length)return!1;this._distance=0,this._altMin=t[0].z,this._altMax=t[0].z,this._denivPos=0,this._denivNeg=0,t[0].dist=0,t[0].slopeOnTrack=0,this._elevations=[t[0]];for(var e=0,o=1;o<t.length;o++){var n=L.latLng(t[o]).distanceTo(L.latLng(this._elevations[e]));n>10&&(this._distance+=n/1e3,e++,this._elevations[e]=t[o],this._elevations[e].dist=this._distance,this._elevations[e].slopeOnTrack=Math.degrees(Math.atan((Math.round(this._elevations[e].z)-Math.round(this._elevations[e-1].z))/n)),this._elevations[e].z<this._altMin&&(this._altMin=this._elevations[e].z),this._elevations[e].z>this._altMax&&(this._altMax=this._elevations[e].z),this._elevations[e].z<this._elevations[e-1].z?this._denivNeg+=Math.round(this._elevations[e-1].z-this._elevations[e].z):this._denivPos+=Math.round(this._elevations[e].z-this._elevations[e-1].z))}return!0},_fetchAltitude:function(){var t=[],e=[];return $.each(this.getLatLngs(),function(o,n){$.Cache.hasAltitude(n)||(t.push({lon:n.lng,lat:n.lat}),50==t.length&&(e.push(fetchAltitude(t)),t=[]))}),t.length>0&&e.push(fetchAltitude(t)),e},_fetchSlope:function(){var t={},e=[],o=this._map||this._mapToAdd;return $.each(this.getLatLngs(),function(e,n){if(!$.Cache.hasSlope(n)){var a=n.toTilePixel(o.options.crs,16,256,o.getPixelOrigin()),i=a.tile,r=a.tilePixel;i.x in t||(t[i.x]={}),i.y in t[i.x]||(t[i.x][i.y]=[[]]),t[i.x][i.y][t[i.x][i.y].length-1].length>50&&t[i.x][i.y].push([]),t[i.x][i.y][t[i.x][i.y].length-1].push({lat:n.lat,lng:n.lng,x:r.x,y:r.y})}}),$.each(t,function(t,o){$.each(o,function(o,n){$.each(n,function(n,a){e.push(fetchSlope(t,o,a))})})}),e},setPopupContentWith:function(t,e){var o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.setPopupContent('<ul class="legend '+t+'"><li>Altitude max: '+Math.round(e.altMax)+"m</li><li>D+: "+Math.round(e.denivPos)+"m</li><li>Altitude min: "+Math.round(e.altMin)+"m</li><li>D-: "+Math.round(e.denivNeg)+"m</li><li>Distance: "+Math.round(100*e.distance)/100+"km</li></ul>"+(o?'<button class="marker-add-button"><i class="fa fa-plus" aria-hidden="true"></i> Ajouter un marqueur ici</button>':""))}}),L.GeoJSON.include({getLatLngs:function(){var t=[];return this.eachLayer(function(e){$.each(e.feature.geometry.coordinates,function(e,o){t.push(L.latLng(o[1],o[0]))})}),t}}),function(t){t.widget("map2gpx.chart",{options:{map:void 0,dataEmpty:"#data-empty",isSmallScreen:!1,showMarker:!0,plotMarkerOptions:{icon:L.AwesomeMarkers.icon({icon:"area-chart",markerColor:"cadetblue",prefix:"fa"}),draggable:!1,clickable:!1,zIndexOffset:1e3},showSlope:!0,showTerrainSlope:!0},_create:function(){var e=this;if(void 0===this.options.map)throw'"map" option cannot be undefined';if(this.$emptyElement=t(this.options.dataEmpty),!this.options.isSmallScreen){this.$chart=t('<canvas width="100%" height="100%"></canvas>').appendTo(this.element);var o=[{label:"Altitude",data:[],fill:!1,borderColor:"rgba(12, 98, 173, 0.8)",backgroundColor:"rgba(12, 98, 173, 0.8)",lineTension:0,pointRadius:0,yAxisId:"alt"}],n=[{id:"alt",type:"linear",position:"left",beginAtZero:!1}];this.options.showSlope&&(this.slopeIdx=o.length,o.push({label:"Pente de l'itinéraire",data:[],fill:!0,pointRadius:0,yAxisID:"slope"}),n.push({id:"slope",type:"linear",position:"right"})),this.options.showTerrainSlope&&(this.slopeTerrainIdx=o.length,o.push({label:"Pente du terrain",data:[],fill:!0,pointRadius:0,yAxisID:"slope2",hidden:!0}),n.push({id:"slope2",type:"linear",position:"right",ticks:{min:0,max:45}}));var a={};this.options.showMarker&&(a={mode:"index",intersect:!1,onHover:function(t,o){return e._onHover(t,o)}}),this.chartjs=new Chart(this.$chart,{type:"line",data:{datasets:o},options:{maintainAspectRatio:!1,onClick:function(t,o){return e._onClick(t,o)},hover:a,scales:{xAxes:[{id:"distance",type:"linear",position:"bottom",ticks:{min:0}}],yAxes:n},legend:{position:"left"},tooltips:{mode:"index",intersect:!1,callbacks:{title:function(t,e){return"Distance: "+Math.floor(100*t[0].xLabel)/100+"km"},label:function(t,e){return e.datasets[t.datasetIndex].label+": "+(0==t.datasetIndex?Math.round(100*t.yLabel)/100+"m":Math.round(t.yLabel)+"°")}}},annotation:{annotations:[]}}})}},_onClick:function(t,e){if(e&&e.length>0){var o=e[0]._index,n=this.chartjs.config.data.datasets[0].data[o];n.route&&n.route.openPopup(L.latLng(n.lat,n.lng))}},_onHover:function(t,e){if("mousemove"==t.type)if(e&&e.length>0){var o=e[0]._index,n=this.chartjs.config.data.datasets[0].data[o];null==this.plotMarker?(this.plotMarker=L.marker(L.latLng(n.lat,n.lng),this.options.plotMarkerOptions),this.plotMarker.addTo(this.options.map)):(this.plotMarker.setLatLng(L.latLng(n.lat,n.lng)),this.plotMarker.update())}else this.plotMarker&&(this.options.map.removeLayer(this.plotMarker),this.plotMarker=null);else"mouseout"==t.type&&this.plotMarker&&(this.options.map.removeLayer(this.plotMarker),this.plotMarker=null)},_replotSmallScreen:function(t){t.size>0?this.element.html("<ul><li>Altitude max: "+Math.round(t.total.altMax)+"m; D+: "+Math.round(t.total.denivPos)+"m</li><li>Altitude min: "+Math.round(t.total.altMin)+"m; D-: "+Math.round(t.total.denivNeg)+"m</li><li>Distance: "+Math.round(100*t.elevations[t.size-1].dist)/100+"km</li></ul>"):this.element.empty()},_replotWideScreen:function(t){if(t.size>0){for(var e=[],o=[],n=[],a=0,i=0,r=0;r<t.size;r++){if(e.push({x:t.elevations[r].dist,y:t.elevations[r].z,lat:t.elevations[r].lat,lng:t.elevations[r].lng,route:t.elevations[r].route}),this.options.showSlope){var s=void 0;(s=r>3&&r<t.size-4?(t.elevations[r-3].slopeOnTrack+2*t.elevations[r-2].slopeOnTrack+4*t.elevations[r-1].slopeOnTrack+8*t.elevations[r].slopeOnTrack+4*t.elevations[r+1].slopeOnTrack+2*t.elevations[r+2].slopeOnTrack+t.elevations[r+3].slopeOnTrack)/22:t.elevations[r].slopeOnTrack)>a&&(a=s),s<i&&(i=s),o.push({x:t.elevations[r].dist,y:s})}this.options.showTerrainSlope&&n.push({x:t.elevations[r].dist,y:t.elevations[r].slope})}var l=t.size-1;if(this.chartjs.options.scales.xAxes[0].ticks.max=e[l].x,this.chartjs.config.data.datasets[0].data=e,t.annotations[0].value=t.total.altMax,t.annotations[0].label.content="Altitude max: "+Math.round(t.total.altMax)+"m; D+: "+Math.round(t.total.denivPos)+"m",t.annotations[1].value=t.total.altMin,t.annotations[1].label.content="Altitude min: "+Math.round(t.total.altMin)+"m; D-: "+Math.round(t.total.denivNeg)+"m",t.annotations[2].value=e[l].x,t.annotations[2].label.content="Distance: "+Math.round(100*e[l].x)/100+"km",this.options.showSlope){this.chartjs.config.data.datasets[this.slopeIdx].data=o;var u=this.$chart[0].getContext("2d").createLinearGradient(0,0,0,120);a=10*Math.ceil(a/10);var c=-(i=10*Math.floor(i/10))+a;0!=c&&(a>=45&&u.addColorStop((a-45)/c,"purple"),a>=40&&u.addColorStop((a-40)/c,"red"),a>=35&&u.addColorStop((a-35)/c,"orange"),a>=30&&u.addColorStop((a-30)/c,"yellow"),u.addColorStop(a/c,"grey"),i<=-30&&u.addColorStop((a+30)/c,"yellow"),i<=-35&&u.addColorStop((a+35)/c,"orange"),i<=-40&&u.addColorStop((a+40)/c,"red"),i<=-45&&u.addColorStop((a+45)/c,"purple"),this.chartjs.config.data.datasets[this.slopeIdx].backgroundColor=u)}if(this.options.showTerrainSlope){this.chartjs.config.data.datasets[this.slopeTerrainIdx].data=n;var h=this.$chart[0].getContext("2d").createLinearGradient(0,0,0,120);h.addColorStop(0,"purple"),h.addColorStop(1-40/45,"red"),h.addColorStop(1-35/45,"orange"),h.addColorStop(1-30/45,"yellow"),h.addColorStop(1,"grey"),this.chartjs.config.data.datasets[this.slopeTerrainIdx].backgroundColor=h}this.chartjs.options.annotation={},this.chartjs.update(),this.chartjs.options.annotation={annotations:t.annotations},this.chartjs.update()}else{this.chartjs.options.scales.xAxes[0].ticks.max=1;for(var p=0;p<this.chartjs.config.data.datasets.length;p++)this.chartjs.config.data.datasets[p].data=[]}},replot:function(e){e.annotations=[{id:"altmax",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:10}},{id:"altmin",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:-10}},{id:"distance",type:"line",mode:"vertical",scaleID:"distance",value:0,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",xAdjust:-50}}],t.each(e.steps,function(t,o){return e.annotations.push({id:"distance-"+t,type:"line",mode:"vertical",scaleID:"distance",value:o,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1})}),isSmallScreen?this._replotSmallScreen(e):this._replotWideScreen(e),e.size>0?this.$emptyElement.slideUp():this.$emptyElement.slideDown()}})}(jQuery),function(t){function e(e,o,i,r){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"auto";return t.Deferred(function(){var l=this;"straight"==s?a(e,o,i,r).progress(l.notify).done(l.resolve).fail(l.reject):n(e,o,i,r).progress(l.notify).done(l.resolve).fail(function(){console.log(this.error),console.log("Trying straight line...");var n=new Drop({target:t(".awesome-marker").eq(r+1)[0],classes:"drop-theme-arrows",position:"right middle",constrainToWindow:!1,constrainToScrollParent:!1,openOn:null,content:"Impossible d'obtenir le tracé en mode automatique. Le mode ligne droite va être utilisé."});n.open(),t(n.content).on("click",function(){n.destroy()}),a(e,o,i,r).progress(l.notify).done(l.resolve).fail(l.reject)})})}function o(e,o,n,a,i,r){return t.Deferred(function(){var i=this;o.prepareForMap(e,n,a),o.computeStats().progress(i.notify).then(function(){o.addTo(e),o.bindPopup("Calculs en cours..."),o.on("popupopen",function(e){t(".marker-add-button:visible").click(function(){var t=L.Marker.routed(e.popup.getLatLng().roundE8(),{riseOnHover:!0,draggable:!0,opacity:.5,color:n.getColorIndex(),type:"waypoint"});t.insert(o).done(function(){t.setOpacity(1)})})}),o.snakeIn(),n.setOpacity(1),a.setOpacity(1),i.resolveWith({route:o})}).fail(function(){i.rejectWith({error:"Impossible d'obtenir les données de la route"})})})}function n(e,n,a,i){return t.Deferred(function(){var r=this,s=n.getLatLng(),l=a.getLatLng(),u={distanceUnit:"m",endPoint:{x:l.lng,y:l.lat},exclusions:[],geometryInInstructions:!0,graph:"Pieton",routePreferences:"fastest",startPoint:{x:s.lng,y:s.lat},viaPoints:[],apiKey:keyIgn,onSuccess:function(s){if(s){var l=L.geoJSON([],{color:n.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3}),u={type:"FeatureCollection",features:[]},c=1;t.each(s.routeInstructions,function(t,e){c++,u.features.push({id:c,type:"Feature",geometry:e.geometry})}),l.addData(u),o(e,l,n,a,i,"auto").progress(r.notify).done(r.resolve).fail(r.reject),r.notify({step:"Route calculée"})}else r.rejectWith({error:"Impossible d'obtenir la route: pas de résultats fournis"})},onFailure:function(t){r.rejectWith({error:"Impossible d'obtenir la route: "+t.message})}};r.notify({start:!0,total:1,status:"Calcul de la route..."}),Gp.Services.route(u)})}function a(t,e,n,a){for(var i=e.getLatLng().roundE8(),r=n.getLatLng().roundE8(),s=i.distanceTo(r),l=i.bearingTo(r),u=[i],c=10;c<s;c+=10)u.push(i.getDestinationAlong(l,c));return u.push(r),o(t,L.polyline(u,{color:e.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3}),e,n,a,"straight")}var i={red:"#D63E2A",orange:"#F59630",green:"#72B026",blue:"#38AADD",purple:"#D252B9",darkred:"#A23336",darkblue:"#0067A3",darkgreen:"#728224",darkpurple:"#5B396B",cadetblue:"#436978",lightred:"#FF8E7F",beige:"#FFCB92",lightgreen:"#BBF970",lightblue:"#8ADAFF",pink:"#FF91EA",white:"#FBFBFB",lightgray:"#A3A3A3",gray:"#575757",black:"#303030"},r=["blue","green","orange","purple","red","darkblue","darkpurple","lightblue","lightgreen","beige","pink","lightred"];L.Track=L.Evented.extend({options:{map:void 0},initialize:function(t){L.setOptions(this,t),this.Lmap=this.options.map.map("getMap"),this.$map=this.options.map,this.currentColor=0,this.markersLength=0},getCurrentColor:function(){return this.currentColor},nextColor:function(){return this.currentColor=(this.currentColor+1)%r.length,this.currentColor},lengthOfMarkers:function(){return this.markersLength},hasMarkers:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.markersLength>=t},hasRoutes:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.markersLength-1>=t},isImport:function(){return this.hasRoutes()&&"import"==this.getFirstMarker().getRouteModeFromHere()},getBounds:function(){var t=L.latLngBounds(this.getFirstMarker(0).getLatLng(),this.getLastMarker().getLatLng());return this.eachRoute(function(e,o){t.extend(o.getBounds())}),t},getFirstMarker:function(){return this.firstMarker},getLastMarker:function(){return this.lastMarker},isLoop:function(){return this.firstMarker&&this.lastMarker&&this.firstMarker.getLatLng().distanceTo(this.lastMarker.getLatLng())<10},clear:function(){this.eachMarker(function(t,e){e.remove(!1)}),this.fire("markerschanged")},eachMarker:function(t){for(var e=this.firstMarker,o=0;e;){var n=e._nextMarker;t.call(e,o,e),e=n,o++}},eachRoute:function(t){for(var e=this.firstMarker,o=0;e;){var n=e.getRouteFromHere();n&&(t.call(n,o,n),o++),e=e._nextMarker}},addMarker:function(e){var o,n=this,a=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this;return void 0===this.firstMarker&&(this.firstMarker=e),void 0!==this.lastMarker&&a&&(o=this.lastMarker.computeRouteTo(e,this.$map.map("getMode"))),this.lastMarker=e,this.markersLength++,e.track=this,e.addTo(this.Lmap),o?o.done(function(){return n.fire("markerschanged")}):t.Deferred(function(){i.fire("markerschanged"),this.resolve()})},moveMarker:function(e){var o=this;return t.Deferred(function(){var n=this,a=[];if(e.hasRouteFromHere()){a.length;a.push(e.recomputeRouteFromHere(o.$map.map("getMode")))}if(e.hasRouteToHere()){a.length;a.push(e.recomputeRouteToHere(o.$map.map("getMode")))}t.when.apply(t,a).done(function(){o.fire("markerschanged"),n.resolve()}).fail(n.fail)})},insertMarker:function(e,o){var n=this;return t.Deferred(function(){var a=this,i=[];i.push(o.getStartMarker().computeRouteTo(e,n.$map.map("getMode"))),i.push(e.computeRouteTo(o.getEndMarker(),n.$map.map("getMode"))),n.markersLength++,e.addTo(n.Lmap),t.when.apply(t,i).done(function(){n.fire("markerschanged"),a.resolve()}).fail(a.fail)})},_initStats:function(){return{distance:0,altMin:Number.MAX_VALUE,altMax:Number.MIN_VALUE,denivPos:0,denivNeg:0}},computeStats:function(){var t=this,e=[],o=[],n=this._initStats(),a=this._initStats();if(this.eachMarker(function(i,r){if("step"==r.getType()){e.push(n.distance);for(var s=r;s&&s.hasRouteToHere()&&(s.getRouteToHere().setPopupContentWith(s._previousMarker.getColorCode(),a,"import"!=s._previousMarker.getRouteModeFromHere()),"step"!=(s=s._previousMarker).getType()););a=t._initStats()}var l=r.getRouteFromHere(),u=l?l.getElevations():[];if(u.length>0){for(var c=0;c<u.length;c++)u[c].dist+=n.distance,u[c].route=l;o=o.concat(u),n.distance+=l.getDistance(),n.altMin=Math.min(n.altMin,l.getAltMin()),n.altMax=Math.max(n.altMax,l.getAltMax()),n.denivNeg+=l.getDenivNeg(),n.denivPos+=l.getDenivPos(),a.distance+=l.getDistance(),a.altMin=Math.min(a.altMin,l.getAltMin()),a.altMax=Math.max(a.altMax,l.getAltMax()),a.denivNeg+=l.getDenivNeg(),a.denivPos+=l.getDenivPos()}}),a.distance>0)for(var i=this.getLastMarker();i&&i.hasRouteToHere()&&(i.getRouteToHere().setPopupContentWith(i._previousMarker.getColorCode(),a,"import"!=i._previousMarker.getRouteModeFromHere()),"step"!=(i=i._previousMarker).getType()););return{size:o.length,elevations:o,total:n,steps:e}},exportGpx:function(e){var o=!1;try{o=!!new Blob}catch(t){}if(!o)return!1;var n='<?xml version="1.0"?>\n';n+='<gpx creator="map2gpx.fr" version="1.0" xmlns="http://www.topografix.com/GPX/1/1"',n+=' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',n+=' xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n',n+="    <trk>\n",n+="        <name>"+e+"</name>\n",n+="        <trkseg>\n",this.eachMarker(function(o,a){a.hasRouteFromHere()&&("step"==a.getType()&&(n+="        </trkseg>\n",n+="    </trk>\n",n+="    <trk>\n",n+="        <name>"+e+"-"+o+"</name>\n",n+="        <trkseg>\n"),t.each(a.getRouteFromHere().getLatLngs(),function(e,o){n+='            <trkpt lat="'+o.lat+'" lon="'+o.lng+'">',t.Cache.hasAltitude(o)&&(n+="<ele>"+t.Cache.getAltitude(o)+"</ele>"),n+="</trkpt>\n"}))}),n+="        </trkseg>\n",n+="    </trk>\n",n+="</gpx>\n";var a=new Blob([n],{type:"application/gpx+xml;charset=utf-8"});return saveAs(a,e+".gpx"),!0},exportKml:function(e){var o=!1;try{o=!!new Blob}catch(t){}if(!o)return!1;var n='<?xml version="1.0" encoding="UTF-8"?>\n';n+='<kml xmlns="http://www.opengis.net/kml/2.2"',n+=' xmlns:gx="http://www.google.com/kml/ext/2.2"',n+=' xmlns:kml="http://www.opengis.net/kml/2.2"',n+=' xmlns:atom="http://www.w3.org/2005/Atom">\n',n+="    <Document>\n",n+="        <name>"+e+".kml</name>\n",n+="        <Placemark>\n",n+="            <name>"+e+"</name>\n",n+="            <LineString>\n",n+="                <tessellate>1</tessellate>\n",n+="                <coordinates>\n",n+="                    ",this.eachMarker(function(o,a){a.hasRouteFromHere()&&("step"==a.getType()&&(n+="\n                </coordinates>\n",n+="            </LineString>\n",n+="        </Placemark>\n",n+="        <Placemark>\n",n+="            <name>"+e+"-"+o+"</name>\n",n+="            <LineString>\n",n+="                <tessellate>1</tessellate>\n",n+="                <coordinates>\n",n+="                    "),t.each(a.getRouteFromHere().getLatLngs(),function(t,e){n+=e.lng+","+e.lat+",0 "}))}),n+="\n                </coordinates>\n",n+="            </LineString>\n",n+="        </Placemark>\n",n+="    </Document>\n",n+="</kml>\n";var a=new Blob([n],{type:"text/plain;charset=utf-8"});return saveAs(a,e+".kml"),!0},importGpx:function(e){var o=this;return t.Deferred(function(){var n=this,a=new FileReader;a.onload=function(e){var a=[];new L.GPX(e.target.result,{async:!0,onFail:function(){n.rejectWith({error:"Impossible de traiter ce fichier"})},onSuccess:function(e){n.notify({step:"Fichier traité"}),n.notify({start:!0,total:a.length,status:"Récupération des données géographiques en cours..."}),o.clear();var i=e.getBounds();o.Lmap.fitBounds(i,{padding:[50,50]}),e.addTo(o.Lmap);var r,s=function(){t(".track-delete-button:visible").click(function(){o.clear(),o.Lmap.removeLayer(e)})},l=[];t.each(a,function(t,e){if(0==t){var a=e.getLatLngs()[0];r=L.Marker.routed(a,{draggable:!1,opacity:.5,color:o.getCurrentColor(),type:"waypoint"}),o.addMarker(r,!1),r.bindPopup('<button class="track-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer l\'import</button>'),r.on("popupopen",s)}var i=e.getLatLngs()[e.getLatLngs().length-1],u=L.Marker.routed(i,{draggable:!1,opacity:.5,color:o.nextColor(),type:"step"});o.addMarker(u,!1),r.attachRouteFrom(u,e,"import"),e.setStyle({weight:5,color:r.getColorRgb(),opacity:.5}),e.bindPopup("Calculs en cours..."),u.bindPopup('<button class="track-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer l\'import</button>'),u.on("popupopen",s),l.push(e.computeStats().progress(n.notify)),r=u}),t.each(l,function(){this.done(function(){return n.notify({})})}),t.when.apply(t,l).done(function(){o.eachRoute(function(t,e){e.setStyle({opacity:.75})}),o.eachMarker(function(t,e){e.setOpacity(1)}),o.fire("markerschanged"),n.resolve()}).fail(function(){n.rejectWith({error:"Impossible de récupérer les données géographiques de ce parcours"})})}}).on("addline",function(t){a.push(t.line)})},a.readAsText(e)})},_removeMarker:function(t){this.firstMarker===t&&(this.firstMarker=t._nextMarker),this.lastMarker===t&&(this.lastMarker=t._previousMarker),this.markersLength--}}),L.track=function(t){return new L.Track(t)},L.Marker.Routed=L.Marker.extend({options:{type:"waypoint",color:0},initialize:function(t,e){L.Marker.prototype.initialize.call(this,t,e),L.setOptions(this,e),this.setType(this.options.type)},getColorCode:function(){return r[this.options.color]},getColorRgb:function(){return i[r[this.options.color]]},getColorIndex:function(){return this.options.color},setColorIndex:function(t){this.options.color=t,this.setType(this.options.type),this.routeFrom&&this.routeFrom.setStyle({color:this.getColorRgb()})},getType:function(){return this.options.type},setType:function(t){this.options.type=t,"waypoint"==t?this.setIcon(L.AwesomeMarkers.icon({icon:"circle",markerColor:this.getColorCode(),prefix:"fa"})):this.setIcon(L.AwesomeMarkers.icon({icon:"asterisk",markerColor:this.getColorCode(),prefix:"fa"}))},promoteToStep:function(){for(var t=this.track.nextColor(),e=this;e&&"step"!=e.options.type;)e.setColorIndex(t),e=e._nextMarker;this.setType("step"),this.track.fire("markerschanged")},demoteToWaypoint:function(){if(this.setType("waypoint"),this.hasRouteToHere())for(var t=this._previousMarker.getColorIndex(),e=this;e&&"step"!=e.options.type;)e.setColorIndex(t),e=e._nextMarker;this.track.fire("markerschanged")},hasRouteToHere:function(){return this._previousMarker&&this._previousMarker.hasRouteFromHere()},getRouteToHere:function(){return this._previousMarker.routeFrom},hasRouteFromHere:function(){return!!this.routeFrom},getRouteFromHere:function(){return this.routeFrom},getRouteModeFromHere:function(){return this._mode},deleteRouteFromHere:function(){this._nextMarker&&(this._nextMarker._previousMarker=void 0),this.routeFrom&&this.routeFrom.remove(),this.attachRouteFrom(void 0,null,void 0)},computeRouteTo:function(o,n){var a=this;return t.Deferred(function(){var i=this;a.routeFrom&&a.routeFrom.setStyle({opacity:.5}),t(a).clearCompute(),t(a).startCompute(function(r){n=n||a._mode||"auto",e(t("#map").map("getMap"),a,o,0,n).progress(t.Queue.notify).done(function(){a.deleteRouteFromHere(),a.attachRouteFrom(o,this.route,n),i.resolve()}).fail(i.reject).always(function(){return t(a).endCompute(r)})})})},recomputeRouteFromHere:function(t){return this.computeRouteTo(this._nextMarker,t)},recomputeRouteToHere:function(t){return this._previousMarker.computeRouteTo(this,t)},attachRouteFrom:function(t,e,o){this._nextMarker=t,t&&(t._previousMarker=this),this.routeFrom=e,this._mode=o},_bindEvents:function(){var e=this;this.bindPopup('<button class="marker-promote-button"><i class="fa fa-asterisk" aria-hidden="true"></i> Marquer comme étape</button> <button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>'),this.on("popupopen",function(){t(".marker-delete-button:visible").click(function(){e.remove()}),t(".marker-promote-button:visible").click(function(){e.closePopup(),e.setPopupContent('<button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>'),e.promoteToStep()})}),this.on("moveend",function(t){e.setOpacity(.5),e.track.moveMarker(e).done(function(){return e.setOpacity(1)})})},add:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.track=t,this._bindEvents(),this.track.addMarker(this,e)},insert:function(e){return this.track=t("#map").map("getTrack"),this._bindEvents(),this.track.insertMarker(this,e)},remove:function(){var e,o=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];"step"==this.options.type&&o&&this.demoteToWaypoint();var n=this._previousMarker,a=this._nextMarker;if(this.track._removeMarker(this),this.routeFrom&&this.deleteRouteFromHere(),n&&(n.deleteRouteFromHere(),a&&o)){var i=this.track.$map.map("getMode")||this._mode||"auto";e=n.computeRouteTo(a,i)}return L.Marker.prototype.remove.call(this),this.track.fire("markerschanged"),e||t.Deferred(function(){this.resolve()})}}),L.Marker.routed=function(t,e){return new L.Marker.Routed(t,e)}}(jQuery),function(t){t.widget("map2gpx.map",{options:{leafletOptions:{},controls:{searchEngine:{show:!0,leafletOptions:{displayAdvancedSearch:!1}},minimap:{show:!0,leafletOptions:{position:"bottomleft",zoomLevelOffset:-4}},layerSwitcher:{show:!0,leafletOptions:{collapsed:!1}},scale:{show:!0,leafletOptions:{imperial:!1,position:"bottomright"}},help:{show:!0}}},getMap:function(){return this.map},getTrack:function(){return this.track},getMode:function(){return this.mode},_buildEventData:function(){return{mode:this.mode}},_setMode:function(t){this.mode=t,this._trigger("modechanged",null,this._buildEventData())},_onCreated:function(){var e=this;this.element.on("mapmodechanged",function(t){e.map.doubleClickZoom.setEnabled(null===e.mode)}),this.map.on("dblclick",function(t){return e._addMarker.call(e,t)}),this._initializeLayers(),this.options.controls.searchEngine.show&&this._initializeSearchEngine(),this.options.controls.minimap.show&&this._initializeMinimap(),this.options.controls.layerSwitcher.show&&this._initializeLayerSwitcher(),this.options.controls.scale.show&&this._initializeScale(),this._initializeTraceButtons(),this._initializeExportButtons(),this._initializeImportButtons(),this._initializeHelpButtons(),this._trigger("created",null,{}),this._trigger("statechanged",null,this._buildEventData()),t.when.apply(t,this.layers.promises).done(function(){e._trigger("loaded",null,{})})},_initializeLayers:function(){var e=this,o=this;this.layers.photos=L.geoportalLayer.WMTS({layer:"ORTHOIMAGERY.ORTHOPHOTOS",apiKey:keyIgn}).addTo(this.map),this.layers.promises.push(t.Deferred(function(){o.layers.photos.once("load",this.resolve)})),this.layers.slopes=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.SLOPES.MOUNTAIN",apiKey:keyIgn},{opacity:.25}).addTo(this.map),this.layers.maps=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn},{opacity:.25}).addTo(this.map),this.layers.promises.push(t.Deferred(function(){o.layers.maps.once("load",this.resolve)}));var n=void 0;this.map.on("zoomend",function(){var o=e.map.getZoom(),a=void 0,i=void 0;e.map.hasLayer(e.layers.photos)&&(e.layers.photos.options.minZoom>o||e.layers.photos.options.maxZoom<o)?(a="Photographies aériennes",i=t(".GPlayerSwitcher_layer:eq(2)")):e.map.hasLayer(e.layers.maps)&&(e.layers.maps.options.minZoom>o||e.layers.maps.options.maxZoom<o)?(a="Cartes IGN",i=t(".GPlayerSwitcher_layer:eq(0)")):e.map.hasLayer(e.layers.slopes)&&(e.layers.slopes.options.minZoom>o||e.layers.slopes.options.maxZoom<o)&&(a="Carte des pentes",i=t(".GPlayerSwitcher_layer:eq(1)")),void 0!==a&&void 0===n?((n=new Drop({target:i[0],classes:"drop-theme-arrows",position:"left middle",constrainToWindow:!1,constrainToScrollParent:!1,openOn:null,content:"La couche &quot;"+a+"&quot; n'est pas disponible à ce niveau de zoom"})).open(),t(n.content).on("click",function(){n.destroy(),n=null})):void 0===a&&void 0!==n&&null!==n&&(n.destroy(),n=null)})},_initializeSearchEngine:function(){L.geoportalControl.SearchEngine(this.options.controls.searchEngine.leafletOptions).addTo(this.map)},_initializeMinimap:function(){var e=this;this.layers.minimap=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn}),this.layers.promises.push(t.Deferred(function(){e.layers.minimap.once("load",this.resolve)})),new L.Control.MiniMap(this.layers.minimap,this.options.controls.minimap.leafletOptions).addTo(this.map)},_initializeLayerSwitcher:function(){var e=L.geoportalControl.LayerSwitcher(this.options.controls.layerSwitcher.leafletOptions);this.map.addControl(e),e.setVisibility(this.layers.slopes,!1),t(".GPlayerRemove").remove()},_initializeScale:function(){L.control.scale(this.options.controls.scale.leafletOptions).addTo(this.map)},_initializeTraceButtons:function(){var t=this,e=L.easyButton({id:"btn-autotrace",states:[{stateName:"loaded",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(e,o){return t._setMode("auto")}},{stateName:"active",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(e,o){return t._setMode(null)}}]});this.element.on("mapmodechanged mapstatechanged",function(o){"auto"==t.mode?(e.state("active"),e.enable()):(e.state("loaded"),e.setEnabled(!t.track.isImport()))});var o=L.easyButton({id:"btn-straighttrace",states:[{stateName:"loaded",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(e,o){return t._setMode("straight")}},{stateName:"active",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(e,o){return t._setMode(null)}}]});this.element.on("mapmodechanged mapstatechanged",function(e){"straight"==t.mode?(o.state("active"),o.enable()):(o.state("loaded"),o.setEnabled(!t.track.isImport()))});var n=L.easyButton({id:"btn-closeloop",states:[{stateName:"loaded",icon:"fa-magic",title:"Fermer la boucle",onClick:function(e,o){t.track.hasMarkers(1)&&t._addMarker({latlng:t.track.getFirstMarker().getLatLng()})}}]});this.element.on("mapmodechanged mapcomputingchanged mapstatechanged",function(e){n.setEnabled(null!==t.mode&&t.track.hasRoutes()&&!t.track.isImport()&&!t.track.isLoop())}),L.easyBar([e,o,n]).addTo(this.map)},_initializeExportButtons:function(){var e=this,o=this,n=L.popup().setContent(L.DomUtil.get("form-export")),a=L.easyButton({id:"btn-export",states:[{stateName:"loaded",icon:"fa-cloud-download",title:"Exporter",onClick:function(a,i){var r=e.track.getBounds();e.map.flyToBounds(r,{padding:[50,50]}),n.setLatLng(r.getCenter()).openOn(e.map),t(".export-gpx-button:visible").click(function(){var e=t(this);e.attr("disabled","disabled"),o.track.exportGpx(t(".export-filename:visible").val()),e.removeAttr("disabled")}),t(".export-kml-button:visible").click(function(){var e=t(this);e.attr("disabled","disabled"),o.track.exportKml(t(".export-filename:visible").val()),e.removeAttr("disabled")})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Exporter (calcul en cours...)"}]}).addTo(this.map);this.element.on("mapcomputingchanged mapstatechanged",function(t){t.computing?(a.state("computing"),a.disable()):(a.state("loaded"),a.setEnabled(e.track.hasRoutes()))})},_initializeImportButtons:function(){var e=this,o=this,n=L.popup().setContent(L.DomUtil.get("form-import")),a=L.easyButton({id:"btn-import",states:[{stateName:"loaded",icon:"fa-cloud-upload",title:"Importer",onClick:function(a,i){n.setLatLng(e.map.getCenter()).openOn(e.map),e.track.hasRoutes()?t(".import-gpx-status:visible").html("<strong>Attention:</strong> l'import va effacer l'itinéraire existant!"):t(".import-gpx-status:visible").text(""),t(".import-gpx-button:visible").click(function(){var e=t(this),a=t(".import-gpx-file:visible")[0].files[0];void 0!=a?(e.attr("disabled","disabled"),t("body").startCompute(function(i){t.Queue.notify({start:!0,total:1,status:"Importation en cours..."}),o.track.importGpx(a).done(function(){e.removeAttr("disabled"),o._setMode(null)}).fail(function(){t(".import-gpx-status:visible").text(this.error),e.removeAttr("disabled")}).progress(function(e){t.Queue.notify(e),n&&(n.remove(),n=void 0)}).always(function(){return t("body").endCompute(i)})})):t(".import-gpx-status:visible").text("Veuillez sélectionner un fichier")})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Importer (calcul en cours...)"}]}),i=L.easyButton({id:"btn-reset",states:[{stateName:"loaded",icon:"fa-trash",title:"Effacer l'itinéraire",onClick:function(t,o){e.track.clear()}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Effacer l'itinéraire (calcul en cours...)"}]});L.easyBar([a,i]).addTo(this.map),this.element.on("mapcomputingchanged mapstatechanged",function(t){a.state(e.computing?"computing":"loaded"),i.state(e.computing?"computing":"loaded"),a.setEnabled(!e.computing),i.setEnabled(!e.computing&&e.track.hasMarkers())})},_initializeHelpButtons:function(){var e=this,o=L.popup().setContent(L.DomUtil.get("about")),n=L.easyButton({position:"bottomright",states:[{icon:"fa-info-circle",onClick:function(t,n){o.setLatLng(e.map.getCenter()).openOn(e.map)},title:"A propos & crédits"}]}),a=L.easyButton({position:"bottomright",states:[{icon:"fa-question-circle",onClick:function(e,o){t.Shepherd.get(0).start(!0)},title:"Aide"}]});L.easyBar([n,a],{position:"bottomright"}).addTo(this.map)},_create:function(){var t=this;this.element.uniqueId(),this.layers={},this.layers.promises=[],this.mode=null,this.map=L.map(this.element.attr("id"),this.options.leafletOptions),this.track=L.track({map:this.element}),this.track.on("markerschanged",function(){return t._trigger("statechanged",null,t._buildEventData())}),this.map.initView().done(function(){return t._onCreated()})},_addMarker:function(t){if(null!==this.mode){var e=L.Marker.routed(t.latlng.roundE8(),{riseOnHover:!0,draggable:!0,opacity:.5,color:this.track.hasMarkers()?this.track.getLastMarker().getColorIndex():this.track.getCurrentColor(),type:"waypoint"});this.track.hasMarkers()&&this.track.getLastMarker().getLatLng().equals(e.getLatLng())||e.add(this.track).done(function(){e.setOpacity(1)})}}})}(jQuery);var isSmallScreen=window.innerWidth<=800&&window.innerHeight<=600;showLoadingMessage("Observation des faucons crécerelle..."),window.onload=function(){try{showLoadingMessage("Localisation des chamois..."),$("#data-computing").progress().on("progressstatechanged",function(e,o){o.started?$("#data-computing").fadeIn():($("#data").data("map2gpx-chart").replot(t.map("getTrack").computeStats()),$("#data-computing").fadeOut())}),$.Queue.bindTo($("#data-computing"));var t=$("#map").map({controls:{minimap:{show:!isSmallScreen},layerSwitcher:{leafletOptions:{collapsed:isSmallScreen}},scale:{show:!isSmallScreen},help:{show:!isSmallScreen}},created:function(){showLoadingMessage("Suivi des renards roux..."),isSmallScreen?$("#mobile-warning").show().find("button").click(function(){popup.hide()}):$.Shepherd.tour().add("welcome",{text:$("#help-welcome")[0]}).add("layers",{text:$("#help-layers")[0],attachTo:{element:$(".GPlayerName").closest(".GPwidget")[0],on:"left"}}).add("search",{text:$("#help-search")[0],attachTo:{element:$(".GPshowAdvancedToolOpen").closest(".GPwidget")[0],on:"right"}}).add("autotrace",{text:$("#help-autotrace")[0],attachTo:{element:$("#btn-autotrace")[0],on:"right"}}).add("straighttrace",{text:$("#help-straighttrace")[0],attachTo:{element:$("#btn-straighttrace")[0],on:"right"}}).start()},loaded:function(){showLoadingMessage("Alignement des satellites..."),clearInterval(interval),$("#loading").fadeOut()}}).on("mapmarkerschanged",function(e){isSmallScreen||(t.map("getTrack").hasMarkers(2)&&!$.Shepherd.has(1)&&$.Shepherd.tour().add("data",{text:$("#help-data")[0],attachTo:{element:$("#data")[0],on:"top"}}).add("closeloop",{text:$("#help-closeloop")[0],attachTo:{element:$("#btn-closeloop")[0],on:"right"}}).add("export",{text:$("#help-export")[0],attachTo:{element:$("#btn-export")[0],on:"right"}}).start(),t.map("getTrack").hasMarkers(3)&&!$.Shepherd.has(2)&&$.Shepherd.tour().add("movemarker",{text:$("#help-movemarker")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).add("movemarker2",{text:$("#help-movemarker2")[0],attachTo:{element:$(".awesome-marker").eq(-2)[0],on:"bottom"}}).add("steps",{text:$("#help-steps")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).add("steps2",{beforeShowPromise:function(){return $.Deferred(function(){var e=t.map("getTrack").getFirstMarker().getRouteFromHere(),o=e.getLatLngs(),n=o[Math.floor(o.length/2)];e.openPopup(n),this.resolve()}).promise()},text:$("#help-steps2")[0]}).start())}).on("mapstatechanged",function(e){$("#data").data("map2gpx-chart").replot(t.map("getTrack").computeStats())});$("#data").chart({map:t.map("getMap"),dataEmpty:"#data-empty",isSmallScreen:isSmallScreen})}catch(t){gotError=!0,console.log("Got exception",t),$("#loading").animate({backgroundColor:"#A23336",color:"#FFFFFF"}),$("#loading h2 i.fa").removeClass("fa-spinner fa-pulse").addClass("fa-bug"),$("#loading h2 span").html("Une erreur s'est produite: &quot;"+t+"&quot;."),$("#loading h3").html($('<div>N\'hésitez pas à ouvrir un ticket sur <a href="https://github.com/tmuguet/map2gpx" target="_blank" rel="noopener noreferrer">Github</a> ou à m\'envoyer un mail à <a href="mailto:hi@tmuguet.me">hi@tmuguet.me</a>.</div>').hide().slideDown()),clearInterval(interval)}};