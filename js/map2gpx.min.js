"use strict";function fetchAltitude(t){return $.Deferred(function(){var e=this,o={apiKey:keyIgn,sampling:t.length,positions:t,onSuccess:function(t){t?($.each(t.elevations,function(t,e){$.Cache.addAltitude(e.lat,e.lon,e.z)}),e.resolveWith({size:t.elevations.length})):(console.log("Impossible d'obtenir les données d'altitude: résultats invalides"),e.reject())},onFailure:function(t){console.log("Impossible d'obtenir les données d'altitude: ",t.message),e.reject()}};Gp.Services.getAltitude(o)})}function fetchSlope(t,e,o){return $.Deferred(function(){var n=this,a={tilematrix:16,tilerow:e,tilecol:t,lon:"",lat:"",x:"",y:""};$.each(o,function(t,e){t>0&&(a.lon+="|",a.lat+="|",a.x+="|",a.y+="|"),a.lon+=e.lng.toString(),a.lat+=e.lat.toString(),a.x+=e.x.toString(),a.y+=e.y.toString()}),$.getJSON("slope.php",a,function(t){t.results?($.each(t.results,function(t,e){$.Cache.addSlope(e.lat,e.lon,e.slope)}),n.resolveWith({size:t.results.length})):(console.log("Impossible d'obtenir les données de pente: résultats invalides"),n.reject())}).fail(function(t,e,o){console.log("Impossible d'obtenir les données de pente: ",e,o),n.reject()})})}!function(t){var e=function(t){var e;try{var o="__storage_test__";return(e=window[t]).setItem(o,o),e.removeItem(o),!0}catch(t){return t instanceof DOMException&&(22===t.code||1014===t.code||"QuotaExceededError"===t.name||"NS_ERROR_DOM_QUOTA_REACHED"===t.name)&&0!==e.length}}("localStorage");t.localStorage={get:function(t){return e?localStorage.getItem(t):null},getAsJSON:function(t){return e&&null!==localStorage.getItem(t)?JSON.parse(localStorage.getItem(t)):null},set:function(t,o){e&&localStorage.setItem(t,o)},setAsJSON:function(t,e){this.set(t,JSON.stringify(e))}}}(jQuery),jQuery.QueryString=function(t){for(var e={},o=0;o<t.length;++o){var n=t[o].split("=",2);2===n.length&&(e[n[0]]=decodeURIComponent(n[1].replace(/\+/g," ")))}return e}(window.location.search.substr(1).split("&")),function(t){var e=[];t.Shepherd={},t.Shepherd.Step=function(){var e,o;return{init:function(n,a){return e=n,o=t.extend({},a,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"}),this}}},t.Shepherd.step=function(e,o){return t.Shepherd.Step().init(e,o)},t.Shepherd.Tour=function(){var o,n=0;return{init:function(e){var n=t.extend({},e,{defaults:{classes:"shepherd-element shepherd-open shepherd-theme-arrows",showCancelLink:!0}});return o=new Shepherd.Tour(n),this},add:function(a,r){var i=this,s=n,l=t.extend({},r,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"});return l.buttons=[{text:"Fermer",classes:"shepherd-button-secondary",action:function(){t.localStorage.set("tutorial"+e.indexOf(i),-1),i.cancel()}},{text:"Suivant",classes:"shepherd-button-example-primary",action:function(){var o=e.indexOf(i);o<0&&console.log("Could not find current shepherd, something is probably wrong"),t.localStorage.set("tutorial"+o,s+1),i.next(),s==n-1&&o>=0&&o<e.length-1&&e[o+1].start(!0)}}],o.addStep(a,l),n++,this},start:function(){var a=0;if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])){var r=e.indexOf(this);null!==t.localStorage.get("tutorial"+r)&&(a=parseInt(t.localStorage.get("tutorial"+r)))}return a>=0&&a<n&&o.show(a),this},cancel:function(){return o.cancel(),this},next:function(){return o.next(),this}}},t.Shepherd.tour=function(o){var n=t.Shepherd.Tour().init(o);return e.push(n),n},t.Shepherd.get=function(t){return e[t]},t.Shepherd.has=function(t){return e.length>t}}(jQuery),Math.roundE8=function(t){return Math.round(t*Math.pow(10,8))/Math.pow(10,8)},Math.radians=function(t){return t*Math.PI/180},Math.degrees=function(t){return 180*t/Math.PI},L.LatLng.prototype.roundE8=function(){return L.latLng(Math.roundE8(this.lat),Math.roundE8(this.lng))},L.LatLng.prototype.toTilePixel=function(t,e,o,n){var a=t.latLngToPoint(this,e).floor(),r=a.divideBy(o).floor(),i=r.multiplyBy(o).subtract(n);return{tile:r,tilePixel:a.subtract(n).subtract(i)}},L.LatLng.prototype.getDestinationAlong=function(t,e){var o=6378137,n=Math.radians(t),a=Math.radians(this.lat),r=Math.radians(this.lng),i=Math.asin(Math.sin(a)*Math.cos(e/o)+Math.cos(a)*Math.sin(e/o)*Math.cos(n)),s=r+Math.atan2(Math.sin(n)*Math.sin(e/o)*Math.cos(a),Math.cos(e/o)-Math.sin(a)*Math.sin(i));return i=Math.degrees(i),s=Math.degrees(s),L.latLng(Math.roundE8(i),Math.roundE8(s))},L.LatLng.prototype.bearingTo=function(t){var e=Math.radians(this.lat),o=Math.radians(this.lng),n=Math.radians(t.lat),a=Math.radians(t.lng),r=Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(e/2+Math.PI/4)),i=a-o;return Math.abs(i)>Math.PI&&(i=i>0?-(2*Math.PI-i):2*Math.PI+i),(Math.degrees(Math.atan2(i,r))+360)%360},L.Handler.include({setEnabled:function(t){t?this.enable():this.disable()}}),L.Control.EasyButton.include({setEnabled:function(t){t?this.enable():this.disable()}}),function(t){var e=null,o=!1,n=t("#data-computing h2"),a=t("#data-computing-progress"),r=t("#data-computing-status");t.State={},t.State.setMode=function(n){e=n,t("body").trigger(t.Event("map2gpx:modechange",{mode:e,computing:o}))},t.State.setComputing=function(n){o=n,t("body").trigger(t.Event("map2gpx:computingchange",{mode:e,computing:o}))},t.State.updateComputing=function(e){var o=e.progress;Array.isArray(e.progress)&&(o=o.reduce(function(t,e){return t+e})/o.length),a.text(Math.round(100*o)+"%"),"status"in e&&e.status&&r.text(e.status),"step"in e&&e.step&&t("<div><small>"+e.step+"</small></div>").insertAfter(n).fadeOut(400,function(){this.remove()}),42==Math.round(100*o)&&t("<div><small>La grande question sur la vie, l'univers et le reste répondue</small></div>").insertAfter(n).fadeOut(400,function(){this.remove()})},t.State.triggerMarkersChanged=function(){t("body").trigger(t.Event("map2gpx:markerschange",{mode:e,computing:o}))},t.State.getMode=function(){return e},t.State.getComputing=function(){return o}}(jQuery),function(t){var e={},o={};t.Cache={};var n=function(t){return t.lng+"/"+t.lat};t.Cache.addAltitude=function(t,o,n){e[o+"/"+t]=n},t.Cache.getAltitude=function(t){var o=n(t);return o in e?e[o]:null},t.Cache.hasAltitude=function(t){return n(t)in e},t.Cache.addSlope=function(t,e,n){o[e+"/"+t]=n},t.Cache.getSlope=function(t){var e=n(t);return e in o?o[e]:null},t.Cache.hasSlope=function(t){return n(t)in o},t.Cache.getInfos=function(t){var a=n(t);return{z:a in e?e[a]:null,slope:a in o?o[a]:null}},t.Cache.lengthOfMarkers=function(){return t.Track.lengthOfMarkers()},t.Cache.hasMarkers=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return t.Track.hasMarkers(e)},t.Cache.getMarker=function(t){},t.Cache.indexOfMarker=function(t){},t.Cache.eachMarker=function(t){},t.Cache.addMarker=function(t){},t.Cache.removeMarkerAt=function(t){},t.Cache.resetMarkers=function(){},t.Cache.lengthOfRoutes=function(){},t.Cache.hasRoutes=function(t){},t.Cache.getRoute=function(t){},t.Cache.getRouteMode=function(t){},t.Cache.eachRoute=function(t){},t.Cache.addRoute=function(t,e){},t.Cache.setRouteAt=function(t,e,o){},t.Cache.removeRouteAt=function(t){},t.Cache.resetRoutes=function(){}}(jQuery),L.Map.include({_bindViewEvents:function(){this.on("zoomend",function(){console.log("Zoomed to ",this.getZoom()),$.localStorage.set("view",[this.getCenter().lat,this.getCenter().lng,this.getZoom()])}),this.on("moveend",function(){console.log("Moved to ",this.getCenter()),$.localStorage.setAsJSON("view",[this.getCenter().lat,this.getCenter().lng,this.getZoom()])})},_setView:function(t){this.setView([t[0],t[1]],t[2])},initView:function(){var t=this;return $.Deferred(function(){var e=this,o=$.localStorage.getAsJSON("view")||[44.96777356135154,6.06822967529297,13];if("lat"in $.QueryString&&"lng"in $.QueryString&&(o=[$.QueryString.lat,$.QueryString.lng,15]),"loc"in $.QueryString){var n={text:$.QueryString.loc,filterOptions:{type:["StreetAddress","PositionOfInterest"]},apiKey:keyIgn,onSuccess:function(n){n&&"suggestedLocations"in n&&n.suggestedLocations.length>0?(t._setView([n.suggestedLocations[0].position.y,n.suggestedLocations[0].position.x,15]),e.resolveWith(t)):(console.log("No results?"),t._setView(o),e.resolveWith(t))},onFailure:function(n){console.log(n),t._setView(o),e.resolveWith(t)}};Gp.Services.autoComplete(n)}else t._setView(o),e.resolveWith(t)}).done(this._bindViewEvents)}}),L.Layer.include({_elevations:[],_distance:0,_altMin:0,_altMax:0,_slopeMin:0,_slopeMax:0,_denivPos:0,_denivNeg:0,prepareForMap:function(t){this._mapToAdd=t},getElevations:function(){return JSON.parse(JSON.stringify(this._elevations))},getDistance:function(){return this._distance},getAltMin:function(){return this._altMin},getAltMax:function(){return this._altMax},getSlopeMin:function(){return this._slopeMin},getSlopeMax:function(){return this._slopeMax},getDenivPos:function(){return this._denivPos},getDenivNeg:function(){return this._denivNeg},computeStats:function(){var t=this;return $.Deferred(function(){var e=this,o=t._fetchAltitude().concat(t._fetchSlope()),n=o.length;e.notify({progress:0,status:"Récupération des données géographiques..."});var a=0;$.each(o,function(){this.done(function(){a++,e.notify({progress:a/(n+1),step:this.size+" points récupérés"})})}),$.when.apply($,o).fail(e.reject).then(function(){t._computeStats(),e.resolve()})})},_computeStats:function(){var t=[];if($.each(this.getLatLngs(),function(e,o){var n=$.extend({},{lat:o.lat,lng:o.lng},$.Cache.getInfos(o));t.push(n)}),0==t.length)return!1;this._distance=0,this._altMin=t[0].z,this._altMax=t[0].z,this._slopeMax=0,this._slopeMin=0,this._denivPos=0,this._denivNeg=0,t[0].dist=0,t[0].slopeOnTrack=0,this._elevations=[t[0]];for(var e=0,o=1;o<t.length;o++){var n=L.latLng(t[o]).distanceTo(L.latLng(this._elevations[e]));if(n>10){if(this._distance+=n/1e3,e++,this._elevations[e]=t[o],this._elevations[e].dist=this._distance,this._elevations[e].slopeOnTrack=Math.degrees(Math.atan((Math.round(this._elevations[e].z)-Math.round(this._elevations[e-1].z))/n)),e>5){var a=(this._elevations[e-5].slopeOnTrack+this._elevations[e-4].slopeOnTrack+this._elevations[e-3].slopeOnTrack+this._elevations[e-2].slopeOnTrack+this._elevations[e-1].slopeOnTrack)/5;this._elevations[e].slopeOnTrack=(a+this._elevations[e].slopeOnTrack)/2}this._elevations[e].z<this._altMin&&(this._altMin=this._elevations[e].z),this._elevations[e].z>this._altMax&&(this._altMax=this._elevations[e].z),this._elevations[e].slopeOnTrack>this._slopeMax&&(this._slopeMax=this._elevations[e].slopeOnTrack),this._elevations[e].slopeOnTrack<this._slopeMin&&(this._slopeMin=this._elevations[e].slopeOnTrack),this._elevations[e].z<this._elevations[e-1].z?this._denivNeg+=Math.round(this._elevations[e-1].z-this._elevations[e].z):this._denivPos+=Math.round(this._elevations[e].z-this._elevations[e-1].z)}}return!0},_fetchAltitude:function(){var t=[],e=[];return $.each(this.getLatLngs(),function(o,n){$.Cache.hasAltitude(n)||(t.push({lon:n.lng,lat:n.lat}),50==t.length&&(e.push(fetchAltitude(t)),t=[]))}),t.length>0&&e.push(fetchAltitude(t)),e},_fetchSlope:function(){var t={},e=[],o=this._map||this._mapToAdd;return $.each(this.getLatLngs(),function(e,n){if(!$.Cache.hasSlope(n)){var a=n.toTilePixel(o.options.crs,16,256,o.getPixelOrigin()),r=a.tile,i=a.tilePixel;r.x in t||(t[r.x]={}),r.y in t[r.x]||(t[r.x][r.y]=[[]]),t[r.x][r.y][t[r.x][r.y].length-1].length>50&&t[r.x][r.y].push([]),t[r.x][r.y][t[r.x][r.y].length-1].push({lat:n.lat,lng:n.lng,x:i.x,y:i.y})}}),$.each(t,function(t,o){$.each(o,function(o,n){$.each(n,function(n,a){e.push(fetchSlope(t,o,a))})})}),e},setPopupContentWith:function(t,e){this.setPopupContent('<ul class="legend '+t+'"><li>Altitude max: '+Math.round(e.altMax)+"m</li><li>D+: "+Math.round(e.denivPos)+"m</li><li>Altitude min: "+Math.round(e.altMin)+"m</li><li>D-: "+Math.round(e.denivNeg)+"m</li><li>Distance: "+Math.round(100*e.distance)/100+"km</li></ul>")}}),L.GeoJSON.include({getLatLngs:function(){var t=[];return this.eachLayer(function(e){$.each(e.feature.geometry.coordinates,function(e,o){t.push(L.latLng(o[1],o[0]))})}),t}}),function(t){var e,o,n,a,r=null,i={icon:L.AwesomeMarkers.icon({icon:"area-chart",markerColor:"cadetblue",prefix:"fa"}),draggable:!1,clickable:!1,zIndexOffset:1e3},s=null;t.Chart={init:function(l,u,c,d,p){e=u,o=c,n=d,(a=p)?t("#"+u).remove():s=new Chart(t("#"+u),{type:"line",data:{datasets:[{label:"Altitude",data:[],fill:!1,borderColor:"rgba(12, 98, 173, 0.8)",backgroundColor:"rgba(12, 98, 173, 0.8)",lineTension:0,pointRadius:0,yAxisId:"alt"},{label:"Pente de l'itinéraire",data:[],fill:!0,pointRadius:0,yAxisID:"slope"},{label:"Pente du terrain",data:[],fill:!0,pointRadius:0,yAxisID:"slope2",hidden:!0}]},options:{maintainAspectRatio:!1,hover:{mode:"index",intersect:!1,onHover:function(t,e){if("mousemove"==t.type)if(e&&e.length>0){var o=e[0]._index,n=s.config.data.datasets[0].data[o];null==r?(r=L.marker(L.latLng(n.lat,n.lng),i)).addTo(l):(r.setLatLng(L.latLng(n.lat,n.lng)),r.update())}else r&&(l.removeLayer(r),r=null);else"mouseout"==t.type&&r&&(l.removeLayer(r),r=null)}},scales:{xAxes:[{id:"distance",type:"linear",position:"bottom",ticks:{min:0}}],yAxes:[{id:"alt",type:"linear",position:"left",beginAtZero:!1},{id:"slope",type:"linear",position:"right"},{id:"slope2",type:"linear",position:"right",ticks:{min:0,max:45}}]},legend:{position:"left"},tooltips:{mode:"index",intersect:!1,callbacks:{title:function(t,e){return"Distance: "+Math.floor(100*t[0].xLabel)/100+"km"},label:function(t,e){return e.datasets[t.datasetIndex].label+": "+(0==t.datasetIndex?Math.round(100*t.yLabel)/100+"m":Math.round(t.yLabel)+"°")}}},annotation:{annotations:[]}}})},_replotSmallScreen:function(t){t.size>0?o.html("<ul><li>Altitude max: "+Math.round(t.total.altMax)+"m; D+: "+Math.round(t.total.denivPos)+"m</li><li>Altitude min: "+Math.round(t.total.altMin)+"m; D-: "+Math.round(t.total.denivNeg)+"m</li><li>Distance: "+Math.round(100*t.elevations[t.size-1].dist)/100+"km</li></ul>"):o.empty()},_replotWideScreen:function(t){if(t.size>0){for(var o=[],n=[],a=[],r=0;r<t.size;r++)o.push({x:t.elevations[r].dist,y:t.elevations[r].z,lat:t.elevations[r].lat,lng:t.elevations[r].lng}),n.push({x:t.elevations[r].dist,y:t.elevations[r].slopeOnTrack,lat:t.elevations[r].lat,lng:t.elevations[r].lng}),a.push({x:t.elevations[r].dist,y:t.elevations[r].slope,lat:t.elevations[r].lat,lng:t.elevations[r].lng});var i=t.size-1;s.options.scales.xAxes[0].ticks.max=o[i].x,s.config.data.datasets[0].data=o,s.config.data.datasets[1].data=n,s.config.data.datasets[2].data=a,t.annotations[0].value=t.total.altMax,t.annotations[0].label.content="Altitude max: "+Math.round(t.total.altMax)+"m; D+: "+Math.round(t.total.denivPos)+"m",t.annotations[1].value=t.total.altMin,t.annotations[1].label.content="Altitude min: "+Math.round(t.total.altMin)+"m; D-: "+Math.round(t.total.denivNeg)+"m",t.annotations[2].value=o[i].x,t.annotations[2].label.content="Distance: "+Math.round(100*o[i].x)/100+"km";var l=document.getElementById(e).getContext("2d").createLinearGradient(0,0,0,120),u=10*Math.ceil(t.total.slopeMax/10),c=10*Math.floor(t.total.slopeMin/10),d=-c+u;0!=d&&(u>=45&&l.addColorStop((u-45)/d,"purple"),u>=40&&l.addColorStop((u-40)/d,"red"),u>=35&&l.addColorStop((u-35)/d,"orange"),u>=30&&l.addColorStop((u-30)/d,"yellow"),l.addColorStop(u/d,"grey"),c<=-30&&l.addColorStop((u+30)/d,"yellow"),c<=-35&&l.addColorStop((u+35)/d,"orange"),c<=-40&&l.addColorStop((u+40)/d,"red"),c<=-45&&l.addColorStop((u+45)/d,"purple"),s.config.data.datasets[1].backgroundColor=l);var p=document.getElementById(e).getContext("2d").createLinearGradient(0,0,0,120);p.addColorStop(0,"purple"),p.addColorStop(1-40/45,"red"),p.addColorStop(1-35/45,"orange"),p.addColorStop(1-30/45,"yellow"),p.addColorStop(1,"grey"),s.config.data.datasets[2].backgroundColor=p,s.options.annotation={},s.update(),s.options.annotation={annotations:t.annotations},s.update()}else s.options.scales.xAxes[0].ticks.max=1,s.config.data.datasets[0].data=[],s.config.data.datasets[1].data=[],s.config.data.datasets[2].data=[]},replot:function(){var t=this._compute();t.annotations=Array.concat([{id:"altmax",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:10}},{id:"altmin",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:-10}},{id:"distance",type:"line",mode:"vertical",scaleID:"distance",value:0,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",xAdjust:-50}}],t.annotations),a?this._replotSmallScreen(t):this._replotWideScreen(t),t.size>0?n.slideUp():n.slideDown()},_initStats:function(){return{distance:0,altMin:Number.MAX_VALUE,altMax:Number.MIN_VALUE,slopeMax:0,slopeMin:0,denivPos:0,denivNeg:0}},_compute:function(){var e=this,o=[],n=[],a=this._initStats(),r=this._initStats();if(t.Track.eachMarker(function(t,i){if("step"==i.getType()){o.push({id:"distance-"+t,type:"line",mode:"vertical",scaleID:"distance",value:a.distance,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1});for(var s=i;s&&s.hasRouteToHere()&&(s.getRouteToHere().setPopupContentWith(s._previousMarker.getColorCode(),r),"step"!=(s=s._previousMarker).getType()););r=e._initStats()}var l=i.getRouteFromHere(),u=l?l.getElevations():[];if(u.length>0){for(var c=0;c<u.length;c++)u[c].dist+=a.distance;n=n.concat(u),a.distance+=l.getDistance(),a.altMin=Math.min(a.altMin,l.getAltMin()),a.altMax=Math.max(a.altMax,l.getAltMax()),a.slopeMax=Math.max(a.slopeMax,l.getSlopeMax()),a.slopeMin=Math.min(a.slopeMin,l.getSlopeMin()),a.denivNeg+=l.getDenivNeg(),a.denivPos+=l.getDenivPos(),r.distance+=l.getDistance(),r.altMin=Math.min(r.altMin,l.getAltMin()),r.altMax=Math.max(r.altMax,l.getAltMax()),r.slopeMax=Math.max(r.slopeMax,l.getSlopeMax()),r.slopeMin=Math.min(r.slopeMin,l.getSlopeMin()),r.denivNeg+=l.getDenivNeg(),r.denivPos+=l.getDenivPos()}}),r.distance>0)for(var i=t.Track.getLastMarker();i&&i.hasRouteToHere()&&(i.getRouteToHere().setPopupContentWith(i._previousMarker.getColorCode(),r),"step"!=(i=i._previousMarker).getType()););return{size:n.length,elevations:n,total:a,annotations:o}}}}(jQuery),function(t){t.Route={bindTo:function(t){this.map=t},find:function(e,o,n){var a=this;return"straight"==(arguments.length>3&&void 0!==arguments[3]?arguments[3]:"auto")?this._findStraight(e,o,n):t.Deferred(function(){var r=this;a._findAuto(e,o,n).done(r.resolve).progress(r.notify).fail(function(){console.log(this.error),console.log("Trying straight line...");var i=new Drop({target:t(".awesome-marker").eq(n+1)[0],classes:"drop-theme-arrows",position:"right middle",constrainToWindow:!1,constrainToScrollParent:!1,openOn:null,content:"Impossible d'obtenir le tracé en mode automatique. Le mode ligne droite va être utilisé."});i.open(),t(i.content).on("click",function(){i.destroy()}),a._findStraight(e,o,n).done(r.resolve).fail(r.reject)})})},_add:function(e,o,n,a,r){var i=this;return t.Deferred(function(){var t=this;e.prepareForMap(i.map),e.computeStats().progress(t.notify).then(function(){e.addTo(i.map),e.bindPopup("Calculs en cours..."),e.snakeIn(),o.setOpacity(1),n.setOpacity(1),t.resolveWith({route:e})}).fail(function(){t.rejectWith({error:"Impossible d'obtenir les données de la route"})})})},_findAuto:function(e,o,n){var a=this;return t.Deferred(function(){var r=this,i=e.getLatLng(),s=o.getLatLng(),l={distanceUnit:"m",endPoint:{x:s.lng,y:s.lat},exclusions:[],geometryInInstructions:!0,graph:"Pieton",routePreferences:"fastest",startPoint:{x:i.lng,y:i.lat},viaPoints:[],apiKey:keyIgn,onSuccess:function(i){if(i){var s=L.geoJSON([],{color:e.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3}),l={type:"FeatureCollection",features:[]},u=1;t.each(i.routeInstructions,function(t,e){u++,l.features.push({id:u,type:"Feature",geometry:e.geometry})}),s.addData(l),r.notify({progress:.5,step:"Route calculée"}),a._add(s,e,o,n,"auto").progress(function(t){t.progress=.5+t.progress/2,r.notify(t)}).done(r.resolve).fail(r.reject)}else r.rejectWith({error:"Impossible d'obtenir la route: pas de résultats fournis"})},onFailure:function(t){r.rejectWith({error:"Impossible d'obtenir la route: "+t.message})}};r.notify({progress:0,status:"Calcul de la route..."}),Gp.Services.route(l)})},_findStraight:function(e,o,n){var a=this;return t.Deferred(function(){var t=this;t.notify({progress:0,status:"Calcul de la route..."});for(var r=e.getLatLng().roundE8(),i=o.getLatLng().roundE8(),s=r.distanceTo(i),l=r.bearingTo(i),u=[r],c=10;c<s;c+=10)u.push(r.getDestinationAlong(l,c));u.push(i);var d=L.polyline(u,{color:e.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3});t.notify({progress:.5,step:"Route calculée"}),a._add(d,e,o,n,"straight").progress(function(e){e.progress=.5+e.progress/2,t.notify(e)}).done(t.resolve).fail(t.reject)})}}}(jQuery),function(t){var e={red:"#D63E2A",orange:"#F59630",green:"#72B026",blue:"#38AADD",purple:"#D252B9",darkred:"#A23336",darkblue:"#0067A3",darkgreen:"#728224",darkpurple:"#5B396B",cadetblue:"#436978",lightred:"#FF8E7F",beige:"#FFCB92",lightgreen:"#BBF970",lightblue:"#8ADAFF",pink:"#FF91EA",white:"#FBFBFB",lightgray:"#A3A3A3",gray:"#575757",black:"#303030"},o=["blue","green","orange","purple","red","darkblue","darkpurple","lightblue","lightgreen","beige","pink","lightred"];t.Track={currentColor:0,markersLength:0,bindTo:function(t){this.map=t},getCurrentColor:function(){return this.currentColor},nextColor:function(){return this.currentColor=(this.currentColor+1)%o.length,this.currentColor},lengthOfMarkers:function(){return this.markersLength},hasMarkers:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.markersLength>=t},hasRoutes:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this.markersLength-1>=t},isImport:function(){return this.hasRoutes()&&"import"==this.getFirstMarker().getRouteModeFromHere()},getBounds:function(){var t=L.latLngBounds(this.getFirstMarker(0).getLatLng(),this.getLastMarker().getLatLng());return this.eachRoute(function(e,o){t.extend(o.getBounds())}),t},getFirstMarker:function(){return this.firstMarker},getLastMarker:function(){return this.lastMarker},clear:function(){this.eachMarker(function(t,e){e.remove(!1)}),t.State.triggerMarkersChanged()},eachMarker:function(t){for(var e=this.firstMarker,o=0;e;){var n=e._nextMarker;t.call(e,o,e),e=n,o++}},eachRoute:function(t){for(var e=this.firstMarker,o=0;e;){var n=e.getRouteFromHere();n&&(t.call(n,o,n),o++),e=e._nextMarker}},addMarker:function(e){var o,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return void 0===this.firstMarker&&(this.firstMarker=e),void 0!==this.lastMarker&&n&&(o=this.lastMarker.computeRouteTo(e,t.State.getMode())),this.lastMarker=e,this.markersLength++,e.addTo(this.map),o||t.Deferred(function(){this.resolve()})},exportGpx:function(e){var o=!1;try{o=!!new Blob}catch(t){}if(!o)return!1;var n='<?xml version="1.0"?>\n';n+='<gpx creator="map2gpx.fr" version="1.0" xmlns="http://www.topografix.com/GPX/1/1"',n+=' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',n+=' xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n',n+="    <trk>\n",n+="        <name>"+e+"</name>\n",n+="        <trkseg>\n",this.eachMarker(function(o,a){a.hasRouteFromHere()&&("step"==a.getType()&&(n+="        </trkseg>\n",n+="    </trk>\n",n+="    <trk>\n",n+="        <name>"+e+"-"+o+"</name>\n",n+="        <trkseg>\n"),t.each(a.getRouteFromHere().getLatLngs(),function(e,o){n+='            <trkpt lat="'+o.lat+'" lon="'+o.lng+'">',t.Cache.hasAltitude(o)&&(n+="<ele>"+t.Cache.getAltitude(o)+"</ele>"),n+="</trkpt>\n"}))}),n+="        </trkseg>\n",n+="    </trk>\n",n+="</gpx>\n";var a=new Blob([n],{type:"application/gpx+xml;charset=utf-8"});return saveAs(a,e+".gpx"),!0},exportKml:function(e){var o=!1;try{o=!!new Blob}catch(t){}if(!o)return!1;var n='<?xml version="1.0" encoding="UTF-8"?>\n';n+='<kml xmlns="http://www.opengis.net/kml/2.2"',n+=' xmlns:gx="http://www.google.com/kml/ext/2.2"',n+=' xmlns:kml="http://www.opengis.net/kml/2.2"',n+=' xmlns:atom="http://www.w3.org/2005/Atom">\n',n+="    <Document>\n",n+="        <name>"+e+".kml</name>\n",n+="        <Placemark>\n",n+="            <name>"+e+"</name>\n",n+="            <LineString>\n",n+="                <tessellate>1</tessellate>\n",n+="                <coordinates>\n",n+="                    ",this.eachMarker(function(o,a){a.hasRouteFromHere()&&("step"==a.getType()&&(n+="\n                </coordinates>\n",n+="            </LineString>\n",n+="        </Placemark>\n",n+="        <Placemark>\n",n+="            <name>"+e+"-"+o+"</name>\n",n+="            <LineString>\n",n+="                <tessellate>1</tessellate>\n",n+="                <coordinates>\n",n+="                    "),t.each(a.getRouteFromHere().getLatLngs(),function(t,e){n+=e.lng+","+e.lat+",0 "}))}),n+="\n                </coordinates>\n",n+="            </LineString>\n",n+="        </Placemark>\n",n+="    </Document>\n",n+="</kml>\n";var a=new Blob([n],{type:"text/plain;charset=utf-8"});return saveAs(a,e+".kml"),!0},_removeMarker:function(t){this.firstMarker===t&&(this.firstMarker=t._nextMarker),this.lastMarker===t&&(this.lastMarker=t._previousMarker),this.markersLength--}},L.Marker.Routed=L.Marker.extend({options:{type:"waypoint",color:0},initialize:function(t,e){L.Marker.prototype.initialize.call(this,t,e),L.setOptions(this,e),this.setType(this.options.type)},getColorCode:function(){return o[this.options.color]},getColorRgb:function(){return e[o[this.options.color]]},getColorIndex:function(){return this.options.color},setColorIndex:function(t){this.options.color=t,this.setType(this.options.type),this.routeFrom&&this.routeFrom.setStyle({color:this.getColorRgb()})},getType:function(){return this.options.type},setType:function(t){this.options.type=t,"waypoint"==t?this.setIcon(L.AwesomeMarkers.icon({icon:"circle",markerColor:this.getColorCode(),prefix:"fa"})):this.setIcon(L.AwesomeMarkers.icon({icon:"asterisk",markerColor:this.getColorCode(),prefix:"fa"}))},promoteToStep:function(){for(var e=t.Track.nextColor(),o=this;o&&"step"!=o.options.type;)o.setColorIndex(e),o=o._nextMarker;this.setType("step"),t.State.triggerMarkersChanged()},demoteToWaypoint:function(){if(this.setType("waypoint"),this.hasRouteToHere())for(var e=this._previousMarker.getColorIndex(),o=this;o&&"step"!=o.options.type;)o.setColorIndex(e),o=o._nextMarker;t.State.triggerMarkersChanged()},hasRouteToHere:function(){return this._previousMarker&&this._previousMarker.hasRouteFromHere()},getRouteToHere:function(){return this._previousMarker.routeFrom},hasRouteFromHere:function(){return!!this.routeFrom},getRouteFromHere:function(){return this.routeFrom},getRouteModeFromHere:function(){return this._mode},deleteRouteFromHere:function(){this._nextMarker&&(this._nextMarker._previousMarker=void 0),this.routeFrom&&this.routeFrom.remove(),this.attachRouteFrom(void 0,null,void 0)},computeRouteTo:function(e,o){var n=this;return this.routeFrom&&(o=o||this._mode||"auto",this.deleteRouteFromHere()),t.Route.find(this,e,0,o).done(function(){n.attachRouteFrom(e,this.route,o)})},recomputeRouteFromHere:function(t){return this.computeRouteTo(this._nextMarker,t)},recomputeRouteToHere:function(t){return this._previousMarker.computeRouteTo(this,t)},attachRouteFrom:function(t,e,o){this._nextMarker=t,t&&(t._previousMarker=this),this.routeFrom=e,this._mode=o},remove:function(){var e,o=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];"step"==this.options.type&&o&&this.demoteToWaypoint();var n=this._previousMarker,a=this._nextMarker;if(t.Track._removeMarker(this),this.routeFrom&&this.deleteRouteFromHere(),n&&(n.deleteRouteFromHere(),a&&o)){var r=t.State.getMode()||this._mode||"auto";e=n.computeRouteTo(a,r)}return L.Marker.prototype.remove.call(this),e||t.Deferred(function(){this.resolve()})}}),L.Marker.routed=function(t,e){return new L.Marker.Routed(t,e)}}(jQuery);var isSmallScreen=window.innerWidth<=800&&window.innerHeight<=600;$("<div>Observation des faucons crécerelle...</div>").insertAfter($("#loading h2")).fadeOut(2e3,function(){this.remove()}),window.onload=function(){$("<div>Localisation des chamois...</div>").insertAfter($("#loading h2")).fadeOut(2e3,function(){this.remove()});var t=L.map("map",{});t.initView().done(function(){function e(t){if(null!==$.State.getMode()&&!$.State.getComputing()){$.State.setComputing(!0);var e=L.latLng(Math.roundE8(t.latlng.lat),Math.roundE8(t.latlng.lng)),o=L.Marker.routed(e,{riseOnHover:!0,draggable:!0,opacity:.5,color:$.Track.hasMarkers()?$.Track.getLastMarker().getColorIndex():$.Track.getCurrentColor(),type:"waypoint"}).bindPopup('<button class="marker-promote-button"><i class="fa fa-asterisk" aria-hidden="true"></i> Marquer comme étape</button> <button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>');o.on("popupopen",function(){var t=this;$(".marker-delete-button:visible").click(function(){$.State.getComputing()||($.State.setComputing(!0),t.remove().progress($.State.updateComputing).done(function(){$.State.setComputing(!1)}).fail(function(){$.State.setComputing(!1)}))}),$(".marker-promote-button:visible").click(function(){$.State.setComputing(!0),t.closePopup(),t.setPopupContent('<button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>'),t.promoteToStep(),$.State.setComputing(!1)})}),o.on("moveend",function(t){$.State.setComputing(!0),t.target.setOpacity(.5);var e=[],o=[];if(t.target.hasRouteFromHere()){var n=e.length;o.push(0),e.push(t.target.recomputeRouteFromHere($.State.getMode()).progress(function(t){o[n]=t.progress,t.progress=o,$.State.updateComputing(t)}))}if(t.target.hasRouteToHere()){var a=e.length;o.push(0),e.push(t.target.recomputeRouteToHere($.State.getMode()).progress(function(t){o[a]=t.progress,t.progress=o,$.State.updateComputing(t)}))}$.when.apply($,e).done(function(){$.State.setComputing(!1),t.target.setOpacity(1)}).fail(function(){$.State.setComputing(!1)})}),$.Track.addMarker(o).progress($.State.updateComputing).done(function(){o.setOpacity(1),$.State.setComputing(!1)}).fail(function(){$.State.setComputing(!1)}),isSmallScreen||($.Track.hasMarkers(2)&&!$.Shepherd.has(1)&&$.Shepherd.tour().add("data",{text:$("#help-data")[0],attachTo:{element:$("#data")[0],on:"top"}}).add("closeloop",{text:$("#help-closeloop")[0],attachTo:{element:$("#btn-closeloop")[0],on:"right"}}).add("export",{text:$("#help-export")[0],attachTo:{element:$("#btn-export")[0],on:"right"}}).start(),$.Track.hasMarkers(3)&&!$.Shepherd.has(2)&&$.Shepherd.tour().add("movemarker",{text:$("#help-movemarker")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).add("movemarker2",{text:$("#help-movemarker2")[0],attachTo:{element:$(".awesome-marker").eq(-2)[0],on:"bottom"}}).add("steps",{text:$("#help-steps")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).start())}}$("<div>Suivi des renards roux...</div>").insertAfter($("#loading h2")).fadeOut(2e3,function(){this.remove()}),isSmallScreen&&$("#mobile-warning").show().find("button").click(function(){popup.hide()}),$.Route.bindTo(t),$.Track.bindTo(t),$("body").on("map2gpx:modechange",function(e){t.doubleClickZoom.setEnabled(null===e.mode)});var o=[],n=L.geoportalLayer.WMTS({layer:"ORTHOIMAGERY.ORTHOPHOTOS",apiKey:keyIgn}).addTo(t);o.push($.Deferred(function(){n.once("load",this.resolve)}));var a=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.SLOPES.MOUNTAIN",apiKey:keyIgn},{opacity:.25}).addTo(t),r=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn},{opacity:.25}).addTo(t);if(o.push($.Deferred(function(){r.once("load",this.resolve)})),L.geoportalControl.SearchEngine({displayAdvancedSearch:!1}).addTo(t),!isSmallScreen){var i=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn});o.push($.Deferred(function(){i.once("load",this.resolve)}));new L.Control.MiniMap(i,{position:"bottomleft",zoomLevelOffset:-4}).addTo(t)}var s=L.geoportalControl.LayerSwitcher({collapsed:isSmallScreen});t.addControl(s),s.setVisibility(a,!1),$(".GPlayerRemove").remove(),isSmallScreen||t.addControl(L.control.scale({imperial:!1,position:"bottomright"}));var l=L.easyButton({id:"btn-autotrace",states:[{stateName:"loaded",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(t,e){$.State.setMode("auto")}},{stateName:"active",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(t,e){$.State.setMode(null)}}]});$("body").on("map2gpx:modechange map2gpx:markerschange",function(t){"auto"==t.mode?(l.state("active"),l.enable()):(l.state("loaded"),l.setEnabled(!$.Track.isImport()))});var u=L.easyButton({id:"btn-straighttrace",states:[{stateName:"loaded",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(t,e){$.State.setMode("straight")}},{stateName:"active",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(t,e){$.State.setMode(null)}}]});$("body").on("map2gpx:modechange map2gpx:markerschange",function(t){"straight"==t.mode?(u.state("active"),u.enable()):(u.state("loaded"),u.setEnabled(!$.Track.isImport()))});var c=L.easyButton({id:"btn-closeloop",states:[{stateName:"loaded",icon:"fa-magic",title:"Fermer la boucle",onClick:function(t,o){$.Track.hasMarkers(1)&&e({latlng:$.Track.getFirstMarker().getLatLng()})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Fermer la boucle (calcul en cours...)"}]});$("body").on("map2gpx:modechange map2gpx:computingchange map2gpx:markerschange",function(t){t.computing?(c.state("computing"),c.disable()):(c.state("loaded"),c.setEnabled(null!==t.mode&&$.Track.hasRoutes()&&!$.Track.isImport()))}),L.easyBar([l,u,c]).addTo(t);var d=L.popup().setContent(L.DomUtil.get("form-export")),p=L.easyButton({id:"btn-export",states:[{stateName:"loaded",icon:"fa-cloud-download",title:"Exporter",onClick:function(t,e){var o=$.Track.getBounds();e.flyToBounds(o,{padding:[50,50]}),d.setLatLng(o.getCenter()).openOn(e),$(".export-gpx-button:visible").click(function(){var t=$(this);t.attr("disabled","disabled"),$.Track.exportGpx($(".export-filename:visible").val()),t.removeAttr("disabled")}),$(".export-kml-button:visible").click(function(){var t=$(this);t.attr("disabled","disabled"),$.Track.exportKml($(".export-filename:visible").val()),t.removeAttr("disabled")})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Exporter (calcul en cours...)"}]}).addTo(t);$("body").on("map2gpx:computingchange map2gpx:markerschange",function(t){t.computing?(p.state("computing"),p.disable()):(p.state("loaded"),p.setEnabled($.Track.hasRoutes()))});var h=L.popup().setContent(L.DomUtil.get("form-import")),g=L.easyButton({id:"btn-import",states:[{stateName:"loaded",icon:"fa-cloud-upload",title:"Importer",onClick:function(t,e){h.setLatLng(e.getCenter()).openOn(e),$.Track.hasRoutes()?$(".import-gpx-status:visible").html("<strong>Attention:</strong> l'import va effacer l'itinéraire existant!"):$(".import-gpx-status:visible").text(""),$(".import-gpx-button:visible").click(function(){var t=$(this),o=$(".import-gpx-file:visible")[0].files[0];if(void 0!=o){t.attr("disabled","disabled"),$.State.setComputing(!0),$.State.updateComputing({progress:0,status:"Importation en cours..."});var n=new FileReader;n.onload=function(o){var n=[];new L.GPX(o.target.result,{async:!0,onFail:function(){console.log("Failed to retrieve track"),$(".import-gpx-status:visible").text("Impossible de traiter ce fichier"),t.removeAttr("disabled"),$.State.setComputing(!1)},onSuccess:function(o){$.State.updateComputing({progress:1/(n.length+1),status:"Récupération des données géographiques en cours...",step:"Fichier traité"}),$.Track.clear();var a=o.getBounds();e.fitBounds(a,{padding:[50,50]}),h.setLatLng(a.getCenter()),o.addTo(e);var r,i=function(){$(".track-delete-button:visible").click(function(){$.State.setComputing(!0),$.Track.clear(),e.removeLayer(o),$.State.setComputing(!1)})},s=[],l=[1];$.each(n,function(t,e){if(0==t){var o=e.getLatLngs()[0];r=L.Marker.routed(o,{draggable:!1,opacity:.5,color:$.Track.getCurrentColor(),type:"waypoint"}),$.Track.addMarker(r,!1),r.bindPopup('<button class="track-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer l\'import</button>'),r.on("popupopen",i)}var n=e.getLatLngs()[e.getLatLngs().length-1],a=L.Marker.routed(n,{draggable:!1,opacity:.5,color:$.Track.nextColor(),type:"step"});$.Track.addMarker(a,!1),r.attachRouteFrom(a,e,"import"),e.setStyle({weight:5,color:r.getColorRgb(),opacity:.5}),e.bindPopup("Calculs en cours..."),a.bindPopup('<button class="track-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer l\'import</button>'),a.on("popupopen",i),l.push(0),s.push(e.computeStats().progress(function(e){l[t+1]=e.progress,e.progress=l,$.State.updateComputing(e)})),r=a}),$.when.apply($,s).done(function(){$.Track.eachRoute(function(t,e){e.setStyle({opacity:.75})}),$.Track.eachMarker(function(t,e){e.setOpacity(1)}),t.removeAttr("disabled"),h.remove(),$.State.triggerMarkersChanged(),$.State.setMode(null),$.State.setComputing(!1)}).fail(function(){console.log("Fail"),$(".import-gpx-status:visible").text("Impossible de récupérer les données géographiques de ce parcours"),t.removeAttr("disabled"),$.State.setComputing(!1)})}}).on("addline",function(t){n.push(t.line)})},n.readAsText(o)}else $(".import-gpx-status:visible").text("Veuillez sélectionner un fichier")})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Importer (calcul en cours...)"}]}),m=L.easyButton({id:"btn-reset",states:[{stateName:"loaded",icon:"fa-trash",title:"Effacer l'itinéraire",onClick:function(t,e){$.State.setComputing(!0),$.Track.clear(),$.State.setComputing(!1)}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Effacer l'itinéraire (calcul en cours...)"}]});if(L.easyBar([g,m]).addTo(t),$("body").on("map2gpx:computingchange",function(t){g.state(t.computing?"computing":"loaded"),m.state(t.computing?"computing":"loaded"),g.setEnabled(!t.computing),m.setEnabled(!t.computing)}),!isSmallScreen){var f=L.popup().setContent(L.DomUtil.get("about")),v=L.easyButton({position:"bottomright",states:[{icon:"fa-info-circle",onClick:function(t,e){f.setLatLng(e.getCenter()).openOn(e)},title:"A propos & crédits"}]}),M=L.easyButton({position:"bottomright",states:[{icon:"fa-question-circle",onClick:function(t,e){$.Shepherd.get(0).start(!0)},title:"Aide"}]});L.easyBar([v,M],{position:"bottomright"}).addTo(t)}t.on("dblclick",e);var k;t.on("zoomend",function(){var e=void 0,o=void 0;(n.options.minZoom>t.getZoom()||n.options.maxZoom<t.getZoom())&&t.hasLayer(n)?(e="Photographies aériennes",o=$(".GPlayerSwitcher_layer:eq(2)")):(r.options.minZoom>t.getZoom()||r.options.maxZoom<t.getZoom())&&t.hasLayer(r)?(e="Cartes IGN",o=$(".GPlayerSwitcher_layer:eq(0)")):(a.options.minZoom>t.getZoom()||a.options.maxZoom<t.getZoom())&&t.hasLayer(a)&&(e="Carte des pentes",o=$(".GPlayerSwitcher_layer:eq(1)")),void 0!==e&&void 0===k?((k=new Drop({target:o[0],classes:"drop-theme-arrows",position:"left middle",constrainToWindow:!1,constrainToScrollParent:!1,openOn:null,content:"La couche &quot;"+e+"&quot; n'est pas disponible à ce niveau de zoom"})).open(),$(k.content).on("click",function(){k.destroy(),k=null})):void 0===e&&void 0!==k&&null!==k&&(k.destroy(),k=null)}),$("body").on("map2gpx:computingchange",function(t){t.computing?($.State.updateComputing({progress:0,status:"Calculs en cours..."}),$("#data-computing").fadeIn()):($.State.updateComputing({progress:1,status:"Finalisation..."}),$.Chart.replot(),$("#data-computing").fadeOut())}),$("<div>Alignement des satellites...</div>").insertAfter($("#loading h2")).fadeOut(2e3,function(){this.remove()}),$.Chart.init(t,"chart",$("#data"),$("#data-empty"),isSmallScreen),$.State.setMode(null),$.State.triggerMarkersChanged(),$.State.setComputing(!1),isSmallScreen||$.Shepherd.tour().add("welcome",{text:$("#help-welcome")[0]}).add("layers",{text:$("#help-layers")[0],attachTo:{element:$(".GPlayerName").closest(".GPwidget")[0],on:"left"}}).add("search",{text:$("#help-search")[0],attachTo:{element:$(".GPshowAdvancedToolOpen").closest(".GPwidget")[0],on:"right"}}).add("autotrace",{text:$("#help-autotrace")[0],attachTo:{element:$("#btn-autotrace")[0],on:"right"}}).add("straighttrace",{text:$("#help-straighttrace")[0],attachTo:{element:$("#btn-straighttrace")[0],on:"right"}}).start(),$.when.apply($,o).done(function(){clearInterval(interval),$("#loading").fadeOut()})})};