"use strict";function storageAvailable(e){var t;try{var a="__storage_test__";return(t=window[e]).setItem(a,a),t.removeItem(a),!0}catch(e){return e instanceof DOMException&&(22===e.code||1014===e.code||"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name)&&0!==t.length}}jQuery.QueryString=function(e){for(var t={},a=0;a<e.length;++a){var n=e[a].split("=",2);2===n.length&&(t[n[0]]=decodeURIComponent(n[1].replace(/\+/g," ")))}return t}(window.location.search.substr(1).split("&")),function(e){var t=[];e.Shepherd={},e.Shepherd.Step=function(){var t,a;return{init:function(n,o){return t=n,a=e.extend({},o,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"}),this}}},e.Shepherd.step=function(t,a){return e.Shepherd.Step().init(t,a)},e.Shepherd.Tour=function(){var a,n=0;return{init:function(t){var n=e.extend({},t,{defaults:{classes:"shepherd-element shepherd-open shepherd-theme-arrows",showCancelLink:!0}});return a=new Shepherd.Tour(n),this},add:function(o,r){var i=this,l=n,s=e.extend({},r,{classes:"shepherd shepherd-open shepherd-theme-arrows shepherd-transparent-text"});return s.buttons=[{text:"Fermer",classes:"shepherd-button-secondary",action:function(){hasLocalStorage&&localStorage.setItem("tutorial"+t.indexOf(i),-1),i.cancel()}},{text:"Suivant",classes:"shepherd-button-example-primary",action:function(){var e=t.indexOf(i);e<0&&console.log("Could not find current shepherd, something is probably wrong"),hasLocalStorage&&localStorage.setItem("tutorial"+e,l+1),i.next(),l==n-1&&e>=0&&e<t.length-1&&t[e+1].start(!0)}}],a.addStep(o,s),n++,this},start:function(e){var o=0;if(void 0===e||!e){var r=t.indexOf(this);hasLocalStorage&&null!==localStorage.getItem("tutorial"+r)&&(o=parseInt(localStorage.getItem("tutorial"+r)))}return o>=0&&o<n&&a.show(o),this},cancel:function(){return a.cancel(),this},next:function(){return a.next(),this}}},e.Shepherd.tour=function(a){var n=e.Shepherd.Tour().init(a);return t.push(n),n},e.Shepherd.get=function(e){return t[e]},e.Shepherd.has=function(e){return t.length>e}}(jQuery),function(e){var t=null,a=!1;e.State={},e.State.setMode=function(n){t=n,e("body").trigger(e.Event("map2gpx:modechange",{mode:t,computing:a}))},e.State.setComputing=function(n){a=n,e("body").trigger(e.Event("map2gpx:computingchange",{mode:t,computing:a}))},e.State.triggerMarkersChanged=function(){e("body").trigger(e.Event("map2gpx:markerschange",{mode:t,computing:a}))},e.State.getMode=function(){return t},e.State.getComputing=function(){return a}}(jQuery),function(e){var t=[],a=[],n={},o={};e.Cache={};var r=function(e){return e.lng+"/"+e.lat};e.Cache.addAltitude=function(e,t,a){n[t+"/"+e]=a},e.Cache.getAltitude=function(e){var t=r(e);return t in n?n[t]:null},e.Cache.hasAltitude=function(e){return r(e)in n},e.Cache.addSlope=function(e,t,a){o[t+"/"+e]=a},e.Cache.getSlope=function(e){var t=r(e);return t in o?o[t]:null},e.Cache.hasSlope=function(e){return r(e)in o},e.Cache.getInfos=function(e){var t=r(e);return{z:t in n?n[t]:null,slope:t in o?o[t]:null}},e.Cache.lengthOfMarkers=function(){return t.length},e.Cache.hasMarkers=function(e){var a=void 0!==e?e:1;return t.length>=a},e.Cache.getMarker=function(e){var a=e>=0?e:t.length+e;return t[a]},e.Cache.indexOfMarker=function(e){return t.indexOf(e)},e.Cache.eachMarker=function(a){e.each(t,function(e,t){return a(e,t)})},e.Cache.addMarker=function(e){t.push(e)},e.Cache.removeMarkerAt=function(e){var a=e>=0?e:t.length+e;t.splice(a,1)},e.Cache.resetMarkers=function(){t.length=0},e.Cache.lengthOfRoutes=function(){return a.length},e.Cache.hasRoutes=function(e){var t=void 0!==e?e:1;return a.length>=t},e.Cache.getRoute=function(e){var n=e>=0?e:t.length+e;return a[n][0]},e.Cache.getRouteMode=function(e){var n=e>=0?e:t.length+e;return a[n][1]},e.Cache.eachRoute=function(t){e.each(a,function(e,a){return t(e,a[0])})},e.Cache.addRoute=function(e,t){a.push([e,t])},e.Cache.setRouteAt=function(e,n,o){var r=e>=0?e:t.length+e;a[r]=[n,o]},e.Cache.removeRouteAt=function(e){var n=e>=0?e:t.length+e;a.splice(n,1)},e.Cache.resetRoutes=function(){a.length=0}}(jQuery);var isSmallScreen=window.innerWidth<=800&&window.innerHeight<=600,hasLocalStorage=storageAvailable("localStorage");window.onload=function(){$.Deferred(function(){var e=this,t=[44.96777356135154,6.06822967529297,13];if(hasLocalStorage&&null!==localStorage.getItem("view")&&(t=JSON.parse(localStorage.getItem("view"))),"lat"in $.QueryString&&"lng"in $.QueryString&&(t=[$.QueryString.lat,$.QueryString.lng,15]),"loc"in $.QueryString){var a={text:$.QueryString.loc,filterOptions:{type:["StreetAddress","PositionOfInterest"]},apiKey:keyIgn,onSuccess:function(a){a&&"suggestedLocations"in a&&a.suggestedLocations.length>0?e.resolveWith([a.suggestedLocations[0].position.y,a.suggestedLocations[0].position.x,15]):(console.log("No results?"),e.resolveWith(t))},onFailure:function(a){console.log(a),e.resolveWith(t)}};Gp.Services.autoComplete(a)}else e.resolveWith(t)}).done(function(){function e(){return v=(v+1)%f.length}function t(e,t){t?e.enable():e.disable()}function a(e,t){var a=Math.radians(e.lat),n=Math.radians(t.lat),o=(n-a)/2,r=Math.radians(t.lng-e.lng)/2,i=Math.sin(o)*Math.sin(o)+Math.sin(r)*Math.sin(r)*Math.cos(a)*Math.cos(n);return 12756274*Math.atan2(Math.sqrt(i),Math.sqrt(1-i))}function n(e,t,a){var n=6378137,o=Math.radians(t),r=Math.radians(e.lat),i=Math.radians(e.lng),l=Math.asin(Math.sin(r)*Math.cos(a/n)+Math.cos(r)*Math.sin(a/n)*Math.cos(o)),s=i+Math.atan2(Math.sin(o)*Math.sin(a/n)*Math.cos(r),Math.cos(a/n)-Math.sin(r)*Math.sin(l));return l=Math.degrees(l),s=Math.degrees(s),L.latLng(Math.roundE8(l),Math.roundE8(s))}function o(e,t){var a=Math.radians(e.lat),n=Math.radians(e.lng),o=Math.radians(t.lat),r=Math.radians(t.lng),i=Math.log(Math.tan(o/2+Math.PI/4)/Math.tan(a/2+Math.PI/4)),l=r-n;return Math.abs(l)>Math.PI&&(l=l>0?-(2*Math.PI-l):2*Math.PI+l),(Math.degrees(Math.atan2(l,i))+360)%360}function r(e,t,r){return $.Deferred(function(){for(var i=this,l=function(e){console.log(e),$.Cache.setRouteAt(r,null,"invalid"),i.reject()},s=e.getLatLng().roundE8(),c=t.getLatLng().roundE8(),u=a(s,c),d=o(s,c),g=[s],h=5;h<u;h+=5)g.push(n(s,d,h));g.push(c);var p=L.polyline(g,{color:e.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3});p.computeStats().then(function(){$.Cache.setRouteAt(r,p,"straight"),p.addTo(C),p.bindPopup("Calculs en cours..."),p.snakeIn(),e.setOpacity(1),t.setOpacity(1),i.resolve()}).fail(function(){l("Impossible d'obtenir les données de la route")})})}function i(e,t,a,n,o){var r=t.latLngToPoint(e,a).floor(),i=r.divideBy(n).floor(),l=i.multiplyBy(n).subtract(o);return{tile:i,tilePixel:r.subtract(o).subtract(l)}}function l(e,t,a){return $.Deferred(function(){var n=this,o=function(o){console.log(o),console.log("Trying straight line..."),r(e,t,a).done(function(){n.resolve()}).fail(function(){n.reject()})},i=e.getLatLng(),l=t.getLatLng(),s={distanceUnit:"m",endPoint:{x:l.lng,y:l.lat},exclusions:[],geometryInInstructions:!0,graph:"Pieton",routePreferences:"fastest",startPoint:{x:i.lng,y:i.lat},viaPoints:[],apiKey:keyIgn,onSuccess:function(r){if(r){var i=L.geoJSON([],{color:e.getColorRgb(),weight:5,opacity:.75,snakingPause:0,snakingSpeed:1e3}),l={type:"FeatureCollection",features:[]},s=1;$.each(r.routeInstructions,function(e,t){s++,l.features.push({id:s,type:"Feature",geometry:t.geometry})}),i.addData(l);i.computeStats().then(function(){$.Cache.setRouteAt(a,i,"auto"),i.addTo(C),i.bindPopup("Calculs en cours..."),i.snakeIn(),e.setOpacity(1),t.setOpacity(1),n.resolve()}).fail(function(){o("Impossible d'obtenir les données de la route")})}else o("Impossible d'obtenir la route")},onFailure:function(e){o("Impossible d'obtenir la route: "+e.message)}};Gp.Services.route(s)})}function s(t){if(null!==$.State.getMode()&&!$.State.getComputing()){$.State.setComputing(!0);var a=[],n=L.latLng(Math.roundE8(t.latlng.lat),Math.roundE8(t.latlng.lng)),o=L.marker(n,{riseOnHover:!0,draggable:!0,opacity:.5}).bindPopup('<button class="marker-promote-button"><i class="fa fa-asterisk" aria-hidden="true"></i> Marquer comme étape</button> <button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>');if(o.on("popupopen",function(){var t=this;$(".marker-delete-button:visible").click(function(){C.removeLayer(t)}),$(".marker-promote-button:visible").click(function(){$.State.setComputing(!0),t.setPopupContent('<button class="marker-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer ce marqueur</button>'),t.setColorIndex(e()),t.setType("step");var a=t.getColorRgb(),n=$.Cache.indexOfMarker(t);if(n>-1)for(var o=$.Cache.lengthOfMarkers(),r=n+1;r<o;r++){r>0&&$.Cache.getRoute(r-1).setStyle({color:a});var i=$.Cache.getMarker(r);if("step"==i.getType())break;i.setColorIndex(v),i.setType(i.getType())}$.State.triggerMarkersChanged(),$.State.setComputing(!1)})}),$.Cache.hasMarkers()?o.setColorIndex($.Cache.getMarker(-1).getColorIndex()):o.setColorIndex(v),o.setType("waypoint"),$.Cache.addMarker(o),o.addTo(C),$.Cache.hasMarkers(2)){isSmallScreen||$.Shepherd.has(1)||$.Shepherd.tour().add("data",{text:$("#help-data")[0],attachTo:{element:$("#data")[0],on:"top"}}).add("closeloop",{text:$("#help-closeloop")[0],attachTo:{element:$("#btn-closeloop")[0],on:"right"}}).add("export",{text:$("#help-export")[0],attachTo:{element:$("#btn-export")[0],on:"right"}}).start(),$.Cache.hasMarkers(3)&&(isSmallScreen||$.Shepherd.has(2)||$.Shepherd.tour().add("movemarker",{text:$("#help-movemarker")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).add("movemarker2",{text:$("#help-movemarker2")[0],attachTo:{element:$(".awesome-marker").eq(-2)[0],on:"bottom"}}).add("steps",{text:$("#help-steps")[0],attachTo:{element:$(".awesome-marker").last()[0],on:"bottom"}}).start());var i=$.Cache.lengthOfMarkers()-1,s=$.Cache.getMarker(i-1),c=$.Cache.getMarker(i);$.Cache.lengthOfRoutes()!=i-1&&console.log("Something wrong"),a.push("auto"==$.State.getMode()?l(s,c,i-1):r(s,c,i-1))}o.on("moveend",function(e){$.State.setComputing(!0),e.target.setOpacity(.5);var t=[],a=$.Cache.indexOfMarker(e.target);if(a>-1&&$.Cache.hasRoutes()){if(a<$.Cache.lengthOfMarkers()-1){var n=$.Cache.getRoute(a);null!=n&&C.removeLayer(n);var o=$.Cache.getMarker(a),i=$.Cache.getMarker(a+1),s=$.State.getMode()||$.Cache.getRouteMode(a)||"auto";t.push("auto"==s?l(o,i,a):r(o,i,a))}if(a>0){var c=$.Cache.getRoute(a-1);null!=c&&C.removeLayer(c);var u=$.Cache.getMarker(a-1),d=$.Cache.getMarker(a),g=$.State.getMode()||$.Cache.getRouteMode(a-1)||"auto";t.push("auto"==g?l(u,d,a-1):r(u,d,a-1))}}$.when.apply($,t).done(function(){$.State.setComputing(!1),e.target.setOpacity(1)}).fail(function(){$.State.setComputing(!1)})}),o.on("remove",function(e){if(!$.State.getComputing()){$.State.setComputing(!0);var t=[],a=$.Cache.indexOfMarker(e.target);if(a>-1){var n=$.Cache.lengthOfMarkers();if("step"==e.target.getType()&&a>0)for(var o=a+1;o<n;o++){o>0&&$.Cache.getRoute(o-1).setStyle({color:$.Cache.getMarker(a-1).getColorRgb()});var i=$.Cache.getMarker(o);if("step"==i.getType())break;i.setColorIndex($.Cache.getMarker(a-1).getColorIndex()),i.setType(i.getType())}if(0==a){if($.Cache.hasRoutes()){var s=$.Cache.getRoute(0);null!=s&&C.removeLayer(s),$.Cache.removeRouteAt(0)}}else if(a==n-1){var c=$.Cache.getRoute(a-1);null!=c&&C.removeLayer(c),$.Cache.removeRouteAt(a-1)}else{var u=$.Cache.getRoute(a-1),d=$.Cache.getRouteMode(a-1),g=$.Cache.getRoute(a);null!=u&&C.removeLayer(u),null!=g&&C.removeLayer(g),$.Cache.removeRouteAt(a);var h=$.Cache.getMarker(a-1),p=$.Cache.getMarker(a+1),m=$.State.getMode()||d||"auto";t.push("auto"==m?l(h,p,a-1):r(h,p,a-1))}$.Cache.removeMarkerAt(a)}$.when.apply($,t).done(function(){$.State.setComputing(!1)}).fail(function(){$.State.setComputing(!1)})}}),$.when.apply($,a).done(function(){o.setOpacity(1),$.State.setComputing(!1)}).fail(function(){$.State.setComputing(!1)})}}function c(e){return $.Deferred(function(){var t=this,a={apiKey:keyIgn,sampling:e.length,positions:e,onSuccess:function(e){e?($.each(e.elevations,function(e,t){$.Cache.addAltitude(t.lat,t.lon,t.z)}),t.resolve()):(console.log("Impossible d'obtenir les données d'altitude: résultats invalides"),t.reject())},onFailure:function(e){console.log("Impossible d'obtenir les données d'altitude: ",e.message),t.reject()}};Gp.Services.getAltitude(a)})}function u(e,t,a){return $.Deferred(function(){var n=this,o={tilematrix:16,tilerow:t,tilecol:e,lon:"",lat:"",x:"",y:""};$.each(a,function(e,t){e>0&&(o.lon+="|",o.lat+="|",o.x+="|",o.y+="|"),o.lon+=t.lng.toString(),o.lat+=t.lat.toString(),o.x+=t.x.toString(),o.y+=t.y.toString()}),$.getJSON("slope.php",o,function(e){e.results?($.each(e.results,function(e,t){$.Cache.addSlope(t.lat,t.lon,t.slope)}),n.resolve()):(console.log("Impossible d'obtenir les données de pente: résultats invalides"),n.reject())}).fail(function(e,t,a){console.log("Impossible d'obtenir les données de pente: ",t,a),n.reject()})})}function d(e){return $.Deferred(function(){var t=this,a=!1;try{a=!!new Blob}catch(e){}if(!a)return t.reject(),!1;var n='<?xml version="1.0"?>\n';n+='<gpx creator="map2gpx.fr" version="1.0" xmlns="http://www.topografix.com/GPX/1/1"',n+=' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"',n+=' xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n',n+="    <trk>\n",n+="        <name>"+e+"</name>\n",n+="        <trkseg>\n",$.Cache.eachRoute(function(t,a){"step"==$.Cache.getMarker(t).getType()&&(n+="        </trkseg>\n",n+="    </trk>\n",n+="    <trk>\n",n+="        <name>"+e+"-"+t+"</name>\n",n+="        <trkseg>\n"),$.each(a.getLatLngs(),function(e,t){n+='            <trkpt lat="'+t.lat+'" lon="'+t.lng+'">',$.Cache.hasAltitude(t)&&(n+="<ele>"+$.Cache.getAltitude(t)+"</ele>"),n+="</trkpt>\n"})}),n+="        </trkseg>\n",n+="    </trk>\n",n+="</gpx>\n";var o=new Blob([n],{type:"application/gpx+xml;charset=utf-8"});saveAs(o,e+".gpx"),t.resolve()})}function g(e){return $.Deferred(function(){var t=this,a=!1;try{a=!!new Blob}catch(e){}if(!a)return t.reject(),!1;var n='<?xml version="1.0" encoding="UTF-8"?>\n';n+='<kml xmlns="http://www.opengis.net/kml/2.2"',n+=' xmlns:gx="http://www.google.com/kml/ext/2.2"',n+=' xmlns:kml="http://www.opengis.net/kml/2.2"',n+=' xmlns:atom="http://www.w3.org/2005/Atom">\n',n+="    <Document>\n",n+="        <name>"+e+".kml</name>\n",n+="        <Placemark>\n",n+="            <name>"+e+"</name>\n",n+="            <LineString>\n",n+="                <tessellate>1</tessellate>\n",n+="                <coordinates>\n",n+="                    ",$.Cache.eachRoute(function(t,a){"step"==$.Cache.getMarker(t).getType()&&(n+="\n                </coordinates>\n",n+="            </LineString>\n",n+="        </Placemark>\n",n+="        <Placemark>\n",n+="            <name>"+e+"-"+t+"</name>\n",n+="            <LineString>\n",n+="                <tessellate>1</tessellate>\n",n+="                <coordinates>\n",n+="                    "),$.each(a.getLatLngs(),function(e,t){n+=t.lng+","+t.lat+",0 "})}),n+="\n                </coordinates>\n",n+="            </LineString>\n",n+="        </Placemark>\n",n+="    </Document>\n",n+="</kml>\n";var o=new Blob([n],{type:"text/plain;charset=utf-8"});saveAs(o,e+".kml"),t.resolve()})}function h(){var e=[],t=0,a=Number.MAX_VALUE,n=Number.MIN_VALUE,o=0,r=0,i=0,l=0,s=0,c=Number.MAX_VALUE,u=Number.MIN_VALUE,d=0,g=0,h=0,p=0,m=[{id:"altmax",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:10}},{id:"altmin",type:"line",mode:"horizontal",scaleID:"alt",value:0,borderColor:"rgba(12, 173, 98, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",yAdjust:-10}},{id:"distance",type:"line",mode:"vertical",scaleID:"distance",value:0,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1,label:{enabled:!0,position:"left",backgroundColor:"rgba(0,0,0,0.4)",fontSize:10,fontStyle:"normal",xAdjust:-50}}],f=0;if($.Cache.eachRoute(function(v,C){if(null!=C){if("step"==$.Cache.getMarker(v).getType()){m.push({id:"distance-"+v,type:"line",mode:"vertical",scaleID:"distance",value:t,borderColor:"rgba(0, 0, 0, 0.5)",borderWidth:1});for(var M=f;M<v;M++)$.Cache.getRoute(M).setPopupContent('<ul class="legend '+$.Cache.getMarker(M).getColorCode()+'"><li>Altitude max: '+Math.round(u)+"m</li><li>D+: "+Math.round(h)+"m</li><li>Altitude min: "+Math.round(c)+"m</li><li>D-: "+Math.round(p)+"m</li><li>Distance: "+Math.round(100*s)/100+"km</li></ul>");f=v,s=0,c=Number.MAX_VALUE,u=Number.MIN_VALUE,d=0,g=0,h=0,p=0}var y=C.getElevations();if(y.length>0){for(var S=0;S<y.length;S++)y[S].dist+=t;e=e.concat(y),t+=C.getDistance(),C.getAltMin()<a&&(a=C.getAltMin()),C.getAltMax()>n&&(n=C.getAltMax()),C.getSlopeMax()>o&&(o=C.getSlopeMax()),C.getSlopeMin()<r&&(r=C.getSlopeMin()),l+=C.getDenivNeg(),i+=C.getDenivPos(),s+=C.getDistance(),C.getAltMin()<c&&(c=C.getAltMin()),C.getAltMax()>u&&(u=C.getAltMax()),C.getSlopeMax()>d&&(d=C.getSlopeMax()),C.getSlopeMin()<g&&(g=C.getSlopeMin()),p+=C.getDenivNeg(),h+=C.getDenivPos()}}}),s>0)for(var v=f;v<$.Cache.lengthOfRoutes();v++)$.Cache.getRoute(v).setPopupContent('<ul class="legend '+$.Cache.getMarker(v).getColorCode()+'"><li>Altitude max: '+Math.round(u)+"m</li><li>D+: "+Math.round(h)+"m</li><li>Altitude min: "+Math.round(c)+"m</li><li>D-: "+Math.round(p)+"m</li><li>Distance: "+Math.round(100*s)/100+"km</li></ul>");var C=e.length;if(C>0){var M=[],y=[],S=[];if(isSmallScreen)$("#data").html("<ul><li>Altitude max: "+Math.round(n)+"m; D+: "+Math.round(i)+"m</li><li>Altitude min: "+Math.round(a)+"m; D-: "+Math.round(l)+"m</li><li>Distance: "+Math.round(100*e[C-1].dist)/100+"km</li></ul>");else{for(var b=0;b<C;b++)M.push({x:e[b].dist,y:e[b].z,lat:e[b].lat,lng:e[b].lng}),y.push({x:e[b].dist,y:e[b].slopeOnTrack,lat:e[b].lat,lng:e[b].lng}),S.push({x:e[b].dist,y:e[b].slope,lat:e[b].lat,lng:e[b].lng});var x=M.length-1;z.options.scales.xAxes[0].ticks.max=M[x].x,z.config.data.datasets[0].data=M,z.config.data.datasets[1].data=y,z.config.data.datasets[2].data=S,m[0].value=n,m[0].label.content="Altitude max: "+Math.round(n)+"m; D+: "+Math.round(i)+"m",m[1].value=a,m[1].label.content="Altitude min: "+Math.round(a)+"m; D-: "+Math.round(l)+"m",m[2].value=M[x].x,m[2].label.content="Distance: "+Math.round(100*M[x].x)/100+"km";var k=document.getElementById("chart").getContext("2d").createLinearGradient(0,0,0,120),L=10*Math.ceil(o/10),w=10*Math.floor(r/10),A=-w+L;0!=A&&(L>=45&&k.addColorStop((L-45)/A,"purple"),L>=40&&k.addColorStop((L-40)/A,"red"),L>=35&&k.addColorStop((L-35)/A,"orange"),L>=30&&k.addColorStop((L-30)/A,"yellow"),k.addColorStop(L/A,"grey"),w<=-30&&k.addColorStop((L+30)/A,"yellow"),w<=-35&&k.addColorStop((L+35)/A,"orange"),w<=-40&&k.addColorStop((L+40)/A,"red"),w<=-45&&k.addColorStop((L+45)/A,"purple"),z.config.data.datasets[1].backgroundColor=k);var _=document.getElementById("chart").getContext("2d").createLinearGradient(0,0,0,120);_.addColorStop(0,"purple"),_.addColorStop(1-40/45,"red"),_.addColorStop(1-35/45,"orange"),_.addColorStop(1-30/45,"yellow"),_.addColorStop(1,"grey"),z.config.data.datasets[2].backgroundColor=_,z.options.annotation={},z.update(),z.options.annotation={annotations:m},z.update()}$("#data-empty").slideUp()}else isSmallScreen||(z.options.scales.xAxes[0].ticks.max=1,z.config.data.datasets[0].data=[],z.config.data.datasets[1].data=[],z.config.data.datasets[2].data=[]),$("#data-empty").slideDown()}var p=this;L.LatLng.prototype.roundE8=function(){return L.latLng(Math.roundE8(this.lat),Math.roundE8(this.lng))},L.Layer.include({_elevations:[],_distance:0,_altMin:0,_altMax:0,_slopeMin:0,_slopeMax:0,_denivPos:0,_denivNeg:0,getElevations:function(){return JSON.parse(JSON.stringify(this._elevations))},getDistance:function(){return this._distance},getAltMin:function(){return this._altMin},getAltMax:function(){return this._altMax},getSlopeMin:function(){return this._slopeMin},getSlopeMax:function(){return this._slopeMax},getDenivPos:function(){return this._denivPos},getDenivNeg:function(){return this._denivNeg},computeStats:function(){var e=this;return $.Deferred(function(){var t=this;$.when.apply($,e._fetchAltitude().concat(e._fetchSlope())).fail(function(){t.reject()}).then(function(){var n=[];$.each(e.getLatLngs(),function(e,t){var a=$.extend({},{lat:t.lat,lng:t.lng},$.Cache.getInfos(t));n.push(a)}),0==n.length&&t.resolve(),e._distance=0,e._altMin=n[0].z,e._altMax=n[0].z,e._slopeMax=0,e._slopeMin=0,e._denivPos=0,e._denivNeg=0,n[0].dist=0,n[0].slopeOnTrack=0,e._elevations=[n[0]];for(var o=0,r=1;r<n.length;r++){var i=a(n[r],e._elevations[o]);if(i>10){if(o++,e._distance+=i/1e3,e._elevations[o]=n[r],e._elevations[o].dist=e._distance,e._elevations[o].slopeOnTrack=Math.degrees(Math.atan((Math.round(e._elevations[o].z)-Math.round(e._elevations[o-1].z))/i)),o>5){var l=(e._elevations[o-5].slopeOnTrack+e._elevations[o-4].slopeOnTrack+e._elevations[o-3].slopeOnTrack+e._elevations[o-2].slopeOnTrack+e._elevations[o-1].slopeOnTrack)/5;e._elevations[o].slopeOnTrack=(l+e._elevations[o].slopeOnTrack)/2}e._elevations[o].z<e._altMin&&(e._altMin=e._elevations[o].z),e._elevations[o].z>e._altMax&&(e._altMax=e._elevations[o].z),e._elevations[o].slopeOnTrack>e._slopeMax&&(e._slopeMax=e._elevations[o].slopeOnTrack),e._elevations[o].slopeOnTrack<e._slopeMin&&(e._slopeMin=e._elevations[o].slopeOnTrack),e._elevations[o].z<e._elevations[o-1].z?e._denivNeg+=Math.round(e._elevations[o-1].z-e._elevations[o].z):e._denivPos+=Math.round(e._elevations[o].z-e._elevations[o-1].z)}}t.resolve()})})},_fetchAltitude:function(){var e=[],t=[];return $.each(this.getLatLngs(),function(a,n){$.Cache.hasAltitude(n)||(e.push({lon:n.lng,lat:n.lat}),50==e.length&&(t.push(c(e)),e=[]))}),e.length>0&&t.push(c(e)),t},_fetchSlope:function(){var e={},t=[];return $.each(this.getLatLngs(),function(t,a){if(!$.Cache.hasSlope(a)){var n=i(a,C.options.crs,16,256,C.getPixelOrigin()),o=n.tile,r=n.tilePixel;o.x in e||(e[o.x]={}),o.y in e[o.x]||(e[o.x][o.y]=[[]]),e[o.x][o.y][e[o.x][o.y].length-1].length>50&&e[o.x][o.y].push([]),e[o.x][o.y][e[o.x][o.y].length-1].push({lat:a.lat,lng:a.lng,x:r.x,y:r.y})}}),$.each(e,function(e,a){$.each(a,function(a,n){$.each(n,function(n,o){t.push(u(e,a,o))})})}),t}}),L.GeoJSON.include({getLatLngs:function(){var e=[];return this.eachLayer(function(t){$.each(t.feature.geometry.coordinates,function(t,a){e.push(L.latLng(a[1],a[0]))})}),e}});var m={red:"#D63E2A",orange:"#F59630",green:"#72B026",blue:"#38AADD",purple:"#D252B9",darkred:"#A23336",darkblue:"#0067A3",darkgreen:"#728224",darkpurple:"#5B396B",cadetblue:"#436978",lightred:"#FF8E7F",beige:"#FFCB92",lightgreen:"#BBF970",lightblue:"#8ADAFF",pink:"#FF91EA",white:"#FBFBFB",lightgray:"#A3A3A3",gray:"#575757",black:"#303030"},f=["blue","green","orange","purple","red","darkblue","darkpurple","lightblue","lightgreen","beige","pink","lightred"],v=0;L.Marker.include({__type:"waypoint",__color:v,getColorCode:function(){return f[this.__color]},getColorRgb:function(){return m[f[this.__color]]},getColorIndex:function(){return this.__color},setColorIndex:function(e){this.__color=e},getType:function(){return this.__type},setType:function(e){this.__type=e,"waypoint"==e?this.setIcon(L.AwesomeMarkers.icon({icon:"circle",markerColor:this.getColorCode(),prefix:"fa"})):this.setIcon(L.AwesomeMarkers.icon({icon:"asterisk",markerColor:this.getColorCode(),prefix:"fa"}))}}),L.Control.EasyButton.include({setEnabled:function(e){t(this,e)}}),isSmallScreen&&$("#mobile-warning").show().find("button").click(function(){popup.hide()});var C=L.map("map",{}).setView([p[0],p[1]],p[2]);$("body").on("map2gpx:modechange",function(e){t(C.doubleClickZoom,null===e.mode)});var M=L.geoportalLayer.WMTS({layer:"ORTHOIMAGERY.ORTHOPHOTOS",apiKey:keyIgn}).addTo(C),y=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.SLOPES.MOUNTAIN",apiKey:keyIgn},{opacity:.25}).addTo(C),S=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn},{opacity:.25}).addTo(C);if(L.geoportalControl.SearchEngine({displayAdvancedSearch:!1}).addTo(C),!isSmallScreen){var b=L.geoportalLayer.WMTS({layer:"GEOGRAPHICALGRIDSYSTEMS.MAPS",apiKey:keyIgn});new L.Control.MiniMap(b,{position:"bottomleft",zoomLevelOffset:-4}).addTo(C)}var x=L.geoportalControl.LayerSwitcher({collapsed:isSmallScreen});C.addControl(x),x.setVisibility(y,!1),$(".GPlayerRemove").remove(),isSmallScreen||C.addControl(L.control.scale({imperial:!1,position:"bottomright"}));var k=L.easyButton({id:"btn-autotrace",states:[{stateName:"loaded",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(e,t){$.State.setMode("auto")}},{stateName:"active",icon:"fa-map-signs",title:"Tracer automatiquement l'itinéraire",onClick:function(e,t){$.State.setMode(null)}}]});$("body").on("map2gpx:modechange map2gpx:markerschange",function(e){"auto"==e.mode?(k.state("active"),k.enable()):(k.state("loaded"),k.setEnabled(!$.Cache.hasRoutes()||"import"!=$.Cache.getRouteMode(0)))});var w=L.easyButton({id:"btn-straighttrace",states:[{stateName:"loaded",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(e,t){$.State.setMode("straight")}},{stateName:"active",icon:"fa-location-arrow",title:"Tracer l'itinéraire en ligne droite",onClick:function(e,t){$.State.setMode(null)}}]});$("body").on("map2gpx:modechange map2gpx:markerschange",function(e){"straight"==e.mode?(w.state("active"),w.enable()):(w.state("loaded"),w.setEnabled(!$.Cache.hasRoutes()||"import"!=$.Cache.getRouteMode(0)))});var A=L.easyButton({id:"btn-closeloop",states:[{stateName:"loaded",icon:"fa-magic",title:"Fermer la boucle",onClick:function(e,t){$.Cache.hasMarkers(1)&&s({latlng:$.Cache.getMarker(0).getLatLng()})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Fermer la boucle (calcul en cours...)"}]});$("body").on("map2gpx:modechange map2gpx:computingchange map2gpx:markerschange",function(e){e.computing?(A.state("computing"),A.disable()):(A.state("loaded"),A.setEnabled(null!==e.mode&&$.Cache.hasRoutes()&&"import"!=$.Cache.getRouteMode(0)))}),L.easyBar([k,w,A]).addTo(C);var _=L.popup().setContent(L.DomUtil.get("form-export")),I=L.easyButton({id:"btn-export",states:[{stateName:"loaded",icon:"fa-cloud-download",title:"Exporter",onClick:function(e,t){var a=L.latLngBounds($.Cache.getMarker(0).getLatLng(),$.Cache.getMarker(1).getLatLng());$.Cache.eachRoute(function(e,t){a.extend(t.getBounds())}),t.flyToBounds(a,{padding:[50,50]}),_.setLatLng($.Cache.getMarker(0).getLatLng()).openOn(t),$(".export-gpx-button:visible").click(function(){var e=$(this);e.attr("disabled","disabled"),$.when(d($(".export-filename:visible").val())).then(function(){e.removeAttr("disabled")})}),$(".export-kml-button:visible").click(function(){var e=$(this);e.attr("disabled","disabled"),$.when(g($(".export-filename:visible").val())).then(function(){e.removeAttr("disabled")})})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Exporter (calcul en cours...)"}]}).addTo(C);$("body").on("map2gpx:computingchange map2gpx:markerschange",function(e){e.computing?(I.state("computing"),I.disable()):(I.state("loaded"),I.setEnabled($.Cache.hasMarkers()))});var T=L.popup().setContent(L.DomUtil.get("form-import")),R=L.easyButton({id:"btn-import",states:[{stateName:"loaded",icon:"fa-cloud-upload",title:"Importer",onClick:function(t,a){T.setLatLng(a.getCenter()).openOn(a),$.Cache.hasRoutes()?$(".import-gpx-status:visible").html("<strong>Attention:</strong> l'import va effacer l'itinéraire existant!"):$(".import-gpx-status:visible").text(""),$(".import-gpx-button:visible").click(function(){var t=$(this),n=$(".import-gpx-file:visible")[0].files[0];if(void 0!=n){t.attr("disabled","disabled"),$.State.setComputing(!0),$(".import-gpx-status:visible").text("Importation en cours...");var o=new FileReader;o.onload=function(n){var o=[];new L.GPX(n.target.result,{async:!0,onFail:function(){console.log("Failed to retrieve track"),$(".import-gpx-status:visible").text("Imposible de traiter ce fichier"),t.removeAttr("disabled"),$.State.setComputing(!1)},onSuccess:function(n){$(".import-gpx-status:visible").text("Récupération des données géographiques en cours..."),$.Cache.eachRoute(function(e,t){a.removeLayer(t)}),$.Cache.resetRoutes(),$.Cache.eachMarker(function(e,t){a.removeLayer(t)}),$.Cache.resetMarkers();var r=function(){$(".track-delete-button:visible").click(function(){$.State.setComputing(!0),$.Cache.eachRoute(function(e,t){a.removeLayer(t)}),$.Cache.resetRoutes(),$.Cache.eachMarker(function(e,t){a.removeLayer(t)}),$.Cache.resetMarkers(),a.removeLayer(n),$.State.triggerMarkersChanged(),$.State.setComputing(!1)})};a.fitBounds(n.getBounds(),{padding:[50,50]}),T.setLatLng(n.getBounds().getCenter()),n.addTo(a);var i=[];$.each(o,function(t,n){if($.Cache.addRoute(n,"import"),0==t){var o=n.getLatLngs()[0],l=L.marker(o,{draggable:!1,opacity:.5});l.setColorIndex(v),l.setType("waypoint"),$.Cache.addMarker(l),l.addTo(a),l.bindPopup('<button class="track-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer l\'import</button>'),l.on("popupopen",r)}var s=n.getLatLngs()[n.getLatLngs().length-1],c=L.marker(s,{draggable:!1,opacity:.5});c.setColorIndex(e()),c.setType("step"),$.Cache.addMarker(c),c.addTo(a),n.setStyle({weight:5,color:$.Cache.getMarker(t).getColorRgb(),opacity:.5}),n.bindPopup("Calculs en cours..."),c.bindPopup('<button class="track-delete-button"><i class="fa fa-trash" aria-hidden="true"></i> Supprimer l\'import</button>'),c.on("popupopen",r),i.push(n.computeStats())}),$.when.apply($,i).done(function(){$.Cache.eachRoute(function(e,t){t.setStyle({opacity:.75})}),$.Cache.eachMarker(function(e,t){t.setOpacity(1)}),T.remove(),$.State.triggerMarkersChanged(),$.State.setMode(null),$.State.setComputing(!1)}).fail(function(){console.log("Fail"),$(".import-gpx-status:visible").text("Impossible de récupérer les données géographiques de ce parcours"),t.removeAttr("disabled"),$.State.setComputing(!1)})}}).on("addline",function(e){o.push(e.line)})},o.readAsText(n)}else $(".import-gpx-status:visible").text("Veuillez sélectionner un fichier")})}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Importer (calcul en cours...)"}]}),O=L.easyButton({id:"btn-reset",states:[{stateName:"loaded",icon:"fa-trash",title:"Effacer l'itinéraire",onClick:function(e,t){$.State.setComputing(!0),$.Cache.eachRoute(function(e,a){t.removeLayer(a)}),$.Cache.resetRoutes(),$.Cache.eachMarker(function(e,a){t.removeLayer(a)}),$.Cache.resetMarkers(),$.State.triggerMarkersChanged(),$.State.setComputing(!1)}},{stateName:"computing",icon:"fa-spinner fa-pulse",title:"Effacer l'itinéraire (calcul en cours...)"}]});if(L.easyBar([R,O]).addTo(C),$("body").on("map2gpx:computingchange",function(e){R.state(e.computing?"computing":"loaded"),O.state(e.computing?"computing":"loaded"),R.setEnabled(!e.computing),O.setEnabled(!e.computing)}),!isSmallScreen){var P=L.popup().setContent(L.DomUtil.get("about")),D=L.easyButton({position:"bottomright",states:[{icon:"fa-info-circle",onClick:function(e,t){P.setLatLng(t.getCenter()).openOn(t)},title:"A propos & crédits"}]}),E=L.easyButton({position:"bottomright",states:[{icon:"fa-question-circle",onClick:function(e,t){$.Shepherd.get(0).start(!0)},title:"Aide"}]});L.easyBar([D,E],{position:"bottomright"}).addTo(C)}C.on("dblclick",s);var N;C.on("zoomend",function(){console.log("Zoomed to ",C.getZoom()),hasLocalStorage&&localStorage.setItem("view",JSON.stringify([C.getCenter().lat,C.getCenter().lng,C.getZoom()]));var e=void 0,t=void 0;(M.options.minZoom>C.getZoom()||M.options.maxZoom<C.getZoom())&&C.hasLayer(M)?(e="Photographies aériennes",t=$(".GPlayerSwitcher_layer:eq(2)")):(S.options.minZoom>C.getZoom()||S.options.maxZoom<C.getZoom())&&C.hasLayer(S)?(e="Cartes IGN",t=$(".GPlayerSwitcher_layer:eq(0)")):(y.options.minZoom>C.getZoom()||y.options.maxZoom<C.getZoom())&&C.hasLayer(y)&&(e="Carte des pentes",t=$(".GPlayerSwitcher_layer:eq(1)")),void 0!==e&&void 0===N?((N=new Drop({target:t[0],classes:"drop-theme-arrows",position:"left middle",constrainToWindow:!1,constrainToScrollParent:!1,openOn:null,content:"La couche &quot;"+e+"&quot; n'est pas disponible à ce niveau de zoom"})).open(),$(N.content).on("click",function(){N.destroy(),N=null})):void 0===e&&void 0!==N&&null!==N&&(N.destroy(),N=null)}),C.on("moveend",function(){console.log("Moved to ",C.getCenter()),hasLocalStorage&&localStorage.setItem("view",JSON.stringify([C.getCenter().lat,C.getCenter().lng,C.getZoom()]))}),$("body").on("map2gpx:computingchange",function(e){e.computing?$("#data-computing").fadeIn():(h(),$("#data-computing").fadeOut())}),Math.roundE8=function(e){return Math.round(e*Math.pow(10,8))/Math.pow(10,8)},Math.radians=function(e){return e*Math.PI/180},Math.degrees=function(e){return 180*e/Math.PI};var B=null,G={icon:L.AwesomeMarkers.icon({icon:"area-chart",markerColor:"cadetblue",prefix:"fa"}),draggable:!1,clickable:!1,zIndexOffset:1e3};if(isSmallScreen)$("#chart").remove();else var z=new Chart($("#chart"),{type:"line",data:{datasets:[{label:"Altitude",data:[],fill:!1,borderColor:"rgba(12, 98, 173, 0.8)",backgroundColor:"rgba(12, 98, 173, 0.8)",lineTension:0,pointRadius:0,yAxisId:"alt"},{label:"Pente de l'itinéraire",data:[],fill:!0,pointRadius:0,yAxisID:"slope"},{label:"Pente du terrain",data:[],fill:!0,pointRadius:0,yAxisID:"slope2",hidden:!0}]},options:{maintainAspectRatio:!1,hover:{mode:"index",intersect:!1,onHover:function(e,t){if("mousemove"==e.type)if(t&&t.length>0){var a=t[0]._index,n=z.config.data.datasets[0].data[a];null==B?(B=L.marker(L.latLng(n.lat,n.lng),G)).addTo(C):(B.setLatLng(L.latLng(n.lat,n.lng)),B.update())}else B&&(C.removeLayer(B),B=null);else"mouseout"==e.type&&B&&(C.removeLayer(B),B=null)}},scales:{xAxes:[{id:"distance",type:"linear",position:"bottom",ticks:{min:0}}],yAxes:[{id:"alt",type:"linear",position:"left",beginAtZero:!1},{id:"slope",type:"linear",position:"right"},{id:"slope2",type:"linear",position:"right",ticks:{min:0,max:45}}]},legend:{position:"left"},tooltips:{mode:"index",intersect:!1,callbacks:{title:function(e,t){return"Distance: "+Math.floor(100*e[0].xLabel)/100+"km"},label:function(e,t){return t.datasets[e.datasetIndex].label+": "+(0==e.datasetIndex?Math.round(100*e.yLabel)/100+"m":Math.round(e.yLabel)+"°")}}},annotation:{annotations:[]}}});$.State.setMode(null),$.State.triggerMarkersChanged(),$.State.setComputing(!1),isSmallScreen||$.Shepherd.tour().add("welcome",{text:$("#help-welcome")[0]}).add("layers",{text:$("#help-layers")[0],attachTo:{element:$(".GPlayerName").closest(".GPwidget")[0],on:"left"}}).add("search",{text:$("#help-search")[0],attachTo:{element:$(".GPshowAdvancedToolOpen").closest(".GPwidget")[0],on:"right"}}).add("autotrace",{text:$("#help-autotrace")[0],attachTo:{element:$("#btn-autotrace")[0],on:"right"}}).add("straighttrace",{text:$("#help-straighttrace")[0],attachTo:{element:$("#btn-straighttrace")[0],on:"right"}}).start(),$("#loading").fadeOut()})};